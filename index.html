<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© (Golden)</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Lottie Player -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<style>
/* --- CORE VARIABLES (High Contrast & No-White-Elements Rule) --- */
:root{
    /* Light Mode */
    --bg:#FFFFFF; /* Only main background is White */
    --text:#0F172A;
    --muted:#475569;
    
    /* Elements are NOT white (Light Grays/Tints) */
    --card-bg: #F1F5F9; /* Slate-100 */
    --card-border: #CBD5E1;
    
    /* Inputs & Buttons */
    --input-bg: #E2E8F0; /* Slate-200 */
    --btn-default-bg: #D1D5DB; /* Gray-300 */
    --btn-default-text: #1F2937;
    --btn-hover: #9CA3AF;

    /* Brand Colors */
    --l1:#9A3412; --l1-light:#EA580C;
    --l2:#0369A1; --l2-light:#0EA5E9;
    --l3:#15803D; --l3-light:#22C55E;
    
    --accent:#F59E0B; --danger:#DC2626; --success:#16A34A;
    
    /* Shadows */
    --card-shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --hover-shadow:0 20px 25px -5px rgba(0,0,0,0.15), 0 10px 10px -5px rgba(0,0,0,0.04);
    
    --modal-overlay:rgba(15, 23, 42, 0.75);
    --offline-bg:rgba(241, 245, 249, 0.98);
}

:root.dark{
    /* Dark Mode */
    --bg:#020617; /* Almost Black */
    --text:#F8FAFC;
    --muted:#94A3B8;
    
    /* Elements */
    --card-bg: #1E293B; /* Slate-800 */
    --card-border: #334155;
    
    /* Inputs & Buttons */
    --input-bg: #0F172A; /* Slate-900 */
    --btn-default-bg: #334155;
    --btn-default-text: #F8FAFC;
    --btn-hover: #475569;

    /* Brand Colors Lighter */
    --l1:#FB923C; --l1-light:#FDBA74; 
    --l2:#38BDF8; --l2-light:#7DD3FC; 
    --l3:#4ADE80; --l3-light:#86EFAC; 
    
    --card-shadow:0 10px 15px -3px rgba(0, 0, 0, 0.7);
    --modal-overlay:rgba(0,0,0,0.9);
    --offline-bg:rgba(2, 6, 23, 0.98);
}

/* --- GLOBAL RESET --- */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Tajawal',sans-serif;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:50px;transition:background .3s,color .3s;overflow-x:hidden}
button,select,input,textarea{font-family:inherit}
button{cursor:pointer}
.hidden{display:none!important}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px) rotate(-5deg)} 75%{transform:translateX(5px) rotate(5deg)} }
@keyframes gradientBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@keyframes popIn { 0%{transform:scale(0.8);opacity:0} 100%{transform:scale(1);opacity:1} }

/* --- PRESENTATION MODE --- */
body.pres-active .topbar, body.pres-active .pres-btn-area { display: none !important; }
body.pres-active .container { 
    max-width: 100%; height: 100vh; margin: 0; padding: 0; 
    display: flex; align-items: center; justify-content: center; 
    background: #000;
}
body.pres-active #exit-pres-btn { display: flex; }
body.pres-mobile .admin-side, body.pres-tablet .client-side { display: none; }
body.pres-mobile .client-side, body.pres-tablet .admin-side { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
body.pres-mobile .frame.mobile { transform: scale(1.15); box-shadow: 0 0 0 20px #111, 0 30px 60px rgba(0,0,0,0.8); border-radius: 40px; border-width: 0; }
body.pres-tablet .frame.tablet { width: 95vw; height: 95vh; border-width: 0; border-radius: 20px; box-shadow: 0 0 0 20px #111, 0 30px 60px rgba(0,0,0,0.8); }

#exit-pres-btn {
    display: none; position: fixed; bottom: 30px; right: 30px; 
    background: var(--danger); color: #fff; border: none; 
    padding: 12px 25px; border-radius: 99px; z-index: 9999; 
    font-weight: bold; backdrop-filter: blur(10px);
    cursor: pointer; transition: 0.2s; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    align-items: center; gap: 8px;
}
#exit-pres-btn:hover { transform: scale(1.05); filter: brightness(1.1); }

.pres-btn-area { text-align: center; margin-top: 15px; }

/* --- LAYOUT --- */
.topbar{
    position:sticky;top:0;z-index:900;background:var(--card-bg);
    border-bottom:1px solid var(--card-border);
    padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    transition: background 0.3s, border-color 0.3s;
}

.container{max-width:1300px;margin:30px auto;padding:0 20px}
.level-container{display:none;animation:fadeIn .5s cubic-bezier(0.4, 0, 0.2, 1)}
.level-container.active{display:block}

.workspace{display:flex;gap:40px;align-items:flex-start;justify-content: center;}
.client-side{flex:0 0 380px;display:flex;flex-direction:column;align-items:center}
.admin-side{flex:1;min-width:0;display:flex;flex-direction:column}
@media(max-width:900px){.workspace{flex-direction:column;align-items:center}.client-side{width:100%}.admin-side{width:100%}}

/* Frames styling */
.frame{
    background:var(--bg); 
    border-radius:35px; box-shadow:var(--card-shadow);
    border:12px solid #1E293B; /* Device Bezel Color */
    overflow:hidden; display:flex; flex-direction:column;
    position:relative; transition: border-color 0.3s;
}
.frame.mobile{width:375px;height:750px;border-radius:45px;border-width:14px}
.frame.tablet{width:100%;min-height:700px;border-radius:25px;border-width:14px}

/* App Header & Body */
.app-header{
    padding:16px 20px;color:#fff;display:flex;align-items:center;justify-content:space-between;
    font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.2);flex-shrink:0;
    transition: background 0.5s; position: relative; z-index: 10; 
}
.app-body{
    flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px;
    background: var(--bg); /* Matches global bg, but inside frame */
    transition: background 0.3s;
}

/* Themes */
#level-1 .app-header { background: linear-gradient(135deg, var(--l1), var(--l1-light)); }
#level-2 .app-header { background: linear-gradient(135deg, var(--l2), var(--l2-light)); }
#level-3 .app-header { background: linear-gradient(135deg, var(--l3), var(--l3-light)); }
#level-3 .admin-side .app-body { 
    background: linear-gradient(-45deg, var(--bg), var(--card-bg), var(--bg));
    background-size: 400% 400%; animation: gradientBG 15s ease infinite;
}

/* --- COMPONENTS --- */
.card{
    background:var(--card-bg); padding:14px; border-radius:16px; 
    box-shadow:var(--card-shadow); position:relative;
    border: 1px solid var(--card-border);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.product-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: var(--hover-shadow); border-color: var(--l2); }
.product-card .p-img { width: 90px; height: 90px; border-radius: 12px; object-fit: cover; transition: transform 0.3s; border: 1px solid var(--card-border); }
.product-card:hover .p-img { transform: scale(1.05) rotate(2deg); }

.prod-badge {
    position: absolute; top: 10px; right: 10px;
    background: var(--accent); color: #fff; padding: 4px 10px;
    border-radius: 20px; font-size: 0.7rem; font-weight: 800;
    box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); z-index: 2;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.skeleton { background: var(--btn-default-bg); background-image: linear-gradient(90deg, var(--btn-default-bg) 0px, var(--card-bg) 40px, var(--btn-default-bg) 80px); background-size: 600px; animation: shimmer 1.6s infinite linear; border-radius: 8px; color: transparent !important; }

.app-nav{
    background:var(--card-bg);padding:12px 0;border-top:1px solid var(--card-border);
    display:flex;justify-content:space-around;align-items:center;flex-shrink:0;
    border-radius: 0 0 25px 25px; z-index: 10;
}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:0.75rem;color:var(--muted);gap:6px;cursor:pointer;position:relative;padding:6px 12px;transition:0.2s;border-radius:12px}
.nav-item:hover{background:var(--btn-default-bg)}
.nav-item i { font-size: 1.4rem; transition: transform 0.2s; }
.nav-item.active{color:var(--l2); font-weight:800; background:var(--btn-default-bg)}
.nav-item.active i { transform: translateY(-4px); }

/* --- BUTTONS & INPUTS (Solid Colors) --- */
.btn{
    border:1px solid var(--card-border); border-radius:12px; padding:10px 16px; font-weight:700; font-size:0.95rem;
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    transition:all 0.2s; cursor:pointer; position: relative; overflow: hidden;
    background-color: var(--btn-default-bg); color: var(--btn-default-text);
}
.btn:hover{background-color: var(--btn-hover); transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
.btn:active{transform:scale(0.96) translateY(0);}

.btn-outline { background: transparent; border: 2px solid currentColor; }
.btn-outline:hover { background: var(--btn-default-bg); color: var(--text); }

.lvl-btn{
    padding:8px 20px; border-radius:99px; border:1px solid var(--card-border); font-weight:700; font-size:0.9rem;
    background: var(--card-bg); color: var(--text); transition:all .3s;
}
.lvl-btn:hover{background: var(--btn-hover);}
.lvl-btn.active{color:#fff; border-color:transparent; box-shadow:0 4px 15px rgba(0,0,0,0.2); transform:translateY(-2px)}
.lvl-btn[data-lvl="1"].active{background:var(--l1)}
.lvl-btn[data-lvl="2"].active{background:var(--l2)}
.lvl-btn[data-lvl="3"].active{background:var(--l3)}

.toggle-btn{
    width:42px;height:42px;border-radius:12px;border:1px solid var(--card-border);
    background:var(--card-bg); color:var(--text);
    display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.toggle-btn:hover{background:var(--btn-hover);transform:scale(1.05)}

.input, .select, .textarea{
    width:100%;padding:12px;border-radius:12px;border:1px solid var(--card-border);
    background:var(--input-bg); color:var(--text); font-size:0.95rem;margin-bottom:10px;outline:none;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.input:focus { border-color: var(--l2); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); }

.chip{
    font-size:0.8rem;padding:6px 12px;border-radius:99px;
    background:var(--btn-default-bg); color:var(--text); font-weight: 600;
    display:inline-flex;align-items:center;gap:6px;cursor:pointer; transition: 0.2s; border: 1px solid var(--card-border);
}
.chip:hover { background: var(--btn-hover); }

/* --- MODALS & OVERLAYS --- */
.modal-overlay{
    position:absolute;inset:0;background:var(--modal-overlay);z-index:3000;
    display:none;align-items:center;justify-content:center;padding:20px;
    animation:fadeModal .3s ease; backdrop-filter: blur(5px);
}
.modal-overlay.open{display:flex}
.modal-content{
    background:var(--card-bg);width:100%;max-width:340px;border-radius:20px;padding:20px;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);max-height:90%;overflow-y:auto; color: var(--text);
    border: 1px solid var(--card-border);
}
.frame.mobile .modal-overlay { align-items: flex-end; padding: 0; }
.frame.mobile .modal-content {
    width: 100%; max-width: 100%; border-radius: 25px 25px 0 0;
    padding: 30px 20px; animation: slideUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    margin: 0; padding-bottom: 40px; border-bottom: none;
}

.offline-overlay {
    position: absolute; inset: 0; background: var(--offline-bg);
    backdrop-filter: blur(8px); z-index: 2000; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 30px; opacity: 0; pointer-events: none; transition: 0.4s;
    color: var(--text);
}
.offline-overlay.active { opacity: 1; pointer-events: all; }

/* --- BANNER (Top Center Fixed) --- */
#banner {
    position: fixed; top: 100px; left: 50%; transform: translateX(-50%) translateY(-150%);
    background: #1E293B; color: #fff; padding: 12px 24px; border-radius: 99px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4); z-index: 10000; font-weight: 700;
    opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex; align-items: center; gap: 12px; font-size: 0.95rem;
    width: max-content; max-width: 90%; border: 1px solid rgba(255,255,255,0.2);
}
#banner.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.dark #banner { background: #F8FAFC; color: #0F172A; border-color: #CBD5E1; }

/* --- EXTRAS --- */
.cart-shake { animation: shake 0.5s ease-in-out; }
.timeline{display:flex;align-items:center;justify-content:space-between;margin-top:15px;position:relative;padding:0 5px}
.timeline::before{content:'';position:absolute;top:50%;left:0;right:0;height:4px;background:var(--btn-default-bg);z-index:0;border-radius:10px}
.tl-step{width:36px;height:36px;border-radius:50%;background:var(--card-bg);border:3px solid var(--btn-default-bg);z-index:1;display:flex;align-items:center;justify-content:center;font-size:0.9rem;color:var(--muted);transition:all .4s}
.tl-step.done{background:var(--success);border-color:var(--success);color:#fff;transform:scale(1.15)}
</style>
</head>
<body>

<!-- Exit Presentation Button -->
<button id="exit-pres-btn" onclick="togglePresentation()">âŒ Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶</button>

<!-- Floating Banner -->
<div id="banner"><i class="fas fa-info-circle"></i> <span id="banner-msg"></span></div>

<!-- Success Animation -->
<div id="success-anim-container" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:5000;display:none;align-items:center;justify-content:center;flex-direction:column">
    <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_u4yrau.json" background="transparent" speed="1" style="width:300px;height:300px" loop="false" autoplay></lottie-player>
    <div style="color:#fff;font-size:1.8rem;font-weight:bold;margin-top:-20px">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!</div>
</div>

<!-- Topbar -->
<header class="topbar">
    <div style="display:flex;gap:10px">
        <button class="toggle-btn" onclick="toggleTheme()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ“</button>
        <button class="toggle-btn" onclick="toggleSound()" title="Ø§Ù„ØµÙˆØª">ğŸ””</button>
    </div>
    <div class="level-tabs">
        <button class="lvl-btn active" data-lvl="1" onclick="switchLevel(1)">Ù…Ø³ØªÙˆÙ‰ 1</button>
        <button class="lvl-btn" data-lvl="2" onclick="switchLevel(2)">Ù…Ø³ØªÙˆÙ‰ 2</button>
        <button class="lvl-btn" data-lvl="3" onclick="switchLevel(3)">Ù…Ø³ØªÙˆÙ‰ 3</button>
    </div>
</header>

<!-- Main Container -->
<div class="container">

    <!-- LEVEL 1 -->
    <div id="level-1" class="level-container active">
        <div class="workspace">
            <div class="client-side">
                <div class="frame mobile">
                    <div class="app-header bg-l1">
                        <span>Ø­Ù„ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©</span>
                        <span id="store-badge-1" class="chip" style="background:rgba(255,255,255,0.9);color:var(--l1);font-weight:800">Ù…ÙØªÙˆØ­</span>
                    </div>
                    <div class="app-body" id="body-1"></div>
                    <div class="app-nav">
                        <div class="nav-item active" onclick="nav(1, 'menu')"><i class="fas fa-utensils"></i>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
                        <div class="nav-item" onclick="nav(1, 'cart')"><i class="fas fa-shopping-basket" id="cart-icon-1"></i>Ø§Ù„Ø³Ù„Ø© <span id="badge-cart-1" class="badge hidden">0</span></div>
                    </div>
                    <div id="offline-1" class="offline-overlay"><i class="fas fa-store-slash closed-icon"></i><h3>Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚</h3><p class="muted">Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ Ù†Ø³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>
                    <div id="modal-product-1" class="modal-overlay">
                        <div class="modal-content">
                            <img id="mp-img-1" src="" style="width:100%;height:180px;object-fit:cover;border-radius:16px;margin-bottom:15px;background:#eee">
                            <h3 id="mp-name-1" class="mb-2" style="font-size:1.4rem"></h3>
                            <select id="mp-weight-1" class="select" onchange="updateModalPrice(1)"><option value="0.25">Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ</option><option value="0.5">Â½ ÙƒØ¬Ù…</option><option value="1">1 ÙƒØ¬Ù…</option></select>
                            <div class="flex-between mb-4"><span class="bold">Ø§Ù„Ø³Ø¹Ø±:</span><strong id="mp-price-1" class="text-l1" style="font-size:1.4rem">0 Ø¬.Ù…</strong></div>
                            <button class="btn btn-block bg-l1" style="color:#fff;padding:14px" onclick="addToCartFromModal(1)">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
                            <button class="btn btn-block btn-outline mt-2" onclick="closeModal(1, 'product')">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l1" onclick="togglePresentation('mobile')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
            </div>
            <div class="admin-side">
                <div class="frame tablet">
                    <div class="app-header bg-l1"><span>KDS (Ø§Ù„Ù…Ø·Ø¨Ø®) - Ù…Ø³ØªÙˆÙ‰ 1</span><button id="store-toggle-1" class="btn btn-sm btn-outline" style="color:#fff;border-color:#fff" onclick="toggleStore(1)">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ù„</button></div>
                    <div class="app-body" style="flex-direction:row;gap:20px;background:var(--card-bg)">
                        <div style="flex:2;overflow-y:auto;padding-right:10px"><h4 class="mb-4 text-l1">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4><div id="orders-list-1" style="display:flex;flex-direction:column;gap:10px"></div></div>
                        <div style="flex:1;border-right:1px solid var(--btn-default-bg);padding-right:16px;overflow-y:auto"><h4 class="mb-4 text-l1">Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h4><div id="menu-list-1" style="display:flex;flex-direction:column;gap:8px"></div></div>
                    </div>
                    <div id="modal-invoice-1" class="modal-overlay"><div class="modal-content" style="max-width:400px"><div id="invoice-content-1"></div><button class="btn btn-block bg-l1" style="color:#fff" onclick="closeModal(1, 'invoice')">Ø·Ø¨Ø§Ø¹Ø© / Ø¥ØºÙ„Ø§Ù‚</button></div></div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l1" onclick="togglePresentation('tablet')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„</button></div>
            </div>
        </div>
    </div>

    <!-- LEVEL 2 -->
    <div id="level-2" class="level-container">
        <div class="workspace">
            <div class="client-side">
                <div class="frame mobile">
                    <div class="app-header bg-l2"><span id="header-user-2">Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø²Ø§Ø¦Ø±</span><button id="login-btn-2" class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:#fff" onclick="openLogin(2)">Ø¯Ø®ÙˆÙ„</button></div>
                    <div class="app-body" id="body-2"></div>
                    <div class="app-nav">
                        <div class="nav-item active" onclick="nav(2, 'home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                        <div class="nav-item" onclick="nav(2, 'cart')"><i class="fas fa-shopping-basket" id="cart-icon-2"></i><span id="badge-cart-2" class="badge hidden">0</span></div>
                        <div class="nav-item" onclick="nav(2, 'track')"><i class="fas fa-box-open"></i></div>
                        <div class="nav-item" onclick="nav(2, 'fav')"><i class="fas fa-heart"></i></div>
                        <div class="nav-item" onclick="nav(2, 'notif')"><i class="fas fa-bell"></i><span id="badge-notif-2" class="badge hidden">0</span></div>
                    </div>
                    <div id="offline-2" class="offline-overlay"><i class="fas fa-store-slash closed-icon"></i><h3>Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚</h3><p class="muted">Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ Ù†Ø³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>
                    <div id="modal-product-2" class="modal-overlay"><div class="modal-content"><img id="mp-img-2" src="" style="width:100%;height:180px;object-fit:cover;border-radius:16px;margin-bottom:15px;background:#eee"><h3 id="mp-name-2" class="mb-2" style="font-size:1.4rem"></h3><select id="mp-weight-2" class="select" onchange="updateModalPrice(2)"><option value="0.25">Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ</option><option value="0.5">Ù†ØµÙ ÙƒÙŠÙ„Ùˆ</option><option value="1">ÙƒÙŠÙ„Ùˆ</option></select><div class="flex-between mb-4"><span class="bold">Ø§Ù„Ø³Ø¹Ø±:</span><strong id="mp-price-2" class="text-l2" style="font-size:1.4rem">0 Ø¬.Ù…</strong></div><button class="btn btn-block bg-l2" style="color:#fff;padding:14px" onclick="addToCartFromModal(2)">Ø¥Ø¶Ø§ÙØ©</button><button class="btn btn-block btn-outline mt-2" onclick="closeModal(2, 'product')">Ø¥ØºÙ„Ø§Ù‚</button></div></div>
                    <div id="modal-login-2" class="modal-overlay"><div class="modal-content"><h3 class="center mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3><input id="login-name-2" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…"><input id="login-phone-2" class="input" placeholder="Ø§Ù„Ø¬ÙˆØ§Ù„"><button class="btn btn-block bg-l2 mb-2" style="color:#fff" onclick="sendOtp(2)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</button><div id="otp-area-2" class="hidden"><input id="otp-code-2" class="input" placeholder="Ø§Ù„Ø±Ù…Ø² (1234)"><button class="btn btn-block bg-l2" style="color:#fff" onclick="verifyOtp(2)">ØªØ£ÙƒÙŠØ¯</button></div><button class="btn btn-block btn-outline mt-2" onclick="closeModal(2, 'login')">Ø¥Ù„ØºØ§Ø¡</button></div></div>
                    <div id="modal-address-2" class="modal-overlay"><div class="modal-content"><h3 class="center mb-4">Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</h3><input id="new-addr-2" class="input" placeholder="Ø§Ù„Ù…Ù†Ø²Ù„ - Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ..."><button class="btn btn-block bg-l2" style="color:#fff" onclick="saveAddress(2)">Ø­ÙØ¸</button><button class="btn btn-block btn-outline mt-2" onclick="closeModal(2, 'address')">Ø¥Ù„ØºØ§Ø¡</button></div></div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l2" onclick="togglePresentation('mobile')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
            </div>
            <div class="admin-side">
                <div class="frame tablet">
                    <div class="app-header bg-l2"><span>ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ops Room)</span><button id="store-toggle-2" class="btn btn-sm btn-outline" style="color:#fff;border-color:#fff" onclick="toggleStore(2)">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ù„</button></div>
                    <div class="app-body" style="flex-direction:row;gap:20px;background:var(--card-bg)">
                        <div style="flex:1.8;overflow-y:auto;padding-right:10px"><h4 class="mb-4 text-l2">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4><div id="orders-list-2" style="display:flex;flex-direction:column;gap:10px"></div></div>
                        <div style="flex:1.2;border-right:1px solid var(--btn-default-bg);padding-right:16px;display:flex;flex-direction:column"><div class="admin-tabs"><div class="admin-tab active" onclick="setAdminTab(2, 'menu', this)">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div><div class="admin-tab" onclick="setAdminTab(2, 'customers', this)">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)</div></div><div id="admin-panel-2" style="flex:1;overflow-y:auto"></div></div>
                    </div>
                    <div id="modal-invoice-2" class="modal-overlay"><div class="modal-content" style="max-width:400px"><h3 class="center mb-2">ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨</h3><div id="invoice-content-2" style="border:1px dashed var(--muted);padding:10px;margin-bottom:10px;font-family:monospace;font-size:0.9rem"></div><button class="btn btn-block bg-l2" style="color:#fff" onclick="closeModal(2, 'invoice')">Ø·Ø¨Ø§Ø¹Ø©</button></div></div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l2" onclick="togglePresentation('tablet')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„</button></div>
            </div>
        </div>
    </div>

    <!-- LEVEL 3 -->
    <div id="level-3" class="level-container">
        <div class="workspace">
            <div class="client-side">
                <div class="frame mobile">
                    <div class="app-header bg-l3"><span id="header-user-3">Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø²Ø§Ø¦Ø±</span><div class="flex-center gap-1"><button id="login-btn-3" class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:#fff" onclick="openLogin(3)">Ø¯Ø®ÙˆÙ„</button></div></div>
                    <div class="app-body" id="body-3"></div>
                    <div class="app-nav">
                        <div class="nav-item active" onclick="nav(3, 'home')"><i class="fas fa-store"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                        <div class="nav-item" onclick="nav(3, 'cart')"><i class="fas fa-shopping-basket" id="cart-icon-3"></i><span id="badge-cart-3" class="badge hidden">0</span></div>
                        <div class="nav-item" onclick="nav(3, 'track')"><i class="fas fa-receipt"></i></div>
                        <div class="nav-item" onclick="nav(3, 'fav')"><i class="fas fa-heart"></i></div>
                        <div class="nav-item" onclick="nav(3, 'notif')"><i class="fas fa-bell"></i><span id="badge-notif-3" class="badge hidden">0</span></div>
                    </div>
                    <div id="offline-3" class="offline-overlay"><i class="fas fa-store-slash closed-icon"></i><h3>Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚</h3><p class="muted">Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ Ù†Ø³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>
                    <div id="modal-product-3" class="modal-overlay"><div class="modal-content"><img id="mp-img-3" src="" style="width:100%;height:180px;object-fit:cover;border-radius:16px;margin-bottom:15px;background:#eee"><h3 id="mp-name-3" class="mb-2" style="font-size:1.4rem"></h3><select id="mp-weight-3" class="select" onchange="updateModalPrice(3)"><option value="0.25">Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ</option><option value="0.5">Ù†ØµÙ ÙƒÙŠÙ„Ùˆ</option><option value="1">ÙƒÙŠÙ„Ùˆ</option></select><div class="flex-between mb-4"><span class="bold">Ø§Ù„Ø³Ø¹Ø±:</span><strong id="mp-price-3" class="text-l3" style="font-size:1.4rem">0 Ø¬.Ù…</strong></div><button class="btn btn-block bg-l3" style="color:#fff;padding:14px" onclick="addToCartFromModal(3)">Ø¥Ø¶Ø§ÙØ©</button><button class="btn btn-block btn-outline mt-2" onclick="closeModal(3, 'product')">Ø¥ØºÙ„Ø§Ù‚</button></div></div>
                    <div id="modal-login-3" class="modal-overlay"><div class="modal-content"><h3 class="center mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3><input id="login-name-3" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…"><input id="login-phone-3" class="input" placeholder="Ø§Ù„Ø¬ÙˆØ§Ù„"><button class="btn btn-block bg-l3 mb-2" style="color:#fff" onclick="sendOtp(3)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</button><div id="otp-area-3" class="hidden"><input id="otp-code-3" class="input" placeholder="Ø§Ù„Ø±Ù…Ø² (1234)"><button class="btn btn-block bg-l3" style="color:#fff" onclick="verifyOtp(3)">ØªØ£ÙƒÙŠØ¯</button></div><button class="btn btn-block btn-outline mt-2" onclick="closeModal(3, 'login')">Ø¥Ù„ØºØ§Ø¡</button></div></div>
                    <div id="modal-address-3" class="modal-overlay"><div class="modal-content"><h3 class="center mb-4">Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</h3><input id="new-addr-3" class="input" placeholder="Ø§Ù„Ù…Ù†Ø²Ù„ - Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ..."><button class="btn btn-block bg-l3" style="color:#fff" onclick="saveAddress(3)">Ø­ÙØ¸</button><button class="btn btn-block btn-outline mt-2" onclick="closeModal(3, 'address')">Ø¥Ù„ØºØ§Ø¡</button></div></div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l3" onclick="togglePresentation('mobile')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
            </div>
            <div class="admin-side">
                <div class="frame tablet">
                    <div class="app-header bg-l3"><span>Dashboard & Analytics</span><button id="store-toggle-3" class="btn btn-sm btn-outline" style="color:#fff;border-color:#fff" onclick="toggleStore(3)">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ù„</button></div>
                    <div class="app-body" style="flex-direction:row;gap:20px;background:var(--card-bg)">
                        <div style="flex:1.5;overflow-y:auto;padding-right:10px"><h4 class="mb-4 text-l3">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ©</h4><div id="orders-list-3" style="display:flex;flex-direction:column;gap:12px"></div></div>
                        <div style="flex:1.5;border-right:1px solid var(--btn-default-bg);padding-right:16px;display:flex;flex-direction:column">
                            <div class="admin-tabs"><div class="admin-tab active" onclick="setAdminTab(3, 'analytics', this)">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ğŸ“Š</div><div class="admin-tab" onclick="setAdminTab(3, 'customers', this)">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div><div class="admin-tab" onclick="setAdminTab(3, 'menu', this)">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div></div>
                            <div id="admin-panel-3" style="flex:1;overflow-y:auto"></div>
                        </div>
                    </div>
                    <div id="modal-invoice-3" class="modal-overlay"><div class="modal-content"><div id="invoice-content-3"></div><button class="btn btn-block bg-l3 mt-2" style="color:#fff" onclick="closeModal(3, 'invoice')">Ø·Ø¨Ø§Ø¹Ø©</button></div></div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l3" onclick="togglePresentation('tablet')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„</button></div>
            </div>
        </div>
    </div>
</div>

<script>
/* --- 1. BASE DATA --- */
const baseProducts = [
    {id:1, name:'Ø·Ø¨Ù‚ Ø´Ø±Ù‚ÙŠ Ù…Ø´ÙƒÙ„', price:120, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Mix+Sweets', badge:'Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹'},
    {id:2, name:'ÙƒÙ†Ø§ÙØ© Ù†Ø§Ø¨Ù„Ø³ÙŠØ©', price:90, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Kunafa'},
    {id:3, name:'ØªÙˆØ±ØªØ© Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price:220, img:'https://placehold.co/400x300/F8FAFC/334155?text=Choco+Cake'},
    {id:4, name:'Ø¨Ø³Ø¨ÙˆØ³Ø© Ø¨Ø§Ù„Ù‚Ø´Ø·Ø©', price:80, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Basbousa'},
    {id:5, name:'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù†', price:35, img:'https://placehold.co/400x300/F8FAFC/0F172A?text=Rice+Milk'},
    {id:6, name:'Ø²Ù„Ø§Ø¨ÙŠØ©', price:40, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Zalabia'},
    {id:7, name:'Ø£Ù… Ø¹Ù„ÙŠ', price:50, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Om+Ali'},
    {id:8, name:'Ø¨Ù„Ø­ Ø§Ù„Ø´Ø§Ù…', price:60, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Balah+Elsham'},
    {id:9, name:'ØªØ´ÙŠØ² ÙƒÙŠÙƒ ÙØ±Ø§ÙˆÙ„Ø©', price:75, img:'https://placehold.co/400x300/F8FAFC/EF4444?text=Cheesecake', badge:'Ø¬Ø¯ÙŠØ¯'},
    {id:10, name:'Ø¬Ø§ØªÙˆÙ‡ Ø³ÙˆØ§Ø±ÙŠÙ‡', price:150, img:'https://placehold.co/400x300/F8FAFC/334155?text=Gateau'},
    {id:11, name:'ÙƒØ¨ ÙƒÙŠÙƒ ÙØ§Ù†ÙŠÙ„ÙŠØ§', price:30, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Cupcake'},
    {id:12, name:'Ù…ÙˆÙ„ØªÙ† ÙƒÙŠÙƒ', price:65, img:'https://placehold.co/400x300/F8FAFC/334155?text=Molten+Cake'},
    {id:13, name:'ÙˆØ§ÙÙ„ Ù†ÙˆØªÙŠÙ„Ø§', price:55, img:'https://placehold.co/400x300/F8FAFC/334155?text=Waffle'},
    {id:14, name:'Ø¨Ø§Ù† ÙƒÙŠÙƒ Ø¹Ø³Ù„', price:45, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Pancake'},
    {id:15, name:'Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ… ÙØ³ØªÙ‚', price:40, img:'https://placehold.co/400x300/F8FAFC/15803D?text=Ice+Cream'},
    {id:16, name:'Ø¨Ù‚Ù„Ø§ÙˆØ©', price:110, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Baklava'},
    {id:17, name:'Ù‡Ø±ÙŠØ³Ø© Ø³Ø§Ø¯Ø©', price:70, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Harissa'},
    {id:18, name:'ÙƒÙˆÙƒÙŠØ² Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price:25, img:'https://placehold.co/400x300/F8FAFC/334155?text=Cookies'},
    {id:19, name:'Ø¹ØµÙŠØ± Ù…Ø§Ù†Ø¬Ùˆ', price:35, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Mango'},
    {id:20, name:'Ù‚Ù‡ÙˆØ© ØªØ±ÙƒÙŠ', price:20, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Coffee'}
];

const l3Offers = [
    {id:1, title:'Ø®ØµÙ… 10 Ø¬.Ù…', pts:20, type:'discount', val:10}, {id:2, title:'Ø®ØµÙ… 20 Ø¬.Ù…', pts:40, type:'discount', val:20}, 
    {id:3, title:'ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ', pts:50, type:'discount', val:30}, {id:4, title:'Ù‚Ù‡ÙˆØ© Ù…Ø¬Ø§Ù†Ø§Ù‹', pts:30, type:'item', val:20}, 
    {id:5, title:'ÙƒØ¨ ÙƒÙŠÙƒ Ù‡Ø¯ÙŠØ©', pts:60, type:'item', val:11}, {id:6, title:'Ø®ØµÙ… 10%', pts:100, type:'discount', val:50}, 
    {id:7, title:'Ø·Ø¨Ù‚ Ø£Ù… Ø¹Ù„ÙŠ', pts:120, type:'item', val:7}, {id:8, title:'Ù†ØµÙ ÙƒÙŠÙ„Ùˆ Ù…Ø´ÙƒÙ„', pts:300, type:'item', val:1}, 
    {id:9, title:'ØªÙˆØ±ØªØ© Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯', pts:800, type:'item', val:3}, {id:10, title:'Ø¨ÙˆÙƒØ³ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', pts:500, type:'item', val:16}
];

const dummyCustomers = [
    {name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', phone: '01012345678', orders: 12, total: 3500}, {name: 'Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ', phone: '01198765432', orders: 5, total: 850},
    {name: 'Ù…Ø­Ù…ÙˆØ¯ Ø­Ø³Ù†', phone: '01234567890', orders: 23, total: 6200}, {name: 'Ù†ÙˆØ± Ø§Ù„Ø¯ÙŠÙ†', phone: '01555555555', orders: 2, total: 150}
];

const getFreshMenu = () => JSON.parse(JSON.stringify(baseProducts.map(p=>({...p, active:true}))));

const db = {
    1: { menu: getFreshMenu(), cart: [], orders: [], storeOpen: true },
    2: { menu: getFreshMenu(), cart: [], orders: [], user: null, addresses: ['Ø§Ù„Ù…Ù†Ø²Ù„ (Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ)', 'Ø§Ù„Ø¹Ù…Ù„ (Ø§Ù„ØªØ¬Ù…Ø¹)'], fav: [], notif: [], storeOpen: true, currentView: 'home', adminView: 'menu', customers: JSON.parse(JSON.stringify(dummyCustomers)) },
    3: { menu: getFreshMenu(), cart: [], orders: [], user: null, addresses: ['Ø§Ù„Ù…Ù†Ø²Ù„ (Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ)'], fav: [], notif: [], storeOpen: true, points: 50, sales: 0, promo: null, currentView: 'home', adminView: 'analytics', customers: JSON.parse(JSON.stringify(dummyCustomers)), activeDiscount: null }
};

let soundEnabled = true;
let activeModalData = null;
let activeLevel = 1;

/* --- 2. INIT --- */
function init() {
    renderLevel(1);
}

/* --- 3. CORE & AUDIO --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (!soundEnabled) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;

    switch (type) {
        case 'success':
            osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
            break;
        case 'error':
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
            break;
        case 'click':
            osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
            osc.start(now); osc.stop(now + 0.05);
            break;
        case 'pop':
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
            break;
        case 'notify':
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.setValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.2, now + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
            break;
    }
}

function toggleTheme() { document.documentElement.classList.toggle('dark'); }
function toggleSound() { soundEnabled = !soundEnabled; showBanner(soundEnabled?'ğŸ”” Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„':'ğŸ”• Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØ§Ù…Øª'); }
function togglePresentation(type) { 
    playSound('click');
    if (!type) {
        document.body.classList.remove('pres-active', 'pres-mobile', 'pres-tablet');
        showBanner('âŒ ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶');
    } else {
        document.body.classList.remove('pres-active', 'pres-mobile', 'pres-tablet');
        document.body.classList.add('pres-active');
        document.body.classList.add(type === 'mobile' ? 'pres-mobile' : 'pres-tablet');
        showBanner(type === 'mobile' ? 'ğŸ“± Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚' : 'ğŸª Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„');
    }
}
function showBanner(msg) {
    const b = document.getElementById('banner');
    document.getElementById('banner-msg').textContent = msg;
    b.classList.add('show');
    setTimeout(()=>b.classList.remove('show'), 3000);
}

/* --- 4. NAVIGATION --- */
function switchLevel(lvl) {
    playSound('click');
    activeLevel = lvl;
    document.querySelectorAll('.level-container').forEach(el => el.classList.remove('active'));
    document.getElementById(`level-${lvl}`).classList.add('active');
    document.querySelectorAll('.lvl-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.lvl-btn[data-lvl="${lvl}"]`).classList.add('active');
    renderLevel(lvl);
    showBanner(`ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${lvl}`);
}
function nav(lvl, view) {
    playSound('click');
    if(lvl === 1) {
        if(view === 'menu') renderClientL1(db[1]);
        if(view === 'cart') renderCartL1();
        document.querySelectorAll('#level-1 .nav-item').forEach(el => el.classList.remove('active'));
        if(view === 'menu') document.querySelectorAll('#level-1 .nav-item')[0].classList.add('active');
        if(view === 'cart') document.querySelectorAll('#level-1 .nav-item')[1].classList.add('active');
    } else {
        db[lvl].currentView = view;
        renderClientApp(lvl);
        const icons = document.querySelectorAll(`#level-${lvl} .nav-item`);
        icons.forEach(el => el.classList.remove('active'));
        const map = {'home':0, 'cart':1, 'track':2, 'fav':3, 'notif':4};
        if(map[view] !== undefined) icons[map[view]].classList.add('active');
    }
}
function setAdminTab(lvl, tab, btn) {
    playSound('click');
    db[lvl].adminView = tab;
    const parent = btn.parentElement;
    Array.from(parent.children).forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderAdminPanel(lvl);
}

/* --- 5. RENDER LOGIC --- */
function renderLevel(lvl) {
    if(lvl === 1) { renderClientL1(db[1]); renderAdminL1(); }
    else { renderClientApp(lvl); renderAdminApp(lvl); }
    updateCounts(lvl);
    document.getElementById(`offline-${lvl}`).classList.toggle('active', !db[lvl].storeOpen);
}

// Level 1 Specific
function renderClientL1(d) {
    document.getElementById('body-1').innerHTML = d.menu.filter(p=>p.active).map(p => `
        <div class="card product-card mb-2">
            <img src="${p.img}" class="p-img" onclick="openProductModal(1, ${p.id})">
            <div class="p-info">
                <div class="p-title">${p.name}</div>
                <div class="p-desc">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ: ${p.price} Ø¬.Ù…</div>
                <div class="flex-between mt-2">
                    <select id="w-1-${p.id}" class="select" style="width:auto;padding:4px;margin:0;font-size:0.8rem"><option value="0.25">Â¼ ÙƒØ¬Ù…</option><option value="0.5">Â½ ÙƒØ¬Ù…</option><option value="1">1 ÙƒØ¬Ù…</option></select>
                    <button class="btn btn-sm bg-l1" style="color:#fff" onclick="quickAdd(1, ${p.id})">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
        </div>
    `).join('');
}
function renderCartL1() {
    const d = db[1];
    const total = d.cart.reduce((s,i)=>s+i.finalPrice,0);
    const html = d.cart.length===0 ? '<p class="muted center">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>' : d.cart.map((item,i) => `
        <div class="card mb-2 flex-between">
            <div><div class="bold">${item.name}</div><div class="small muted">${item.weightLabel}</div></div>
            <div><div class="bold text-l1">${item.finalPrice} Ø¬.Ù…</div><button class="btn btn-sm text-danger" onclick="removeFromCart(1, ${i})"><i class="fas fa-trash"></i></button></div>
        </div>
    `).join('');
    const form = d.cart.length>0 ? `
        <div class="card mt-4"><h4 class="mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
        <input id="guest-name-1" class="input" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø·Ù„ÙˆØ¨)">
        <input id="guest-phone-1" class="input" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
        <input id="guest-addr-1" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <textarea id="note-1" class="textarea" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
        <div class="flex-between mb-2 mt-2"><span class="bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><strong class="text-l1">${total} Ø¬.Ù…</strong></div>
        <button class="btn btn-block bg-l1" style="color:#fff" onclick="submitOrder(1)">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button></div>` : '';
    document.getElementById('body-1').innerHTML = `<h3 class="mb-4">Ø§Ù„Ø³Ù„Ø© (${d.cart.length})</h3>` + html + form;
}
function renderAdminL1() {
    const d = db[1];
    document.getElementById('orders-list-1').innerHTML = d.orders.map(o => `
        <div class="card mb-2" style="border-right:4px solid var(--l1)">
            <div class="flex-between mb-1"><span class="bold">#${o.id}</span><span class="small muted">${o.time}</span></div>
            <div class="small mb-1">${o.client} (${o.items.length} ØµÙ†Ù)</div>
            <div class="timeline">
                <div class="tl-step done"><i class="fas fa-file-invoice"></i></div>
                <div class="tl-step ${['prep','deliv','done'].includes(o.status)?'done':''}"><i class="fas fa-fire-burner"></i></div>
                <div class="tl-step ${['deliv','done'].includes(o.status)?'done':''}"><i class="fas fa-motorcycle"></i></div>
                <div class="tl-step ${o.status==='done'?'done':''}"><i class="fas fa-check"></i></div>
            </div>
            <div class="flex-between mt-2"><span class="small bold">${getStatusText(o.status)}</span><div class="flex-center gap-1"><button class="btn btn-sm btn-outline" onclick="showInvoice(1, ${o.id})">ÙØ§ØªÙˆØ±Ø©</button><button class="btn btn-sm bg-l1" style="color:#fff" onclick="nextStatus(1, ${o.id})">Ø§Ù„ØªØ§Ù„ÙŠ</button></div></div>
        </div>`).join('') || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
    document.getElementById('menu-list-1').innerHTML = d.menu.map(p => `<div class="flex-between card mb-1" style="padding:8px"><span class="small bold">${p.name}</span><input type="checkbox" ${p.active?'checked':''} onchange="toggleProduct(1, ${p.id})"></div>`).join('');
}

// Level 2 & 3 Generic
function renderClientApp(lvl) {
    const d = db[lvl];
    const body = document.getElementById(`body-${lvl}`);
    const color = lvl===2?'bg-l2':'bg-l3'; const txtC = lvl===2?'text-l2':'text-l3';
    
    // UPDATE HEADER
    const headerUser = document.getElementById(`header-user-${lvl}`);
    const loginBtn = document.getElementById(`login-btn-${lvl}`);
    if (d.user) {
        headerUser.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${d.user.name}`;
        loginBtn.textContent = 'Ø®Ø±ÙˆØ¬';
        loginBtn.onclick = () => logout(lvl);
    } else {
        headerUser.textContent = 'Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø²Ø§Ø¦Ø±';
        loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„';
        loginBtn.onclick = () => openLogin(lvl);
    }

    if(d.currentView === 'home') {
        let h = (lvl===3&&d.promo) ? `<div class="card mb-4" style="background:#DCFCE7;border:1px solid var(--success);color:var(--success);text-align:center;font-weight:700">ğŸ‰ ${d.promo}</div>` : '';
        if(d.user) h += `<div class="flex-between mb-4"><span class="chip" onclick="nav(${lvl}, 'profile')">ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</span><span class="chip" onclick="nav(${lvl}, 'address')">ğŸ  Ø¹Ù†Ø§ÙˆÙŠÙ†ÙŠ</span>${lvl===3 ? `<span class="chip" onclick="nav(${lvl}, 'wallet')">ğŸ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</span>` : ''}</div>`;
        
        // Skeleton Animation before loading products
        body.innerHTML = Array(4).fill(0).map(()=>`<div class="card mb-2" style="height:100px;display:flex;gap:10px"><div class="skeleton" style="width:80px;height:80px"></div><div style="flex:1"><div class="skeleton mb-2" style="width:60%;height:20px"></div><div class="skeleton" style="width:40%;height:15px"></div></div></div>`).join('');
        
        setTimeout(() => {
            body.innerHTML = h + d.menu.filter(p=>p.active).map(p => `
            <div class="card product-card mb-2">
                ${p.badge ? `<span class="prod-badge">${p.badge}</span>` : ''}
                <img src="${p.img}" class="p-img" onclick="openProductModal(${lvl}, ${p.id})">
                <div class="p-info"><div class="flex-between"><div class="p-title">${p.name}</div><i class="fas fa-heart ${d.fav.includes(p.id)?'text-danger':'muted'}" onclick="toggleFav(${lvl}, ${p.id})"></i></div>
                <div class="p-desc">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ: ${p.price} Ø¬.Ù…</div>
                <div class="flex-between mt-2"><select id="w-${lvl}-${p.id}" class="select" style="width:auto;padding:4px;margin:0;font-size:0.8rem"><option value="0.25">Â¼ ÙƒØ¬Ù…</option><option value="0.5">Â½ ÙƒØ¬Ù…</option><option value="1">1 ÙƒØ¬Ù…</option></select><button class="btn btn-sm ${color}" style="color:#fff" onclick="quickAdd(${lvl}, ${p.id})">Ø¥Ø¶Ø§ÙØ©</button></div></div></div>`).join('');
        }, 300);

    } else if(d.currentView === 'cart') {
        let total = d.cart.reduce((s,i)=>s+i.finalPrice,0);
        // Apply Level 3 Discount
        let discountHtml = '';
        if (lvl === 3 && d.activeDiscount) {
            let discountVal = 0;
            if (d.activeDiscount.type === 'percent') {
                discountVal = Math.round(total * (d.activeDiscount.val / 100));
                discountHtml = `<div class="flex-between text-success small mb-1"><span>Ø®ØµÙ… (${d.activeDiscount.val}%)</span><span>-${discountVal} Ø¬.Ù…</span></div>`;
            } else {
                discountVal = d.activeDiscount.val;
                discountHtml = `<div class="flex-between text-success small mb-1"><span>Ø®ØµÙ… Ø®Ø§Øµ</span><span>-${discountVal} Ø¬.Ù…</span></div>`;
            }
            total = Math.max(0, total - discountVal);
        }

        if(d.cart.length===0) return body.innerHTML='<div class="center" style="height:100%"><p class="muted">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p></div>';
        
        const items = d.cart.map((item,i) => {
            const isReward = item.isReward;
            const priceClass = item.finalPrice < 0 ? 'text-success' : txtC;
            return `<div class="card mb-2 flex-between" style="${isReward?'border-right:4px solid var(--success)':''}"><div><div class="bold">${item.name}</div><div class="small muted">${item.weightLabel}</div></div><div><div class="bold ${priceClass}">${item.finalPrice} Ø¬.Ù…</div><button class="btn btn-sm text-danger" onclick="removeFromCart(${lvl}, ${i})"><i class="fas fa-trash"></i></button></div></div>`;
        }).join('');
        
        const checkout = !d.user ? `<div class="card mt-4 center"><p class="text-danger mb-2">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p><button class="btn btn-sm btn-outline" onclick="openLogin(${lvl})">Ø¯Ø®ÙˆÙ„</button></div>` : `
            <div class="card mt-4"><h4 class="mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h4><div class="small mb-1">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${d.user.name}</div>
            <label class="small bold block mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
            <div style="display:flex;gap:5px"><select id="addr-sel-${lvl}" class="select" style="margin-bottom:0">${d.addresses.map(a=>`<option>${a}</option>`).join('')}</select><button class="btn btn-sm ${color}" style="color:#fff" onclick="openAddressModal(${lvl})">+</button></div>
            <div class="flex-between mb-2 mt-2"><label class="small bold">ğŸ Ù‡Ø¯ÙŠØ©ØŸ</label><input type="checkbox" onchange="toggleElem('gift-input-${lvl}')"></div><input id="gift-input-${lvl}" class="input hidden" placeholder="Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‡Ø¯ÙŠØ©">
            <div class="flex-between mb-2"><label class="small bold">â° Ø¬Ø¯ÙˆÙ„Ø©ØŸ</label><input type="checkbox" onchange="toggleElem('sched-input-${lvl}')"></div><input id="sched-input-${lvl}" type="datetime-local" class="input hidden">
            <textarea id="note-${lvl}" class="textarea mt-2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
            ${lvl===3?`<div class="small text-success mb-2"><i class="fas fa-star"></i> Ø³ØªÙƒØ³Ø¨ ${Math.floor(total/10)} Ù†Ù‚Ø·Ø©</div>`:''}
            ${discountHtml}
            <div class="flex-between mb-2 mt-2"><span class="bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><strong class="${txtC}" style="font-size:1.2rem">${total} Ø¬.Ù…</strong></div>
            <button class="btn btn-block ${color}" style="color:#fff" onclick="submitOrder(${lvl})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button></div>`;
        body.innerHTML = `<h3 class="mb-4">Ø§Ù„Ø³Ù„Ø© (${d.cart.length})</h3>` + items + checkout;
    } else if(d.currentView === 'track') {
        body.innerHTML = `<h3 class="mb-4">Ø·Ù„Ø¨Ø§ØªÙŠ</h3>` + (d.orders.map(o => `
        <div class="card mb-2">
            <div class="flex-between mb-2"><span class="bold">#${o.id}</span><span class="small muted">${o.time}</span></div>
            <div class="small mb-2">${o.items.map(i=>i.name).join(', ')}<br><strong>${o.total} Ø¬.Ù…</strong></div>
            <div class="timeline">
                <div class="tl-step done"><i class="fas fa-file-invoice"></i></div>
                <div class="tl-step ${['prep','deliv','done'].includes(o.status)?'done':''}"><i class="fas fa-fire-burner"></i></div>
                <div class="tl-step ${['deliv','done'].includes(o.status)?'done':''}"><i class="fas fa-motorcycle"></i></div>
                <div class="tl-step ${o.status==='done'?'done':''}"><i class="fas fa-check"></i></div>
            </div>
            <div class="center small mt-2 bold ${txtC}">${getStatusText(o.status)}</div>
        </div>`).join('') || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>');
    } else if(d.currentView === 'fav') {
        // Updated Favorites with Weight Selector
        body.innerHTML = `<h3 class="mb-4">Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>` + (d.menu.filter(p=>d.fav.includes(p.id)).map(p => `
            <div class="card product-card mb-2">
                <img src="${p.img}" class="p-img">
                <div class="p-info">
                    <div class="flex-between"><div class="p-title">${p.name}</div><i class="fas fa-heart text-danger" onclick="toggleFav(${lvl}, ${p.id})"></i></div>
                    <div class="p-desc">${p.price} Ø¬.Ù…</div>
                    <div class="flex-between mt-2">
                        <select id="w-fav-${lvl}-${p.id}" class="select" style="width:auto;padding:4px;margin:0;font-size:0.8rem">
                            <option value="0.25">Â¼ ÙƒØ¬Ù…</option>
                            <option value="0.5">Â½ ÙƒØ¬Ù…</option>
                            <option value="1">1 ÙƒØ¬Ù…</option>
                        </select>
                        <button class="btn btn-sm ${color}" style="color:#fff" onclick="quickAddFav(${lvl}, ${p.id})">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>
            </div>`).join('') || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ¶Ù„Ø©</p>');
    } else if(d.currentView === 'notif') {
        body.innerHTML = `<h3 class="mb-4">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>` + (d.notif.map((n, i)=>`
            <div class="card mb-2" style="border-right:4px solid var(--danger)">
                <div class="bold">${n.title}</div>
                <div class="small">${n.body}</div>
                ${n.promo ? `<button class="btn btn-sm bg-l3 mt-2" style="color:#fff" onclick="applyDiscount(${lvl}, ${i})">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶</button>` : ''}
                <div class="small muted mt-1">${n.time}</div>
            </div>`).join('') || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>');
    } else if(d.currentView === 'profile' && d.user) {
        body.innerHTML = `<h3 class="mb-4">Ø­Ø³Ø§Ø¨ÙŠ</h3><div class="card mb-4"><div class="flex-between mb-2"><span>Ø§Ù„Ø§Ø³Ù…</span><strong>${d.user.name}</strong></div><div class="flex-between"><span>Ø§Ù„Ù‡Ø§ØªÙ</span><strong>${d.user.phone}</strong></div><div class="flex-between"><span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span><strong>${d.orders.length}</strong></div></div><button class="btn btn-block btn-outline" onclick="logout(${lvl})">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>`;
    } else if(d.currentView === 'address' && d.user) {
        body.innerHTML = `<div class="flex-between mb-4"><h3>Ø¹Ù†Ø§ÙˆÙŠÙ†ÙŠ</h3> <button class="btn btn-sm ${color}" style="color:#fff" onclick="openAddressModal(${lvl})">+ Ø¬Ø¯ÙŠØ¯</button></div>${d.addresses.map(a=>`<div class="card mb-2 small">${a}</div>`).join('')}`;
    } else if(d.currentView === 'wallet' && d.user && lvl===3) {
        body.innerHTML = `<h3 class="mb-4">Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</h3><div class="card bg-l3 mb-4 center" style="color:#fff"><h1 style="font-size:3rem">${d.points}</h1><span>Ù†Ù‚Ø·Ø© ÙˆÙ„Ø§Ø¡ â­</span></div><h4 class="mb-2">Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>${l3Offers.map(o=>`<div class="card flex-between mb-2"><div><div class="bold">${o.title}</div><div class="small muted">${o.pts} Ù†Ù‚Ø·Ø©</div></div><button class="btn btn-sm btn-outline" onclick="redeemPoints(${o.id})">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button></div>`).join('')}`;
    }
}
function renderAdminApp(lvl) {
    const d = db[lvl];
    const color = lvl===2?'text-l2':'text-l3'; const bg = lvl===2?'bg-l2':'bg-l3';
    document.getElementById(`orders-list-${lvl}`).innerHTML = d.orders.map(o => `
    <div class="card mb-2" style="border-right:4px solid var(--l${lvl})">
        <div class="flex-between mb-1"><span class="bold">#${o.id}</span><span class="small muted">${o.time}</span></div>
        <div class="small mb-1">${o.client} <br> ${o.items.length} ØµÙ†Ù | ${o.total} Ø¬.Ù…</div>
        <div class="timeline">
            <div class="tl-step done"><i class="fas fa-file-invoice"></i></div>
            <div class="tl-step ${['prep','deliv','done'].includes(o.status)?'done':''}"><i class="fas fa-fire-burner"></i></div>
            <div class="tl-step ${['deliv','done'].includes(o.status)?'done':''}"><i class="fas fa-motorcycle"></i></div>
            <div class="tl-step ${o.status==='done'?'done':''}"><i class="fas fa-check"></i></div>
        </div>
        <div class="flex-between mt-2"><span class="small bold ${color}">${getStatusText(o.status)}</span><div class="flex-center gap-1"><button class="btn btn-sm btn-outline" onclick="showInvoice(${lvl}, ${o.id})">ÙØ§ØªÙˆØ±Ø©</button><button class="btn btn-sm ${bg}" style="color:#fff" onclick="nextStatus(${lvl}, ${o.id})">ØªØ­Ø¯ÙŠØ«</button></div></div>
    </div>`).join('') || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
    renderAdminPanel(lvl);
}
function renderAdminPanel(lvl) {
    const d = db[lvl]; const container = document.getElementById(`admin-panel-${lvl}`);
    if(d.adminView === 'menu') container.innerHTML = d.menu.map(p => `<div class="flex-between card mb-1" style="padding:8px"><span class="small bold">${p.name}</span><input type="checkbox" ${p.active?'checked':''} onchange="toggleProduct(${lvl}, ${p.id})"></div>`).join('');
    else if(d.adminView === 'customers') container.innerHTML = d.customers.map(c => `<div class="card mb-2 small"><div class="flex-between"><strong>${c.name}</strong> <span>${c.orders} Ø·Ù„Ø¨</span></div><div class="flex-between muted"><span>${c.phone}</span> <span>${c.total} Ø¬.Ù…</span></div></div>`).join('');
    else if(d.adminView === 'analytics' && lvl===3) {
        container.innerHTML = `
        <div class="grid-2 mb-2">
            <div class="card center"><h3 class="text-l3">${d.sales}</h3><span class="small muted">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></div>
            <div class="card center"><h3 class="text-l3">${d.orders.length}</h3><span class="small muted">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></div>
        </div>
        <div class="card mb-2"><h5 class="mb-2">ğŸ“¢ Ù†Ø´Ø± Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</h5>
            <input id="promo-title-3" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø«Ù„Ø§Ù‹: Ø®ØµÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©)">
            <div class="grid-2">
                <select id="promo-type-3" class="select"><option value="percent">Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© %</option><option value="fixed">Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (Ø¬.Ù…)</option></select>
                <input id="promo-val-3" class="input" type="number" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù…Ø«Ù„Ø§Ù‹ 20)">
            </div>
            <button class="btn btn-block bg-l3" style="color:#fff" onclick="sendPromo(3)">Ù†Ø´Ø± ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</button>
        </div>`;
    }
}

/* --- 6. ACTIONS --- */
function openProductModal(lvl, pid) {
    playSound('pop');
    const p = db[lvl].menu.find(x => x.id === pid); activeModalData = {lvl, p};
    document.getElementById(`mp-img-${lvl}`).src = p.img; document.getElementById(`mp-name-${lvl}`).textContent = p.name;
    document.getElementById(`mp-price-${lvl}`).textContent = (p.price * 0.25) + ' Ø¬.Ù…'; document.getElementById(`mp-weight-${lvl}`).value = 0.25;
    document.getElementById(`modal-product-${lvl}`).classList.add('open');
}
function updateModalPrice(lvl) {
    if (!activeModalData || !activeModalData.p) return; 
    const w = parseFloat(document.getElementById(`mp-weight-${lvl}`).value);
    document.getElementById(`mp-price-${lvl}`).textContent = Math.round(activeModalData.p.price * w) + ' Ø¬.Ù…';
}
function addToCartFromModal(lvl) {
    playSound('click');
    if (!activeModalData || !activeModalData.p) return; 
    const w = parseFloat(document.getElementById(`mp-weight-${lvl}`).value);
    addItemToCart(lvl, activeModalData.p, w); closeModal(lvl, 'product');
}
function quickAdd(lvl, pid) {
    playSound('click');
    const el = document.getElementById(`w-${lvl}-${pid}`); const w = el ? parseFloat(el.value) : 0.25;
    addItemToCart(lvl, db[lvl].menu.find(x=>x.id===pid), w);
}
// Special wrapper for Fav screen to handle unique ID
function quickAddFav(lvl, pid) {
    playSound('click');
    const el = document.getElementById(`w-fav-${lvl}-${pid}`); const w = el ? parseFloat(el.value) : 0.25;
    addItemToCart(lvl, db[lvl].menu.find(x=>x.id===pid), w);
}

function addItemToCart(lvl, p, w) {
    if(!db[lvl].storeOpen) { playSound('error'); return showBanner('ğŸ›‘ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹'); }
    const wLabels = {0.25:'Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ', 0.5:'Ù†ØµÙ ÙƒÙŠÙ„Ùˆ', 1:'ÙƒÙŠÙ„Ùˆ'};
    db[lvl].cart.push({ ...p, weight: w, weightLabel: wLabels[w], finalPrice: Math.round(p.price * w) });
    playSound('success');
    showBanner('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
    updateCounts(lvl); if(lvl > 1 && db[lvl].currentView === 'cart') renderClientApp(lvl);
}
function removeFromCart(lvl, idx) { playSound('click'); db[lvl].cart.splice(idx, 1); updateCounts(lvl); if(lvl===1) renderCartL1(); else renderClientApp(lvl); }
function updateCounts(lvl) {
    const c = db[lvl].cart.length; const el = document.getElementById(`badge-cart-${lvl}`); el.textContent=c; el.classList.toggle('hidden', c===0);
    if(lvl>1) { const n=db[lvl].notif.length; const ne=document.getElementById(`badge-notif-${lvl}`); ne.textContent=n; ne.classList.toggle('hidden', n===0); }
}
function submitOrder(lvl) {
    if(!db[lvl].storeOpen) { playSound('error'); return showBanner('ğŸ›‘ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚'); }
    const d = db[lvl]; if(d.cart.length===0) { playSound('error'); return showBanner('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); }
    if(lvl>1 && !d.user) { playSound('error'); return showBanner('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
    
    const anim = document.getElementById('success-anim-container'); anim.style.display='flex';
    playSound('success');
    setTimeout(() => { anim.style.display='none'; }, 2500);

    let total = d.cart.reduce((s,i)=>s+i.finalPrice, 0);
    let discountVal = 0; // New variable
    if (d.activeDiscount) {
        discountVal = d.activeDiscount.type === 'percent' ? Math.round(total * (d.activeDiscount.val / 100)) : d.activeDiscount.val;
        total = Math.max(0, total - discountVal);
        d.activeDiscount = null; // Consume discount
    }
    
    const note = lvl===1 ? document.getElementById('note-1').value : document.getElementById(`note-${lvl}`).value;
    const gift = lvl>1 ? document.getElementById(`gift-input-${lvl}`).value : '';
    const sched = lvl>1 ? document.getElementById(`sched-input-${lvl}`).value : '';
    const addr = lvl>1 ? document.getElementById(`addr-sel-${lvl}`).value : document.getElementById('guest-addr-1').value;
    const phone = lvl>1 ? d.user.phone : document.getElementById('guest-phone-1').value;

    const order = { 
        id: 1000 + d.orders.length + 1, 
        items: [...d.cart], 
        total: total, 
        discountVal: discountVal, // Store discount value
        client: (d.user?d.user.name:document.getElementById('guest-name-1').value), 
        phone: phone,
        addr: addr,
        note: note,
        gift: gift,
        sched: sched,
        time: new Date().toLocaleTimeString('ar-EG'), 
        status: 'new' 
    };
    d.orders.unshift(order); d.cart = [];
    
    if(lvl>1) {
        let cust = d.customers.find(c=>c.name===order.client);
        if(cust) { cust.orders++; cust.total+=total; } else d.customers.push({name:order.client, phone:phone, orders:1, total:total});
    }
    if(lvl===3) { d.sales+=total; d.points+=Math.floor(total/10); pushNotif(3, 'Ù†Ù‚Ø§Ø· Ù…ÙƒØªØ³Ø¨Ø©', `+${Math.floor(total/10)} Ù†Ù‚Ø·Ø©`); }
    if(lvl>1) { pushNotif(lvl, 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', `Ø·Ù„Ø¨Ùƒ #${order.id} Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°`); nav(lvl, 'track'); }
    else { nav(1, 'menu'); }
    
    renderLevel(lvl);
}
function nextStatus(lvl, oid) {
    playSound('click');
    const o = db[lvl].orders.find(x=>x.id===oid);
    const flow = ['new', 'prep', 'deliv', 'done'];
    const idx = flow.indexOf(o.status);
    if(idx<3) { o.status = flow[idx+1]; if(lvl>1) pushNotif(lvl, 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨', `Ø·Ù„Ø¨Ùƒ #${oid}: ${getStatusText(o.status)}`); renderLevel(lvl); }
}
function getStatusText(st) { return st==='new'?'Ø¬Ø¯ÙŠØ¯':st==='prep'?'ØªØ¬Ù‡ÙŠØ²':st==='deliv'?'ØªÙˆØµÙŠÙ„':'ØªÙ…'; }

/* --- Helpers --- */
function closeModal(lvl, type) { playSound('click'); document.getElementById(`modal-${type}-${lvl}`).classList.remove('open'); }
function toggleElem(id) { playSound('click'); document.getElementById(id).classList.toggle('hidden'); }
function toggleStore(lvl) { db[lvl].storeOpen = !db[lvl].storeOpen; showBanner(db[lvl].storeOpen?'âœ… Ø§Ù„Ù…ØªØ¬Ø± Ù…ÙØªÙˆØ­':'ğŸ›‘ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø±'); renderLevel(lvl); }
function toggleProduct(lvl, pid) { 
    playSound('click');
    const p = db[lvl].menu.find(x=>x.id===pid); 
    p.active = !p.active; 
    renderLevel(lvl); // Re-render to update client view immediately
}
function toggleFav(lvl, pid) { playSound('click'); const d=db[lvl]; const i=d.fav.indexOf(pid); if(i>-1) d.fav.splice(i,1); else d.fav.push(pid); renderClientApp(lvl); showBanner(i>-1?'ğŸ’” Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©':'â¤ï¸ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©'); }
function openLogin(lvl) { playSound('pop'); document.getElementById(`modal-login-${lvl}`).classList.add('open'); }
function sendOtp(lvl) { playSound('click'); toggleElem(`otp-area-${lvl}`); showBanner('ğŸ”‘ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚: 1234'); }
function verifyOtp(lvl) { 
    if(document.getElementById(`otp-code-${lvl}`).value==='1234') { 
        db[lvl].user={
            name:document.getElementById(`login-name-${lvl}`).value||'Ø¹Ù…ÙŠÙ„', 
            phone:document.getElementById(`login-phone-${lvl}`).value||'-'
        }; 
        playSound('success');
        closeModal(lvl,'login'); renderClientApp(lvl); showBanner('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } else {
        playSound('error');
        showBanner('âŒ Ø±Ù…Ø² Ø®Ø§Ø·Ø¦! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
    }
}
function logout(lvl) { playSound('click'); db[lvl].user=null; nav(lvl,'home'); showBanner('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }
function openAddressModal(lvl) { playSound('pop'); document.getElementById(`modal-address-${lvl}`).classList.add('open'); }
function saveAddress(lvl) { const v = document.getElementById(`new-addr-${lvl}`).value; if(v){db[lvl].addresses.push(v); closeModal(lvl, 'address'); renderClientApp(lvl); showBanner('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸'); playSound('success');} else showBanner('Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); }
function sendPromo(lvl) { const t=document.getElementById('promo-title-3').value; const tp=document.getElementById('promo-type-3').value; const v=parseFloat(document.getElementById('promo-val-3').value); if(t&&v){db[lvl].promo=t; pushNotif(lvl,'Ø¹Ø±Ø¶ Ø®Ø§Øµ âœ¨', t, {type:tp, val:v}); renderClientApp(lvl); showBanner('ØªÙ… Ø§Ù„Ù†Ø´Ø±'); playSound('notify');} }
function redeemPoints(oid) { const o = l3Offers.find(x=>x.id===oid); if(!o)return; if(db[3].points>=o.pts){db[3].points-=o.pts; if(o.type==='discount') db[3].cart.push({name:o.title, weightLabel:'Ù…ÙƒØ§ÙØ£Ø©', finalPrice:-o.val, isReward:true}); else {const p=db[3].menu.find(x=>x.id===o.val);if(p)db[3].cart.push({...p, weight:1, weightLabel:'Ù‡Ø¯ÙŠØ©', finalPrice:0, isReward:true});} renderClientApp(3); showBanner('ğŸ Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©'); playSound('success');} else {showBanner('Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø§ ØªÙƒÙÙŠ'); playSound('error');} }
function pushNotif(lvl, t, b, promo=null) { db[lvl].notif.unshift({title:t, body:b, time:new Date().toLocaleTimeString('ar-EG'), promo:promo}); updateCounts(lvl); playSound('notify'); }
function applyDiscount(lvl, idx) { const n = db[lvl].notif[idx]; if(n&&n.promo){db[lvl].activeDiscount=n.promo; showBanner('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶'); playSound('success'); nav(lvl, 'home');} }
function showInvoice(lvl, oid) {
    playSound('pop');
    try {
        const o = db[lvl].orders.find(x => x.id == oid);
        if (!o) return;
        const schedInfo = o.sched ? `<div class="mb-2"><strong>â° ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©:</strong> ${o.sched.replace('T', ' ')}</div>` : '';
        const giftInfo = o.gift ? `<div class="mb-2" style="background:#fef3c7;padding:5px;border-radius:4px"><strong>ğŸ Ø±Ø³Ø§Ù„Ø© Ù‡Ø¯ÙŠØ©:</strong><br>${o.gift}</div>` : '';
        const noteInfo = o.note ? `<div class="mb-2"><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${o.note}</div>` : '';
        const discountInfo = o.discountVal > 0 ? `<div class="flex-between mb-1 text-success"><strong>Ø®ØµÙ…:</strong> <span>-${o.discountVal} Ø¬.Ù…</span></div>` : '';

        document.getElementById(`invoice-content-${lvl}`).innerHTML = `
            <div style="text-align:center;margin-bottom:15px;border-bottom:2px solid #eee;padding-bottom:10px">
                <h3>ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©</h3>
                <div class="small muted">${new Date().toLocaleDateString('ar-EG')}</div>
            </div>
            <div class="flex-between mb-1"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> <span>#${o.id}</span></div>
            <div class="flex-between mb-2"><strong>ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨:</strong> <span>${o.time}</span></div>
            <div class="mb-1"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${o.client}</div>
            <div class="mb-1"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${o.phone || '-'}</div>
            <div class="mb-2"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${o.addr}</div>
            ${schedInfo} ${noteInfo}
            <hr style="border:1px dashed #ccc;margin:10px 0">
            <div style="margin-bottom:10px">
                ${o.items.map(i=> `<div class="flex-between mb-1" style="${i.finalPrice < 0 ? 'color:green' : ''}"><span>${i.name} <small class="muted">(${i.weightLabel})</small></span><span>${i.finalPrice} Ø¬.Ù…</span></div>`).join('')}
            </div>
            <hr style="border:1px dashed #ccc;margin:10px 0">
            ${discountInfo}
            ${giftInfo}
            <div class="flex-between bold" style="font-size:1.1rem;background:#f8fafc;padding:10px;border-radius:8px"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span>${o.total} Ø¬.Ù…</span></div>
        `;
        document.getElementById(`modal-invoice-${lvl}`).classList.add('open');
    } catch (e) { console.error(e); }
}

// Init
init();
</script>
</body>
</html>

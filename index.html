<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØ§Ù„ØªØ®ØµÙŠØµ</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Lottie Player -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root{
    /* Light Mode */
    --bg:#F8FAFC; 
    --text:#0F172A;
    --muted:#64748B; 
    
    --card-bg: #FFFFFF;
    --card-border: #E2E8F0; 
    --input-bg: #F1F5F9;
    
    /* Button Defaults */
    --btn-default-bg: #E2E8F0; 
    --btn-default-text: #1E293B; 
    --btn-hover: #CBD5E1;

    /* Brand Colors */
    --l1:#9A3412; 
    --l2:#0369A1; 
    --l3:#15803D; 
    
    --accent:#D97706; --danger:#DC2626; --success:#16A34A;
    
    /* Notification Colors */
    --notif-order: #2563EB; 
    --notif-points: #D97706; 
    --notif-promo: #DC2626; 
    
    /* Glassmorphism */
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: rgba(255, 255, 255, 0.4);
    --modal-overlay:rgba(15, 23, 42, 0.65);
    --offline-bg:rgba(241, 245, 249, 0.95);

    /* UI Enhancements */
    --shadow-sm: 0 2px 4px rgba(148, 163, 184, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(148, 163, 184, 0.1), 0 2px 4px -1px rgba(148, 163, 184, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(148, 163, 184, 0.1), 0 4px 6px -2px rgba(148, 163, 184, 0.05);
}

:root.dark{
    /* Dark Mode */
    --bg:#020617;
    --text:#F8FAFC;
    --muted:#94A3B8;
    
    --card-bg: #1E293B;
    --card-border: #334155;
    --input-bg: #0F172A;
    --btn-default-bg: #334155;
    --btn-default-text: #F8FAFC;
    --btn-hover: #475569;
    --l1:#F97316; --l2:#38BDF8; --l3:#4ADE80; 
    
    /* Glassmorphism Dark */
    --glass-bg: rgba(30, 41, 59, 0.65);
    --glass-border: rgba(255, 255, 255, 0.1);
    --modal-overlay:rgba(0,0,0,0.85);
    --offline-bg:rgba(2, 6, 23, 0.98);
    
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
}

/* --- GLOBAL RESET --- */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Tajawal',sans-serif;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:50px;transition:background .3s,color .3s;overflow-x:hidden}
button{cursor:pointer}
.hidden{display:none!important}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px) rotate(-5deg)} 75%{transform:translateX(5px) rotate(5deg)} }
@keyframes bounce { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.3);} }

.anim-bounce { animation: bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: var(--danger) !important; }
.anim-shake { animation: shake 0.4s ease-in-out; color: var(--l2) !important; }

/* --- LAYOUT --- */
.topbar{
    position:sticky;top:0;z-index:900;background:var(--card-bg);
    border-bottom:1px solid var(--card-border);
    padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:15px;
    box-shadow: var(--shadow-sm);
    transition: background 0.3s, border-color 0.3s;
}

.container{max-width:1300px;margin:30px auto;padding:0 20px}
.level-container{display:none;animation:fadeIn .5s cubic-bezier(0.4, 0, 0.2, 1)}
.level-container.active{display:block}

.workspace{display:flex;gap:40px;align-items:flex-start;justify-content: center;}
.client-side{flex:0 0 380px;display:flex;flex-direction:column;align-items:center}
.admin-side{flex:1;min-width:0;display:flex;flex-direction:column}
@media(max-width:900px){.workspace{flex-direction:column;align-items:center}.client-side{width:100%}.admin-side{width:100%}}

/* Frames - FIX: Added max-width */
.frame{
    background:var(--bg); 
    border-radius:35px; box-shadow: var(--shadow-lg);
    border:12px solid #1E293B; 
    overflow:hidden; display:flex; flex-direction:column;
    position:relative; transition: border-color 0.3s;
    z-index: 1; 
    transform: translate3d(0,0,0);
    isolation: isolate;
}
.frame.mobile{width:375px; max-width: 100%; height:750px;border-radius:45px;border-width:14px}
/* SCROLL FIX: Changed min-height to fixed height for tablet to enable internal scrolling */
.frame.tablet{width:100%;height:800px;border-radius:25px;border-width:14px}

/* --- GLASSMORPHISM --- */
.frame.mobile, .frame.tablet {
    background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); 
}
.dark .frame.mobile, .dark .frame.tablet {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}
.frame.mobile::before, .frame.tablet::before {
    content: ''; position: absolute; top: -10%; left: -10%; width: 80%; height: 40%;
    background: linear-gradient(90deg, var(--l1), var(--l2));
    filter: blur(90px); opacity: 0.4; z-index: -1; border-radius: 50%;
}
.frame.mobile::after, .frame.tablet::after {
    content: ''; position: absolute; bottom: -10%; right: -10%; width: 80%; height: 40%;
    background: linear-gradient(90deg, var(--l3), var(--accent));
    filter: blur(90px); opacity: 0.3; z-index: -1; border-radius: 50%;
}

.frame.mobile .app-body, .frame.tablet .app-body {
    background: transparent !important;
}

.frame.mobile .app-header, 
.frame.mobile .app-nav,
.frame.tablet .app-header,
.frame.tablet .admin-order-card,
.frame.tablet .kpi-card,
.frame.tablet .chart-box {
    background: rgba(255, 255, 255, 0.3) !important;
    backdrop-filter: blur(40px) saturate(150%);
    -webkit-backdrop-filter: blur(40px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
}

.dark .frame.mobile .app-header, 
.dark .frame.mobile .app-nav,
.dark .frame.tablet .app-header,
.dark .frame.tablet .admin-order-card,
.dark .frame.tablet .kpi-card,
.dark .frame.tablet .chart-box {
    background: rgba(30, 41, 59, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.frame.mobile .card,
.frame.mobile .product-card,
.frame.mobile .notif-card {
    background: rgba(255, 255, 255, 0.4) !important;
    backdrop-filter: blur(20px) saturate(150%);
    -webkit-backdrop-filter: blur(20px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
}
.dark .frame.mobile .card,
.dark .frame.mobile .product-card,
.dark .frame.mobile .notif-card {
    background: rgba(30, 41, 59, 0.4) !important;
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
}

/* App Header & Body */
.app-header{
    padding:16px 20px;
    color: #0F172A;
    display:flex;align-items:center;justify-content:space-between;
    font-weight:800; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-shrink:0;
    position: relative; z-index: 10; 
}
.app-body{
    flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px;
    background: var(--bg); 
    transition: background 0.3s;
}

.frame.mobile .app-header, .frame.tablet .app-header {
    border-color: #020617 !important;
    color: #0F172A !important;
}

.dark .app-header {
    color: #F8FAFC !important;
}

/* --- UTILITIES --- */
.flex-between { display: flex; align-items: center; justify-content: space-between; }
.flex-center { display: flex; align-items: center; justify-content: center; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.w-full { width: 100%; }
.mb-1 { margin-bottom: 4px; }
.mb-2 { margin-bottom: 8px; }
.mb-4 { margin-bottom: 16px; }
.mt-2 { margin-top: 8px; }
.text-center { text-align: center; }
.bold { font-weight: 700; }
.small { font-size: 0.85rem; }
.muted { color: var(--muted); }
.text-danger { color: var(--danger); }
.text-success { color: var(--success); }
.text-l1 { color: var(--l1); }
.text-l2 { color: var(--l2); }
.text-l3 { color: var(--l3); }

/* Typography */
h3, h4, h5 { font-weight: 800; letter-spacing: -0.02em; }
.p-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 4px; color: var(--text); }
.p-price { font-weight: 700; font-size: 0.95rem; color: var(--l1); }

/* --- COMPONENTS --- */
.card{
    background:var(--card-bg); padding:14px; border-radius:16px; 
    box-shadow: var(--shadow-sm); position:relative;
    border: 1px solid var(--card-border);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

/* Product Card */
.product-card { 
    padding: 0 !important; 
    overflow: hidden; 
    flex: 0 0 auto !important; 
    margin-bottom: 12px;
    border: none; 
    box-shadow: var(--shadow-md);
    position: relative;
}
.product-card .p-img { width: 100%; height: 180px; border-radius: 0; object-fit: cover; border: none; }
.p-info { padding: 16px; }

/* Badges */
.prod-badge {
    position: absolute; top: 10px; left: 10px;
    padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; 
    color: #fff; z-index: 2;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    backdrop-filter: blur(4px);
}
.badge-new { background: var(--l2); }
.badge-best { background: var(--accent); }
.badge-hot { background: var(--danger); }
.badge-sale { background: var(--success); }

/* Bottom Nav - SCROLLABLE UPDATE */
.app-nav{
    background:var(--card-bg);padding:12px 10px;border-top:1px solid var(--card-border);
    display:flex; justify-content: flex-start; /* Changed to start for scroll */
    align-items:center; flex-shrink:0;
    border-radius: 0 0 25px 25px; z-index: 10;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
    position: relative;
    overflow-x: auto; /* Enable Horizontal Scroll */
    gap: 15px; /* Spacing between items */
}
/* Hide scrollbar */
.app-nav::-webkit-scrollbar { display: none; }

.nav-item{
    display:flex;flex-direction:column;align-items:center;font-size:0.75rem;
    color:var(--muted);gap:6px;cursor:pointer;position:relative;
    padding:6px 12px;border-radius:12px; transition: transform 0.2s;
    flex: 0 0 auto; /* Don't shrink */
    min-width: 60px; /* Ensure click area */
}
.nav-item:active { transform: scale(0.9); }
.nav-item i { font-size: 1.4rem; transition: transform 0.2s, color 0.2s; }
.nav-label { font-size: 0.65rem; font-weight: 700; margin-top: 2px; }

.nav-item.active {
    transform: translateY(-5px) scale(1.1); /* Reduced jump for scroll view */
    background: var(--card-bg);
    border-radius: 50%;
    padding: 14px;
    /* margin-bottom: -15px; REMOVED to avoid layout shift in scroll */
    border: 4px solid var(--bg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.nav-item.active .nav-label { display: none; }

#level-1 .nav-item.active { color: var(--l1); box-shadow: 0 8px 20px -5px var(--l1); }
#level-2 .nav-item.active { color: var(--l2); box-shadow: 0 8px 20px -5px var(--l2); }
#level-3 .nav-item.active { color: var(--l3); box-shadow: 0 8px 20px -5px var(--l3); }

/* Modals */
.modal-overlay{
    position:absolute;inset:0;background:var(--modal-overlay);z-index:3000;
    display:none;align-items:center;justify-content:center;padding:20px;
    animation:fadeModal .3s ease; backdrop-filter: blur(8px);
}
.modal-overlay.open{display:flex}

.modal-content{
    background: var(--glass-bg);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid var(--glass-border);
    width:100%;max-width:340px;border-radius:24px;padding:25px;
    box-shadow: 0 20px 70px rgba(0,0,0,0.3);
    max-height:90%;overflow-y:auto; color: var(--text);
}

.modal-content .input, 
.modal-content .select {
    background: var(--card-bg);
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.dark .modal-content .input, 
.dark .modal-content .select {
    border: 1px solid rgba(255,255,255,0.1);
}

.frame.mobile .modal-overlay { align-items: flex-end; padding: 0; }
.frame.mobile .modal-content {
    width: 100%; max-width: 100%; 
    border-radius: 30px 30px 0 0;
    padding: 30px 25px 40px 25px; 
    animation: slideUp 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    margin: 0; border-bottom: none;
}

.client-side .modal-content {
    backdrop-filter: blur(60px) saturate(220%) !important;
    -webkit-backdrop-filter: blur(60px) saturate(220%) !important;
    background: rgba(255, 255, 255, 0.55) !important;
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    box-shadow: 0 30px 60px rgba(0,0,0,0.15) !important;
}
.dark .client-side .modal-content {
    background: rgba(15, 23, 42, 0.6) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
}

/* Notifications & Dashboard */
.notif-card {
    background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow-sm);
    padding: 16px; position: relative; border: 1px solid var(--card-border);
    overflow: hidden; transition: transform 0.2s; border-right-width: 6px; border-right-style: solid; margin-bottom: 12px;
    flex: 0 0 auto !important; 
    width: 100%;
}
.notif-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
/* Specific Order Status Colors will be inline to override, but defaults: */
.notif-card.type-order { border-right-color: var(--notif-order); background: linear-gradient(to left, rgba(37, 99, 235, 0.05), var(--card-bg)); }
.notif-card.type-points { border-right-color: var(--notif-points); background: linear-gradient(to left, rgba(217, 119, 6, 0.05), var(--card-bg)); }
.notif-card.type-promo { border-right-color: var(--notif-promo); background: linear-gradient(to left, rgba(220, 38, 38, 0.05), var(--card-bg)); }

.dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
.kpi-card { background: var(--card-bg); padding: 15px; border-radius: 16px; border: 1px solid var(--card-border); display: flex; flex-direction: column; justify-content: center; box-shadow: var(--shadow-sm); }
.kpi-value { font-size: 1.6rem; font-weight: 800; color: var(--text); line-height: 1.2; }
.kpi-label { font-size: 0.85rem; color: var(--muted); font-weight: 600; }
.trend { font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 4px; margin-top: 6px; }
.trend.up { color: var(--success); }
.trend.down { color: var(--danger); }

.chart-box { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-md); }
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 800; font-size: 1rem; color: var(--text); }
.line-chart-svg { width: 100%; height: 120px; overflow: visible; }
.line-path { fill: none; stroke: var(--l3); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; vector-effect: non-scaling-stroke; }
.line-area { fill: rgba(21, 128, 61, 0.1); stroke: none; }
.chart-axis { stroke: var(--card-border); stroke-width: 1; stroke-dasharray: 4; }
.prog-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.9rem; }
.prog-name { width: 35%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
.prog-track { flex: 1; height: 10px; background: var(--btn-default-bg); border-radius: 99px; margin: 0 12px; overflow: hidden; }
.prog-fill { height: 100%; background: var(--l3); border-radius: 99px; transition: width 1s ease; }
.prog-val { font-weight: 700; font-size: 0.85rem; width: 40px; text-align: left; color: var(--muted); }
.heatmap-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 4px; margin-top: 10px; }
.hm-cell { aspect-ratio: 1; border-radius: 4px; transition: 0.2s; }
.hm-cell:hover { transform: scale(1.2); z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.hm-label { grid-column: span 12; display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); margin-top: 4px; }

/* Admin Card */
.admin-order-card {
    flex: 0 0 auto !important; width: 100%; padding: 10px 12px !important; font-size: 0.85rem; margin-bottom: 0; background: var(--bg); border: 1px solid var(--card-border); min-height: 110px; box-shadow: none; 
}
.orders-stack { display: flex; flex-direction: column; gap: 10px; padding-bottom: 30px; }

/* Modern Ticket */
.modern-ticket {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 16px;
    border: 1px solid var(--card-border);
    display: flex;
    flex-direction: column;
    transition: transform 0.2s;
    flex: 0 0 auto; 
}
.modern-ticket:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

.mt-header {
    padding: 12px 16px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px dashed var(--card-border);
    background: var(--input-bg);
}
.mt-id { font-weight: 900; font-size: 1.1rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
.mt-time { font-family: monospace; color: var(--muted); font-size: 0.85rem; }

.mt-body { padding: 16px; flex: 1; }
.mt-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
.mt-item span:last-child { font-weight: 700; color: var(--muted); font-size: 0.85rem; }

.mt-footer {
    padding: 12px 16px;
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(0,0,0,0.02);
    border-top: 1px solid var(--card-border);
}

.mt-status {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 99px;
    font-size: 0.8rem; font-weight: 800;
}

.status-new { background: #FEF3C7; color: #D97706; border: 1px solid #FCD34D; }
.status-prep { background: #DBEAFE; color: #2563EB; border: 1px solid #93C5FD; }
.status-deliv { background: #F3E8FF; color: #7E22CE; border: 1px solid #D8B4FE; }
.status-done { background: #DCFCE7; color: #15803D; border: 1px solid #86EFAC; }
/* NEW: Cancelled Status */
.status-cancelled { background: #FEE2E2; color: #DC2626; border: 1px solid #FCA5A5; }

.modern-ticket.st-new { border-right: 5px solid #D97706; }
.modern-ticket.st-prep { border-right: 5px solid #2563EB; }
.modern-ticket.st-deliv { border-right: 5px solid #7E22CE; }
.modern-ticket.st-done { border-right: 5px solid #15803D; }
.modern-ticket.st-cancelled { border-right: 5px solid #DC2626; } /* NEW */

/* Buttons & Inputs */
.btn{ border:1px solid var(--card-border); border-radius:12px; padding:10px 16px; font-weight:700; font-size:0.95rem; display:inline-flex;align-items:center;justify-content:center;gap:8px; transition:all 0.2s; cursor:pointer; overflow: hidden; background-color: var(--btn-default-bg); color: var(--btn-default-text); box-shadow: var(--shadow-sm); }
.btn:hover{filter: brightness(1.05); transform: translateY(-1px); box-shadow: var(--shadow-md);}
.btn:active{transform:scale(0.96) translateY(0);}
/* NEW: Update button color to a standard blue for Update actions */
.btn-update { background-color: #2563EB !important; color: #fff !important; border: none; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3) !important; }

.btn-danger { background-color: var(--danger) !important; color: #fff !important; border: none; box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3) !important; }
.bg-l1 { background-color: var(--l1) !important; color: #fff !important; border: none; box-shadow: 0 4px 10px rgba(154, 52, 18, 0.3) !important; }
.bg-l2 { background-color: var(--l2) !important; color: #fff !important; border: none; box-shadow: 0 4px 10px rgba(3, 105, 161, 0.3) !important; }
.bg-l3 { background-color: var(--l3) !important; color: #fff !important; border: none; box-shadow: 0 4px 10px rgba(21, 128, 61, 0.3) !important; }
.btn-outline { background: transparent; border: 2px solid currentColor; color: var(--text); box-shadow: none !important; }
.btn-outline:hover { background: var(--btn-default-bg); border-color: transparent; }
.lvl-btn{ padding:8px 20px; border-radius:99px; border:1px solid var(--card-border); font-weight:700; font-size:0.9rem; background: var(--card-bg); color: var(--text); transition:all .3s; }
.lvl-btn.active{color:#fff; border-color:transparent; box-shadow:0 4px 15px rgba(0,0,0,0.2); transform:translateY(-2px)}
.lvl-btn[data-lvl="1"].active{background:var(--l1)}
.lvl-btn[data-lvl="2"].active{background:var(--l2)}
.lvl-btn[data-lvl="3"].active{background:var(--l3)}
.toggle-btn{ width:42px;height:42px;border-radius:12px;border:1px solid var(--card-border); background:var(--card-bg); color:var(--text); display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:0.2s; box-shadow: var(--shadow-sm); }
.toggle-btn:hover{background:var(--btn-default-bg);transform:scale(1.05)}
.input, .select, .textarea{ width:100%;padding:12px;border-radius:12px;border:2px solid var(--card-border); background:var(--input-bg); color:var(--text); font-size:0.95rem;margin-bottom:10px;outline:none; transition: border-color 0.2s, box-shadow 0.2s; }
.input:focus { border-color: var(--l2); box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1); }
.chip{ font-size:0.8rem;padding:6px 12px;border-radius:99px; background:var(--btn-default-bg); color:var(--text); font-weight: 600; display:inline-flex;align-items:center;gap:6px;cursor:pointer; transition: 0.2s; border: 1px solid var(--card-border); }
/* NEW: Category Chips Styling */
.category-chips {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 0 0 10px 0;
    margin-bottom: 8px;
    flex-shrink: 0;
    -webkit-overflow-scrolling: touch;
    white-space: nowrap;
}
.category-chips::-webkit-scrollbar {
    display: none;
}
.chip.category {
    flex: 0 0 auto;
    border: 1px solid var(--card-border);
    background: var(--input-bg);
    padding: 8px 14px;
    font-size: 0.85rem;
    transition: background 0.2s, color 0.2s;
}
.chip.category.active {
    background: var(--l2);
    color: #fff;
    font-weight: 800;
    box-shadow: var(--shadow-sm);
}

.admin-tabs { display: flex; background: var(--btn-default-bg); padding: 4px; border-radius: 12px; margin-bottom: 16px; gap: 4px; }
.admin-tab { flex: 1; text-align: center; padding: 8px 4px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: var(--muted); cursor: pointer; transition: all 0.2s ease; user-select: none; }
.admin-tab:hover { background: rgba(255,255,255,0.5); }
.admin-tab.active { background: var(--card-bg); color: var(--text); box-shadow: var(--shadow-sm); font-weight: 800; }
#level-2 .admin-tab.active { color: var(--l2); }
#level-3 .admin-tab.active { color: var(--l3); }
/* Order Tabs (New) */
.order-tabs { display: flex; background: var(--btn-default-bg); border-radius: 12px; padding: 4px; margin-bottom: 12px; }
.order-tab-btn { flex: 1; padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--muted); transition: 0.2s; border: none; background: transparent; }
.order-tab-btn.active { background: var(--card-bg); color: var(--text); box-shadow: var(--shadow-sm); }
.switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
input:checked + .slider { background-color: var(--success); }
input:focus + .slider { box-shadow: 0 0 1px var(--success); }
input:checked + .slider:before { transform: translateX(20px); }
.toggle-label { font-size: 0.85rem; font-weight: 700; margin-left: 8px; color: inherit; }

/* FIX: Increased z-index for offline overlay */
.offline-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(185, 28, 28, 0.98); color: #fff; backdrop-filter: blur(10px); z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; opacity: 0; pointer-events: none; transition: 0.4s; border-radius: inherit; }
.offline-overlay.active { opacity: 1; pointer-events: all; }
.offline-overlay .closed-icon { font-size: 4rem; margin-bottom: 16px; }
.offline-overlay h3 { font-size: 1.8rem; font-weight: 800; margin-bottom: 8px; }
.offline-overlay p.muted { color: rgba(255, 255, 255, 0.8); font-size: 1rem; font-weight: 500; }

/* FIX: Exit button visibility */
#exit-pres-btn { display: none; position: fixed; bottom: 30px; right: 30px; background: var(--danger); color: #fff; border: none; padding: 12px 25px; border-radius: 99px; z-index: 11001; font-weight: bold; backdrop-filter: blur(10px); cursor: pointer; transition: 0.2s; box-shadow: 0 10px 20px rgba(0,0,0,0.3); align-items: center; gap: 8px; }
body.pres-active #exit-pres-btn { display: flex !important; }
#exit-pres-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
.pres-btn-area { text-align: center; margin-top: 15px; z-index: 100; position: relative; }

/* Banner (Hidden, replaced by toast logic) */
#banner { display: none !important; } 

/* New Toast Container Styling */
.toast-container {
    position: absolute;
    top: 70px; /* Under the header */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 350px;
    z-index: 2000; 
    pointer-events: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
/* Style for modal toast containers (to appear above modal content) */
.modal-overlay .toast-container {
    position: absolute;
    top: 20px; 
    left: 50%;
    transform: translateX(-50%);
    z-index: 4000; /* Must be higher than modal content/overlay */
    width: 100%;
    max-width: 300px;
}

.toast {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    color: var(--text);
    font-size: 0.9rem;
    font-weight: 700;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    transform: translateY(-20px);
    pointer-events: auto;
    display: flex;
    align-items: center;
    gap: 10px;
}
.dark .toast {
    background: var(--glass-bg);
}
.toast.show {
    opacity: 1;
    transform: translateY(0);
}
</style>
</head>
<body>

<!-- Exit Presentation Button -->
<button id="exit-pres-btn" onclick="togglePresentation()">âŒ Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶</button>

<!-- Floating Banner (Kept for compatibility, but hidden by CSS) -->
<div id="banner"><i class="fas fa-info-circle"></i> <span id="banner-msg"></span></div>

<!-- Topbar -->
<header class="topbar">
    <div style="display:flex;gap:10px">
        <button class="toggle-btn" onclick="toggleTheme()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ“</button>
        <button class="toggle-btn" onclick="toggleSound()" title="Ø§Ù„ØµÙˆØª">ğŸ””</button>
    </div>
    <div class="level-tabs">
        <button class="lvl-btn active" data-lvl="1" onclick="switchLevel(1)">Ù…Ø³ØªÙˆÙ‰ 1</button>
        <button class="lvl-btn" data-lvl="2" onclick="switchLevel(2)">Ù…Ø³ØªÙˆÙ‰ 2</button>
        <button class="lvl-btn" data-lvl="3" onclick="switchLevel(3)">Ù…Ø³ØªÙˆÙ‰ 3</button>
    </div>
</header>

<!-- Main Container -->
<div class="container">
    <!-- LEVEL 1 -->
    <div id="level-1" class="level-container active">
        <div class="workspace">
            <div class="client-side">
                <div class="frame mobile">
                    <div class="toast-container" id="client-toast-1"></div> <!-- NEW TOAST CONTAINER -->
                    <div class="app-header">
                        <span>Ø­Ù„ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©</span>
                        <span id="store-badge-1" class="chip" style="background:rgba(22, 163, 74, 0.2);color:var(--success);font-weight:800">Ù…ÙØªÙˆØ­</span>
                    </div>
                    <!-- CATEGORY CHIPS ADDED HERE FOR L1 -->
                    <div class="app-body" id="body-1"></div>
                    <div class="app-nav">
                        <div class="nav-item active" onclick="nav(1, 'menu')"><i class="fas fa-utensils"></i><span class="nav-label">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span></div>
                        <div class="nav-item" onclick="nav(1, 'cart')"><i class="fas fa-shopping-basket" id="cart-icon-1"></i><span class="nav-label">Ø§Ù„Ø³Ù„Ø©</span><span id="badge-cart-1" class="badge hidden">0</span></div>
                        <!-- CHANGED: About to Settings in L1 -->
                        <div class="nav-item" onclick="nav(1, 'settings')"><i class="fas fa-cog"></i><span class="nav-label">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
                    </div>
                    <div id="offline-1" class="offline-overlay"><i class="fas fa-store-slash closed-icon"></i><h3>Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚</h3><p class="muted">Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ Ù†Ø³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>
                    <div id="modal-product-1" class="modal-overlay">
                        <div class="toast-container" id="modal-toast-product-1"></div> <!-- NEW MODAL TOAST CONTAINER -->
                        <div class="modal-content">
                            <img id="mp-img-1" src="" style="width:100%;height:180px;object-fit:cover;border-radius:16px;margin-bottom:15px;background:#eee">
                            <div class="flex-between mb-2 mt-2"><h3 id="mp-name-1" style="font-size:1.4rem;margin:0"></h3><strong id="mp-price-1" class="text-l1" style="font-size:1.4rem">0 Ø¬.Ù…</strong></div>
                            <div class="small muted mb-4">Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
                            <!-- L1 remains simple with only weight selection -->
                            <select id="mp-weight-1" class="select" onchange="updateModalPrice(1)"><option value="0.25">Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ</option><option value="0.5">Ù†ØµÙ ÙƒÙŠÙ„Ùˆ</option><option value="1">ÙƒÙŠÙ„Ùˆ</option></select>
                            
                            <div class="card mt-2 mb-4 hidden" id="mp-addons-container-1">
                                <h4 class="mb-2" style="font-size:1rem">Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</h4>
                                <div id="mp-addons-1" style="display:flex; flex-direction:column; gap:8px;">
                                    <!-- Addons are hidden in L1 -->
                                </div>
                            </div>

                            <div style="display:flex; gap:10px; margin-top:10px"><button class="btn btn-block bg-l1" style="flex:2" onclick="addToCartFromModal(1)">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button><button class="btn btn-block btn-outline" style="flex:1" onclick="closeModal(1, 'product')">Ø¥ØºÙ„Ø§Ù‚</button></div>
                        </div>
                    </div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l1" onclick="togglePresentation('mobile')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
            </div>
            <div class="admin-side">
                <div class="frame tablet" id="admin-frame-1">
                    <div class="toast-container" id="admin-toast-1"></div> <!-- NEW TOAST CONTAINER -->
                    <!-- CONTENT GENERATED BY JS -->
                    <!-- MODALS will be injected here on renderAdminInterface -->
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l1" onclick="togglePresentation('tablet')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„</button></div>
            </div>
        </div>
    </div>

    <!-- LEVEL 2 -->
    <div id="level-2" class="level-container">
        <div class="workspace">
            <div class="client-side">
                <div class="frame mobile">
                    <div class="toast-container" id="client-toast-2"></div> <!-- NEW TOAST CONTAINER -->
                    <div class="app-header"><span id="header-user-2">Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø²Ø§Ø¦Ø±</span><button id="login-btn-2" class="btn btn-sm" style="background:rgba(255,255,255,0.2);border:1px solid currentColor" onclick="openLogin(2)">Ø¯Ø®ÙˆÙ„</button></div>
                    <!-- CATEGORY CHIPS ADDED HERE FOR L2 -->
                    <div class="app-body" id="body-2"></div>
                    <div class="app-nav">
                        <div class="nav-item active" onclick="nav(2, 'home')"><i class="fas fa-home"></i><span class="nav-label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
                        <div class="nav-item" onclick="nav(2, 'cart')"><i class="fas fa-shopping-basket" id="cart-icon-2"></i><span class="nav-label">Ø§Ù„Ø³Ù„Ø©</span><span id="badge-cart-2" class="badge hidden">0</span></div>
                        <div class="nav-item" onclick="nav(2, 'track')"><i class="fas fa-box-open"></i><span class="nav-label">ØªØªØ¨Ø¹</span></div>
                        <div class="nav-item" onclick="nav(2, 'notif')"><i class="fas fa-bell"></i><span class="nav-label">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span><span id="badge-notif-2" class="badge hidden">0</span></div>
                        <!-- CHANGED: Replaced Fav/About with Settings -->
                        <div class="nav-item" onclick="nav(2, 'settings')"><i class="fas fa-cog"></i><span class="nav-label">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
                    </div>
                    <div id="offline-2" class="offline-overlay"><i class="fas fa-store-slash closed-icon"></i><h3>Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚</h3><p class="muted">Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ Ù†Ø³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>
                    <div id="modal-product-2" class="modal-overlay">
                        <div class="toast-container" id="modal-toast-product-2"></div> <!-- NEW MODAL TOAST CONTAINER -->
                        <div class="modal-content">
                            <img id="mp-img-2" src="" style="width:100%;height:180px;object-fit:cover;border-radius:16px;margin-bottom:15px;background:#eee">
                            <div class="flex-between mb-2 mt-2"><h3 id="mp-name-2" style="font-size:1.4rem;margin:0"></h3><strong id="mp-price-2" class="text-l2" style="font-size:1.4rem">0 Ø¬.Ù…</strong></div>
                            <div class="small muted mb-4">Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
                            <select id="mp-weight-2" class="select" onchange="updateModalPrice(2)"><option value="0.25">Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ</option><option value="0.5">Ù†ØµÙ ÙƒÙŠÙ„Ùˆ</option><option value="1">ÙƒÙŠÙ„Ùˆ</option></select>
                            
                            <!-- NEW: Addons Container for L2 -->
                            <div class="card mt-2 mb-4" id="mp-addons-container-2" style="border:1px solid var(--l2); padding:12px;">
                                <h4 class="mb-2" style="font-size:1rem; color:var(--l2); font-weight:800;">Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ØªØ®ØµÙŠØµ:</h4>
                                <div id="mp-addons-2" style="display:flex; flex-direction:column; gap:8px;">
                                    <!-- Checkboxes will be injected here by JS -->
                                </div>
                            </div>
                            <!-- End NEW Addons -->

                            <div style="display:flex; gap:10px; margin-top:10px"><button class="btn btn-block bg-l2" style="flex:2" onclick="addToCartFromModal(2)">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button><button class="btn btn-block btn-outline" style="flex:1" onclick="closeModal(2, 'product')">Ø¥ØºÙ„Ø§Ù‚</button></div>
                        </div>
                    </div>
                    <div id="modal-login-2" class="modal-overlay">
                        <div class="toast-container" id="modal-toast-login-2"></div> <!-- NEW MODAL TOAST CONTAINER -->
                        <div class="modal-content">
                            <h3 class="center mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                            <input id="login-name-2" class="input" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø·Ù„ÙˆØ¨)">
                            <input id="login-phone-2" class="input" placeholder="Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù…Ø·Ù„ÙˆØ¨)">
                            <!-- NEW ADDRESS INPUT -->
                            <input id="login-addr-2" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨)">
                            <button class="btn btn-block bg-l2 mb-2" onclick="sendOtp(2)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</button>
                            <div id="otp-area-2" class="hidden">
                                <input id="otp-code-2" class="input" placeholder="Ø§Ù„Ø±Ù…Ø² (1234)">
                                <button class="btn btn-block bg-l2" onclick="verifyOtp(2)">ØªØ£ÙƒÙŠØ¯</button>
                            </div>
                            <button class="btn btn-block btn-outline mt-2" onclick="closeModal(2, 'login')">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                    <div id="modal-address-2" class="modal-overlay">
                        <div class="toast-container" id="modal-toast-address-2"></div> <!-- NEW MODAL TOAST CONTAINER -->
                        <div class="modal-content"><h3 class="center mb-4">Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</h3><input id="new-addr-2" class="input" placeholder="Ø§Ù„Ù…Ù†Ø²Ù„ - Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ..."><button class="btn btn-block bg-l2" onclick="saveAddress(2)">Ø­ÙØ¸</button><button class="btn btn-block btn-outline mt-2" onclick="closeModal(2, 'address')">Ø¥Ù„ØºØ§Ø¡</button></div>
                    </div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l2" onclick="togglePresentation('mobile')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
            </div>
            <div class="admin-side">
                <div class="frame tablet" id="admin-frame-2">
                    <div class="toast-container" id="admin-toast-2"></div> <!-- NEW TOAST CONTAINER -->
                    <!-- CONTENT GENERATED BY JS -->
                    <!-- MODALS will be injected here on renderAdminInterface -->
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l2" onclick="togglePresentation('tablet')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„</button></div>
            </div>
        </div>
    </div>

    <!-- LEVEL 3 -->
    <div id="level-3" class="level-container">
        <div class="workspace">
            <div class="client-side">
                <div class="frame mobile">
                    <div class="toast-container" id="client-toast-3"></div> <!-- NEW TOAST CONTAINER -->
                    <div class="app-header"><span id="header-user-3">Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø²Ø§Ø¦Ø±</span><div class="flex-center gap-1"><button id="login-btn-3" class="btn btn-sm" style="background:rgba(255,255,255,0.2);border:1px solid currentColor" onclick="openLogin(3)">Ø¯Ø®ÙˆÙ„</button></div></div>
                    <!-- CATEGORY CHIPS ADDED HERE FOR L3 -->
                    <div class="app-body" id="body-3"></div>
                    <div class="app-nav">
                        <div class="nav-item active" onclick="nav(3, 'home')"><i class="fas fa-store"></i><span class="nav-label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
                        <div class="nav-item" onclick="nav(3, 'cart')"><i class="fas fa-shopping-basket" id="cart-icon-3"></i><span class="nav-label">Ø§Ù„Ø³Ù„Ø©</span><span id="badge-cart-3" class="badge hidden">0</span></div>
                        <div class="nav-item" onclick="nav(3, 'track')"><i class="fas fa-receipt"></i><span class="nav-label">ØªØªØ¨Ø¹</span></div>
                        <div class="nav-item" onclick="nav(3, 'notif')"><i class="fas fa-bell"></i><span class="nav-label">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span><span id="badge-notif-3" class="badge hidden">0</span></div>
                        <!-- CHANGED: Replaced Fav/About with Settings -->
                        <div class="nav-item" onclick="nav(3, 'settings')"><i class="fas fa-cog"></i><span class="nav-label">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
                    </div>
                    <div id="offline-3" class="offline-overlay"><i class="fas fa-store-slash closed-icon"></i><h3>Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚</h3><p class="muted">Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ Ù†Ø³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>
                    <div id="modal-product-3" class="modal-overlay">
                        <div class="toast-container" id="modal-toast-product-3"></div> <!-- NEW MODAL TOAST CONTAINER -->
                        <div class="modal-content">
                            <img id="mp-img-3" src="" style="width:100%;height:180px;object-fit:cover;border-radius:16px;margin-bottom:15px;background:#eee">
                            <div class="flex-between mb-2 mt-2"><h3 id="mp-name-3" style="font-size:1.4rem;margin:0"></h3><strong id="mp-price-3" class="text-l3" style="font-size:1.4rem">0 Ø¬.Ù…</strong></div>
                            <div class="small muted mb-4">Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
                            <select id="mp-weight-3" class="select" onchange="updateModalPrice(3)"><option value="0.25">Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ</option><option value="0.5">Ù†ØµÙ ÙƒÙŠÙ„Ùˆ</option><option value="1">ÙƒÙŠÙ„Ùˆ</option></select>
                            
                            <!-- NEW: Addons Container for L3 -->
                            <div class="card mt-2 mb-4" id="mp-addons-container-3" style="border:1px solid var(--l3); padding:12px;">
                                <h4 class="mb-2" style="font-size:1rem; color:var(--l3); font-weight:800;">Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ØªØ®ØµÙŠØµ:</h4>
                                <div id="mp-addons-3" style="display:flex; flex-direction:column; gap:8px;">
                                    <!-- Checkboxes will be injected here by JS -->
                                </div>
                            </div>
                            <!-- End NEW Addons -->

                            <div style="display:flex; gap:10px; margin-top:10px"><button class="btn btn-block bg-l3" style="flex:2" onclick="addToCartFromModal(3)">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button><button class="btn btn-block btn-outline" style="flex:1" onclick="closeModal(3, 'product')">Ø¥ØºÙ„Ø§Ù‚</button></div>
                        </div>
                    </div>
                    <div id="modal-login-3" class="modal-overlay">
                        <div class="toast-container" id="modal-toast-login-3"></div> <!-- NEW MODAL TOAST CONTAINER -->
                        <div class="modal-content">
                            <h3 class="center mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                            <input id="login-name-3" class="input" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø·Ù„ÙˆØ¨)">
                            <input id="login-phone-3" class="input" placeholder="Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù…Ø·Ù„ÙˆØ¨)">
                            <!-- NEW ADDRESS INPUT -->
                            <input id="login-addr-3" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨)">
                            <button class="btn btn-block bg-l3 mb-2" onclick="sendOtp(3)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</button>
                            <div id="otp-area-3" class="hidden">
                                <input id="otp-code-3" class="input" placeholder="Ø§Ù„Ø±Ù…Ø² (1234)">
                                <button class="btn btn-block bg-l3" onclick="verifyOtp(3)">ØªØ£ÙƒÙŠØ¯</button>
                            </div>
                            <button class="btn btn-block btn-outline mt-2" onclick="closeModal(3, 'login')">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                    <div id="modal-address-3" class="modal-overlay">
                        <div class="toast-container" id="modal-toast-address-3"></div> <!-- NEW MODAL TOAST CONTAINER -->
                        <div class="modal-content"><h3 class="center mb-4">Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</h3><input id="new-addr-3" class="input" placeholder="Ø§Ù„Ù…Ù†Ø²Ù„ - Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ..."><button class="btn btn-block bg-l3" onclick="saveAddress(3)">Ø­ÙØ¸</button><button class="btn btn-block btn-outline mt-2" onclick="closeModal(3, 'address')">Ø¥Ù„ØºØ§Ø¡</button></div>
                    </div>
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l3" onclick="togglePresentation('mobile')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
            </div>
            <div class="admin-side">
                <div class="frame tablet" id="admin-frame-3">
                    <div class="toast-container" id="admin-toast-3"></div> <!-- NEW TOAST CONTAINER -->
                    <!-- CONTENT GENERATED BY JS -->
                    <!-- MODALS will be injected here on renderAdminInterface -->
                </div>
                <div class="pres-btn-area"><button class="btn btn-sm btn-outline text-l3" onclick="togglePresentation('tablet')">ğŸ¬ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„</button></div>
            </div>
        </div>
    </div>
    
    <!-- Admin Invoice Modals (Moved inside admin-frame on render) -->
    <div id="modal-invoice-1" class="modal-overlay"><div class="modal-content" style="max-width:400px"><div id="invoice-content-1"></div></div></div>
    <div id="modal-invoice-2" class="modal-overlay"><div class="modal-content" style="max-width:400px"><div id="invoice-content-2"></div></div></div>
    <div id="modal-invoice-3" class="modal-overlay"><div class="modal-content" style="max-width:400px"><div id="invoice-content-3"></div></div></div>
    
    <!-- NEW: General Confirmation Modal (Moved inside admin-frame on render) -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="toast-container" id="modal-toast-confirm"></div> <!-- NEW MODAL TOAST CONTAINER -->
        <div class="modal-content" style="max-width:320px; text-align:center;">
            <h3 class="mb-4 text-danger">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p id="confirm-message" class="muted mb-6"></p>
            <div class="flex justify-around gap-4">
                <button id="confirm-cancel-btn" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirm-action-btn" class="btn btn-danger">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Order Rejection Modal -->
    <div id="modal-reject-order" class="modal-overlay">
        <div class="toast-container" id="modal-toast-reject"></div>
        <div class="modal-content" style="max-width:380px">
            <h3 class="center mb-4 text-danger">Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ #<span id="reject-order-id"></span></h3>
            <p class="muted small mb-4">ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¨Ø¨ ÙˆØ§Ø¶Ø­ Ù„Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¨Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„.</p>
            <input type="hidden" id="reject-order-target">
            
            <label for="reject-reason" class="small bold block mb-1">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</label>
            <select id="reject-reason" class="input select mb-4">
                <option value="Ù†ÙØ§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">Ù†ÙØ§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</option>
                <option value="Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØµÙŠÙ„">Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                <option value="Ø§Ù„Ù…Ø­Ù„ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹">Ø§Ù„Ù…Ø­Ù„ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹</option>
                <option value="Ø£Ø®Ø±Ù‰ (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ¶ÙŠØ­)">Ø£Ø®Ø±Ù‰ (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ¶ÙŠØ­)</option>
            </select>
            
            <textarea id="reject-note" class="textarea mb-4" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
            
            <div class="flex justify-between gap-3 mt-4">
                <button class="btn btn-outline" style="flex:1" onclick="closeModal('reject-order')">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-danger" style="flex:2" onclick="confirmReject()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Driver Assignment Modal (Moved inside admin-frame on render) -->
    <div id="modal-driver-assign-2" class="modal-overlay">
        <div class="toast-container" id="modal-toast-driver-assign-2"></div> <!-- NEW MODAL TOAST CONTAINER -->
        <div class="modal-content" style="max-width:400px">
            <h3 class="center mb-4 text-l2">ØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚ Ù„Ù„Ø·Ù„Ø¨ #<span id="assign-order-id-2"></span></h3>
            <p class="muted small mb-4">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ "ØªÙˆØµÙŠÙ„".</p>
            <input type="hidden" id="assign-order-target-2">
            
            <label for="driver-select-2" class="small bold block mb-1">Ø§Ø®ØªØ± Ø§Ù„Ø·ÙŠØ§Ø±:</label>
            <select id="driver-select-2" class="input select mb-4">
                <!-- Options populated by JS -->
            </select>
            
            <div class="flex justify-between gap-3 mt-4">
                <button class="btn btn-outline" style="flex:1" onclick="closeModal(2, 'driver-assign')">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn bg-l2" style="flex:2" onclick="assignDriver(2)">ØªØ¹ÙŠÙŠÙ† ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
            </div>
        </div>
    </div>
    <div id="modal-driver-assign-3" class="modal-overlay">
        <div class="toast-container" id="modal-toast-driver-assign-3"></div> <!-- NEW MODAL TOAST CONTAINER -->
        <div class="modal-content" style="max-width:400px">
            <h3 class="center mb-4 text-l3">ØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚ Ù„Ù„Ø·Ù„Ø¨ #<span id="assign-order-id-3"></span></h3>
            <p class="muted small mb-4">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ "ØªÙˆØµÙŠÙ„".</p>
            <input type="hidden" id="assign-order-target-3">
            
            <label for="driver-select-3" class="small bold block mb-1">Ø§Ø®ØªØ± Ø§Ù„Ø·ÙŠØ§Ø±:</label>
            <select id="driver-select-3" class="input select mb-4">
                <!-- Options populated by JS -->
            </select>
            
            <div class="flex justify-between gap-3 mt-4">
                <button class="btn btn-outline" style="flex:1" onclick="closeModal(3, 'driver-assign')">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn bg-l3" style="flex:2" onclick="assignDriver(3)">ØªØ¹ÙŠÙŠÙ† ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
            </div>
        </div>
    </div>
</div>

<script>
/* * 1. Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Toast/Banner)
 * ØªÙØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…Ø­Ù„.
 * Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø©ØŒ ØªÙØ¹ØªØ¨Ø± "Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©" ÙˆØªÙØ¹Ø±Ø¶ ÙÙŠ Ø£ÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¶ Ù†Ø´Ø·Ø©.
 */
const CLIENT_MSGS = [
    'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'Ø±Ù…Ø² Ø®Ø§Ø·Ø¦', 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©', 'Ø§Ù„Ù…ÙØ¶Ù„Ø©', 
    'Ù†Ù‚Ø§Ø·Ùƒ', 'Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶', 'Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…', 
    'Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø²Ø§Ø¦Ø±', 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©', 
    'ğŸ›‘ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨'
];
const ADMIN_MSGS = [
    'Ø§Ù„Ù…ØªØ¬Ø±', 'ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¦Ù‚', 'Ø­Ø°Ù Ø§Ù„Ø³Ø§Ø¦Ù‚', 'ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚', 
    'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚', 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ†',
    'ğŸ›‘ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø±', 'âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚',
    'âŒ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø§Ø¦Ù‚', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨', 'âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨', 'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨'
];


/* --- 2. BASE DATA --- */
// * FIX: ØªÙˆØ³ÙŠØ¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ 40 ØµÙ†ÙØ§Ù‹ Ù…ÙˆØ²Ø¹Ø© Ø¹Ù„Ù‰ Ø«Ù„Ø§Ø« ØªØµÙ†ÙŠÙØ§Øª (Ø´Ø±Ù‚ÙŠØŒ ØºØ±Ø¨ÙŠØŒ Ù…Ø´Ø±ÙˆØ¨Ø§Øª)
// * NEW: Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ modifiers Ù„ÙƒÙ„ Ù…Ù†ØªØ¬ (Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ØªØ®ØµÙŠØµ)
const baseProducts = [
    // Ø´Ø±Ù‚ÙŠ (Oriental) - 15 ØµÙ†Ù
    {id:1, name:'Ø·Ø¨Ù‚ Ø´Ø±Ù‚ÙŠ Ù…Ø´ÙƒÙ„', price:120, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Mix+Sweets', category:'Ø´Ø±Ù‚ÙŠ', badge:'Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹', modifiers: [
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©', price: 15 }, 
        { name: 'Ø´Ø±Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠ', price: 5 }, 
        { name: 'Ù‚Ø´Ø·Ø© Ø¨Ù„Ø¯ÙŠ', price: 20 }
    ]},
    {id:2, name:'ÙƒÙ†Ø§ÙØ© Ù†Ø§Ø¨Ù„Ø³ÙŠØ©', price:90, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Kunafa', category:'Ø´Ø±Ù‚ÙŠ', badge:'Ø­Ø§Ø±', modifiers: [
        { name: 'Ø¬Ø¨Ù†Ø© Ø¹ÙƒØ§ÙˆÙŠ Ø¥Ø¶Ø§ÙÙŠØ©', price: 20 }, 
        { name: 'ÙØ³ØªÙ‚ Ø­Ù„Ø¨ÙŠ', price: 10 }, 
        { name: 'Ø³ÙƒØ± Ø£Ù‚Ù„', price: 0 }
    ]},
    {id:3, name:'Ø¨Ø³Ø¨ÙˆØ³Ø© Ø¨Ø§Ù„Ù‚Ø´Ø·Ø©', price:80, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Basbousa', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'Ù‚Ø´Ø·Ø© Ø¥Ø¶Ø§ÙÙŠØ©', price: 15 }, 
        { name: 'Ø¨Ù†Ø¯Ù‚', price: 10 }, 
        { name: 'Ù„ÙˆØ²', price: 10 }
    ]},
    {id:4, name:'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù†', price:35, img:'https://placehold.co/400x300/F8FAFC/0F172A?text=Rice+Milk', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ… ÙØ§Ù†ÙŠÙ„ÙŠØ§', price: 10 }, 
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª', price: 5 }, 
        { name: 'Ø¹Ø³Ù„', price: 5 }
    ]},
    {id:5, name:'Ø²Ù„Ø§Ø¨ÙŠØ©', price:40, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Zalabia', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'ØµÙˆØµ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 8 }, 
        { name: 'Ø³ÙƒØ± Ø¨ÙˆØ¯Ø±Ø©', price: 5 }, 
        { name: 'Ù‚Ø±ÙØ©', price: 5 }
    ]},
    {id:6, name:'Ø£Ù… Ø¹Ù„ÙŠ', price:50, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Om+Ali', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'Ø­Ù„ÙŠØ¨ Ø¥Ø¶Ø§ÙÙŠ', price: 10 }, 
        { name: 'ÙØ³ØªÙ‚', price: 12 }, 
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª Ù…Ø´ÙƒÙ„Ø©', price: 15 }
    ]},
    {id:7, name:'Ø¨Ù„Ø­ Ø§Ù„Ø´Ø§Ù…', price:60, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Balah+Elsham', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'ÙƒØ±ÙŠÙ…Ø© Ø§Ù„ÙƒØ§Ø³ØªØ±Ø¯', price: 15 }, 
        { name: 'Ø´Ø±Ø¨Ø§Øª Ø®ÙÙŠÙ', price: 5 }, 
        { name: 'ØµÙˆØµ ÙƒØ±Ø§Ù…ÙŠÙ„', price: 10 }
    ]},
    {id:8, name:'Ø¨Ù‚Ù„Ø§ÙˆØ©', price:110, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Baklava', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'Ø­Ø´ÙˆØ© Ø¬ÙˆØ² Ø¥Ø¶Ø§ÙÙŠØ©', price: 15 }, 
        { name: 'Ø³Ù…Ù† Ø¨Ù„Ø¯ÙŠ', price: 10 }, 
        { name: 'ÙØ³ØªÙ‚ Ø¥Ø¶Ø§ÙÙŠ', price: 20 }
    ]},
    {id:9, name:'Ù‡Ø±ÙŠØ³Ø© Ø³Ø§Ø¯Ø©', price:70, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Harissa', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'Ø¬ÙˆØ² Ù‡Ù†Ø¯', price: 8 }, 
        { name: 'Ø²Ø¨ÙŠØ¨', price: 5 }, 
        { name: 'Ù„ÙˆØ²', price: 10 }
    ]},
    {id:10, name:'Ù‚Ø·Ø§ÙŠÙ Ø¨Ø§Ù„Ù‚Ø´Ø·Ø©', price:75, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Qatayef', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'ØµÙˆØµ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 10 }, 
        { name: 'Ù‚Ø´Ø·Ø© Ø¥Ø¶Ø§ÙÙŠØ©', price: 15 }, 
        { name: 'ÙØ³ØªÙ‚', price: 15 }
    ]},
    {id:11, name:'Ø¹Ø´ Ø§Ù„Ø¨Ù„Ø¨Ù„', price:130, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Ash+ElBolbol', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'ÙØ³ØªÙ‚ Ø¥Ø¶Ø§ÙÙŠ', price: 25 }, 
        { name: 'Ø´Ø±Ø¨Ø§Øª Ù‚Ù„ÙŠÙ„', price: 0 }, 
        { name: 'Ø²Ø¨Ø¯Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©', price: 10 }
    ]},
    {id:12, name:'Ù…Ø¯Ù„ÙˆÙ‚Ø©', price:95, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Madlouka', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'Ù‚Ø´Ø·Ø© Ø¨Ù„Ø¯ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©', price: 20 }, 
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª Ù…Ø´ÙƒÙ„Ø©', price: 15 }, 
        { name: 'Ø¹Ø³Ù„', price: 10 }
    ]},
    {id:13, name:'ÙƒÙ†Ø§ÙØ© Ø¨Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª', price:85, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Kunafa+Nuts', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©', price: 15 }, 
        { name: 'Ø³Ù…Ù† Ù†Ø¨Ø§ØªÙŠ', price: 5 }, 
        { name: 'Ø³ÙƒØ± Ø®ÙÙŠÙ', price: 0 }
    ]},
    {id:14, name:'Ø­Ù„Ø§ÙˆØ© Ø§Ù„Ø¬Ø¨Ù†', price:100, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Halawet+ElJibn', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'ÙØ³ØªÙ‚ Ù…Ø·Ø­ÙˆÙ†', price: 15 }, 
        { name: 'Ù…Ø§Ø¡ ÙˆØ±Ø¯ Ø¥Ø¶Ø§ÙÙŠ', price: 5 }, 
        { name: 'Ø³ÙƒØ± Ù‚Ù„ÙŠÙ„', price: 0 }
    ]},
    {id:15, name:'Ø£ØµØ§Ø¨Ø¹ Ø²ÙŠÙ†Ø¨', price:55, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Zeinab+Fingers', category:'Ø´Ø±Ù‚ÙŠ', modifiers: [
        { name: 'ØµÙˆØµ ÙØ§Ù†ÙŠÙ„ÙŠØ§', price: 8 }, 
        { name: 'Ø³ÙƒØ± Ø¥Ø¶Ø§ÙÙŠ', price: 5 }, 
        { name: 'Ø´Ø±Ø¨Ø§Øª Ø®ÙÙŠÙ', price: 0 }
    ]},
    
    // ØºØ±Ø¨ÙŠ (Western) - 15 ØµÙ†Ù
    {id:16, name:'ØªÙˆØ±ØªØ© Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price:220, img:'https://placehold.co/400x300/F8FAFC/334155?text=Choco+Cake', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ø·Ø¨Ù‚Ø© ÙƒØ±ÙŠÙ…Ø© Ø¥Ø¶Ø§ÙÙŠØ©', price: 30 }, 
        { name: 'ÙÙˆØ§ÙƒÙ‡ Ù…ÙˆØ³Ù…ÙŠØ©', price: 25 }, 
        { name: 'ØµÙˆØµ ÙƒØ±Ø§Ù…ÙŠÙ„', price: 15 }
    ]},
    {id:17, name:'ØªØ´ÙŠØ² ÙƒÙŠÙƒ ÙØ±Ø§ÙˆÙ„Ø©', price:75, img:'https://placehold.co/400x300/F8FAFC/EF4444?text=Cheesecake', category:'ØºØ±Ø¨ÙŠ', badge:'Ø¬Ø¯ÙŠØ¯', modifiers: [
        { name: 'ØµÙˆØµ ØªÙˆØª Ø¨Ø±ÙŠ', price: 15 }, 
        { name: 'ÙƒØ±ÙŠÙ…Ø© Ù…Ø®ÙÙˆÙ‚Ø©', price: 10 }, 
        { name: 'Ø¨Ø³ÙƒÙˆÙŠØª Ù…Ø·Ø­ÙˆÙ† Ø¥Ø¶Ø§ÙÙŠ', price: 8 }
    ]},
    {id:18, name:'Ø¬Ø§ØªÙˆÙ‡ Ø³ÙˆØ§Ø±ÙŠÙ‡', price:150, img:'https://placehold.co/400x300/F8FAFC/334155?text=Gateau', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'ØªØ®ØµÙŠØµ Ø§Ù„Ø£Ù„ÙˆØ§Ù†', price: 20 }, 
        { name: 'Ø¹Ù„Ø¨Ø© ÙØ§Ø®Ø±Ø©', price: 15 }, 
        { name: 'Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ© Ø¨ÙŠØ¶Ø§Ø¡', price: 15 }
    ]},
    {id:19, name:'ÙƒØ¨ ÙƒÙŠÙƒ ÙØ§Ù†ÙŠÙ„ÙŠØ§', price:30, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Cupcake', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ù‚Ø·Ø¹ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 5 }, 
        { name: 'Ø³ÙƒØ± Ù…Ù„ÙˆÙ†', price: 3 }, 
        { name: 'ÙƒØ±ÙŠÙ…Ø© Ø¥Ø¶Ø§ÙÙŠØ©', price: 7 }
    ]},
    {id:20, name:'Ù…ÙˆÙ„ØªÙ† ÙƒÙŠÙƒ', price:65, img:'https://placehold.co/400x300/F8FAFC/334155?text=Molten+Cake', category:'ØºØ±Ø¨ÙŠ', badge:'Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹', modifiers: [
        { name: 'Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ… ÙØ§Ù†ÙŠÙ„ÙŠØ§', price: 15 }, 
        { name: 'ØµÙˆØµ ØªÙˆØª', price: 10 }, 
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª', price: 10 }
    ]},
    {id:21, name:'ÙˆØ§ÙÙ„ Ù†ÙˆØªÙŠÙ„Ø§', price:55, img:'https://placehold.co/400x300/F8FAFC/334155?text=Waffle', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'ÙÙˆØ§ÙƒÙ‡ Ø·Ø§Ø²Ø¬Ø©', price: 15 }, 
        { name: 'Ù„ÙˆØªØ³', price: 12 }, 
        { name: 'Ø³ÙƒØ± Ø®ÙÙŠÙ', price: 0 }
    ]},
    {id:22, name:'Ø¨Ø§Ù† ÙƒÙŠÙƒ Ø¹Ø³Ù„', price:45, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Pancake', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª', price: 10 }, 
        { name: 'Ø¨ÙŠØ¶ Ù…Ø®ÙÙˆÙ‚ Ø¥Ø¶Ø§ÙÙŠ', price: 10 }, 
        { name: 'Ø­Ù„ÙŠØ¨ Ø®ÙÙŠÙ', price: 0 }
    ]},
    {id:23, name:'Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ… ÙØ³ØªÙ‚', price:40, img:'https://placehold.co/400x300/F8FAFC/15803D?text=Ice+Cream', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ù‚Ø·Ø¹ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 8 }, 
        { name: 'ØµÙˆØµ ÙƒØ±Ø§Ù…ÙŠÙ„', price: 8 }, 
        { name: 'ÙØ³ØªÙ‚ Ø¥Ø¶Ø§ÙÙŠ', price: 15 }
    ]},
    {id:24, name:'ÙƒÙˆÙƒÙŠØ² Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price:25, img:'https://placehold.co/400x300/F8FAFC/334155?text=Cookies', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ù…Ù„Ø­ Ø¨Ø­Ø±ÙŠ', price: 5 }, 
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª', price: 5 }, 
        { name: 'Ø¯Ø§Ø±Ùƒ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 8 }
    ]},
    {id:25, name:'Ù…Ø§ÙƒØ±ÙˆÙ† Ù…Ø´ÙƒÙ„', price:80, img:'https://placehold.co/400x300/F8FAFC/EF4444?text=Macaron', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'ØªØºÙ„ÙŠÙ Ù‡Ø¯Ø§ÙŠØ§', price: 15 }, 
        { name: 'Ù†ÙƒÙ‡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©', price: 20 }, 
        { name: 'ÙƒØ±ÙŠÙ…Ø© Ù„ÙŠÙ…ÙˆÙ†', price: 10 }
    ]},
    {id:26, name:'ÙƒÙŠÙƒ Ø±Ø¯ ÙÙ„ÙØª', price:250, img:'https://placehold.co/400x300/F8FAFC/DC2626?text=Red+Velvet', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'ÙƒØ±ÙŠÙ…Ø© Ø¬Ø¨Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ©', price: 35 }, 
        { name: 'ÙƒØ±Ø² Ø·Ø§Ø²Ø¬', price: 20 }, 
        { name: 'Ø´ÙƒÙ„ Ø®Ø§Øµ', price: 25 }
    ]},
    {id:27, name:'Ø¨Ø±Ø§ÙˆÙ†ÙŠØ²', price:40, img:'https://placehold.co/400x300/F8FAFC/334155?text=Brownie', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ù…Ø§Ø±Ø´Ù…ÙŠÙ„Ùˆ', price: 10 }, 
        { name: 'ØµÙˆØµ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 8 }, 
        { name: 'Ø¹ÙŠÙ† Ø¬Ù…Ù„', price: 12 }
    ]},
    {id:28, name:'ØªÙŠØ±Ø§Ù…ÙŠØ³Ùˆ', price:90, img:'https://placehold.co/400x300/F8FAFC/0F172A?text=Tiramisu', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ø¨ÙˆØ¯Ø±Ø© ÙƒØ§ÙƒØ§Ùˆ Ø¥Ø¶Ø§ÙÙŠØ©', price: 5 }, 
        { name: 'Ø¨Ø³ÙƒÙˆÙŠØª Ø¥Ø¶Ø§ÙÙŠ', price: 10 }, 
        { name: 'Ø³ÙƒØ± Ø£Ù‚Ù„', price: 0 }
    ]},
    {id:29, name:'Ø§ÙƒÙ„ÙŠØ± Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price:50, img:'https://placehold.co/400x300/F8FAFC/334155?text=Eclair', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'ÙƒØ±ÙŠÙ…Ø© Ø§Ù„ÙØ§Ù†ÙŠÙ„ÙŠØ§', price: 10 }, 
        { name: 'ØµÙˆØµ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ© Ø¨ÙŠØ¶Ø§Ø¡', price: 10 }, 
        { name: 'Ø¨Ù†Ø¯Ù‚', price: 12 }
    ]},
    {id:30, name:'Ø¯ÙˆÙ†Ø§Øª', price:25, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Donut', category:'ØºØ±Ø¨ÙŠ', modifiers: [
        { name: 'Ø³ÙƒØ± Ø®ÙÙŠÙ', price: 0 }, 
        { name: 'Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 8 }, 
        { name: 'Ø­Ø´ÙˆØ© ÙƒØ±ÙŠÙ…Ø©', price: 10 }
    ]},

    // Ù…Ø´Ø±ÙˆØ¨Ø§Øª (Drinks) - 10 Ø£ØµÙ†Ø§Ù
    {id:31, name:'Ø¹ØµÙŠØ± Ù…Ø§Ù†Ø¬Ùˆ', price:35, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Mango', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ø«Ù„Ø¬ Ù…Ø¬Ø±ÙˆØ´ Ø¥Ø¶Ø§ÙÙŠ', price: 5 }, 
        { name: 'Ø³ÙƒØ± Ø®ÙÙŠÙ', price: 0 }, 
        { name: 'Ù‚Ø·Ø¹ ÙÙˆØ§ÙƒÙ‡', price: 10 }
    ]},
    {id:32, name:'Ù‚Ù‡ÙˆØ© ØªØ±ÙƒÙŠ', price:20, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Coffee', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ø­Ù„ÙŠØ¨', price: 5 }, 
        { name: 'Ø³ÙƒØ± Ø¥Ø¶Ø§ÙÙŠ', price: 3 }, 
        { name: 'Ù‡ÙŠÙ„', price: 5 }
    ]},
    {id:33, name:'Ù„Ø§ØªÙŠÙ‡ Ù…Ø«Ù„Ø¬', price:45, img:'https://placehold.co/400x300/F8FAFC/0369A1?text=Iced+Latte', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', badge:'Ø¬Ø¯ÙŠØ¯', modifiers: [
        { name: 'Ø­Ù„ÙŠØ¨ Ø§Ù„Ù„ÙˆØ²', price: 10 }, 
        { name: 'Ø´ÙˆØª Ø¥Ø³Ø¨Ø±ÙŠØ³Ùˆ Ø¥Ø¶Ø§ÙÙŠ', price: 15 }, 
        { name: 'ØµÙˆØµ ÙƒØ±Ø§Ù…ÙŠÙ„', price: 8 }
    ]},
    {id:34, name:'Ø´Ø§ÙŠ ÙƒØ±Ùƒ', price:25, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Karak+Tea', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ø²Ù†Ø¬Ø¨ÙŠÙ„', price: 5 }, 
        { name: 'Ø­Ù„ÙŠØ¨ Ù…ÙƒØ«Ù', price: 10 }, 
        { name: 'Ø³ÙƒØ± Ø®ÙÙŠÙ', price: 0 }
    ]},
    {id:35, name:'Ø³Ø­Ù„Ø¨', price:30, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Sahlab', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ù…ÙƒØ³Ø±Ø§Øª', price: 8 }, 
        { name: 'Ø¬ÙˆØ² Ù‡Ù†Ø¯', price: 5 }, 
        { name: 'Ù‚Ø±ÙØ©', price: 5 }
    ]},
    {id:36, name:'Ù‚Ù‡ÙˆØ© ÙØ±Ù†Ø³ÙŠØ©', price:35, img:'https://placehold.co/400x300/F8FAFC/78350F?text=French+Coffee', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ù†ÙƒÙ‡Ø© Ø§Ù„Ø¨Ù†Ø¯Ù‚', price: 8 }, 
        { name: 'Ø­Ù„ÙŠØ¨ Ø¥Ø¶Ø§ÙÙŠ', price: 5 }, 
        { name: 'Ø³ÙƒØ± Ø®ÙÙŠÙ', price: 0 }
    ]},
    {id:37, name:'Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„', price:30, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Orange+Juice', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ø«Ù„Ø¬ Ø¥Ø¶Ø§ÙÙŠ', price: 5 }, 
        { name: 'Ù‚Ø·Ø¹ ÙÙˆØ§ÙƒÙ‡', price: 8 }, 
        { name: 'Ø³ÙƒØ± Ø£Ù‚Ù„', price: 0 }
    ]},
    {id:38, name:'Ù…ÙŠÙ„Ùƒ Ø´ÙŠÙƒ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price:55, img:'https://placehold.co/400x300/F8FAFC/334155?text=Milkshake', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'ÙƒØ±ÙŠÙ…Ø© Ù…Ø®ÙÙˆÙ‚Ø©', price: 10 }, 
        { name: 'Ù‚Ø·Ø¹ Ø¨Ø³ÙƒÙˆÙŠØª', price: 8 }, 
        { name: 'ØµÙˆØµ ÙØ±Ø§ÙˆÙ„Ø©', price: 8 }
    ]},
    {id:39, name:'Ù…ÙˆÙƒØ§ Ø³Ø§Ø®Ù†', price:40, img:'https://placehold.co/400x300/F8FAFC/78350F?text=Mocha', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ø­Ù„ÙŠØ¨ Ø§Ù„Ù„ÙˆØ²', price: 10 }, 
        { name: 'ÙƒØ±ÙŠÙ…Ø©', price: 10 }, 
        { name: 'Ø´ÙˆØª Ø¥Ø³Ø¨Ø±ÙŠØ³Ùˆ Ø¥Ø¶Ø§ÙÙŠ', price: 15 }
    ]},
    {id:40, name:'Ø³ÙˆØ¨ÙŠØ§', price:20, img:'https://placehold.co/400x300/F8FAFC/F59E0B?text=Sobya', category:'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', modifiers: [
        { name: 'Ø³ÙƒØ± Ø£Ù‚Ù„', price: 0 }, 
        { name: 'ÙØ§Ù†ÙŠÙ„ÙŠØ§', price: 5 }, 
        { name: 'Ø«Ù„Ø¬ Ø¥Ø¶Ø§ÙÙŠ', price: 5 }
    ]}
];

const l3Offers = [
    {id:1, title:'Ø®ØµÙ… 10 Ø¬.Ù…', pts:20, type:'discount', val:10}, 
    {id:2, title:'Ø®ØµÙ… 20 Ø¬.Ù…', pts:40, type:'discount', val:20}, 
    {id:3, title:'ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ', pts:50, type:'discount', val:30},
    {id:4, title:'Ù‚Ù‡ÙˆØ© Ù…Ø¬Ø§Ù†Ø§Ù‹', pts:30, type:'item', val:20}, 
    {id:5, title:'ÙƒØ¨ ÙƒÙŠÙƒ Ù‡Ø¯ÙŠØ©', pts:60, type:'item', val:11}, 
    {id:6, title:'Ø®ØµÙ… 10%', pts:100, type:'discount', val:50}, 
    {id:7, title:'Ø·Ø¨Ù‚ Ø£Ù… Ø¹Ù„ÙŠ', pts:120, type:'item', val:7}, 
    {id:8, title:'Ù†ØµÙ ÙƒÙŠÙ„Ùˆ Ù…Ø´ÙƒÙ„', pts:300, type:'item', val:1}, 
    {id:9, name:'ØªÙˆØ±ØªØ© Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯', pts:800, type:'item', val:3},
    {id:10, name:'Ø¨ÙˆÙƒØ³ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', pts:500, type:'item', val:16}
];

// MODIFIED: Added totalRatings and ratingsCount to dummy customers for Admin analytics
const dummyCustomers = [
    {name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', phone: '01012345678', orders: 12, total: 3500, totalRatings: 50, ratingsCount: 12}, 
    {name: 'Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ', phone: '01198765432', orders: 5, total: 850, totalRatings: 25, ratingsCount: 5},
    {name: 'Ù…Ø­Ù…ÙˆØ¯ Ø­Ø³Ù†', phone: '01234567890', orders: 23, total: 6200, totalRatings: 92, ratingsCount: 23}, 
    {name: 'Ù†ÙˆØ± Ø§Ù„Ø¯ÙŠÙ†', phone: '01555555555', orders: 2, total: 150, totalRatings: 8, ratingsCount: 2}
];

// NEW: Initial Driver Mock Data (Removed carDetails and set isEditing: false by default)
const initialDrivers = [
    { id: 'd1', name: 'ÙÙ‡Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹', phone: '966501234567', isEditing: false },
    { id: 'd2', name: 'Ù…Ø§Ø¬Ø¯ Ø§Ù„Ø·ÙŠØ§Ø±', phone: '966509876543', isEditing: false }
];

const getFreshMenu = () => JSON.parse(JSON.stringify(baseProducts.map(p=>({...p, active:true}))));

const db = {
    1: { menu: getFreshMenu(), cart: [], orders: [], storeOpen: true, adminUser: null, adminOrderTab: 'active', currentView: 'menu', currentCategory: 'Ø§Ù„ÙƒÙ„' }, // NEW: currentCategory
    // MODIFIED: Added drivers list to L2
    2: { menu: getFreshMenu(), cart: [], orders: [], user: {name: 'Ø²Ø§Ø¦Ø±', phone: null, totalRatings: 0, ratingsCount: 0}, addresses: ['Ø§Ù„Ù…Ù†Ø²Ù„ (Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ)', 'Ø§Ù„Ø¹Ù…Ù„ (Ø§Ù„ØªØ¬Ù…Ø¹)'], fav: [], notif: [], storeOpen: true, currentView: 'home', currentCategory: 'Ø§Ù„ÙƒÙ„', adminView: 'drivers', customers: JSON.parse(JSON.stringify(dummyCustomers)), adminUser: null, adminOrderTab: 'active', drivers: JSON.parse(JSON.stringify(initialDrivers)) }, // NEW: currentCategory
    // MODIFIED: Added drivers list to L3
    3: { menu: getFreshMenu(), cart: [], orders: [], user: {name: 'Ø²Ø§Ø¦Ø±', phone: null, totalRatings: 0, ratingsCount: 0}, addresses: ['Ø§Ù„Ù…Ù†Ø²Ù„ (Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ)'], fav: [], notif: [], storeOpen: true, points: 50, sales: 0, promo: null, currentView: 'home', currentCategory: 'Ø§Ù„ÙƒÙ„', adminView: 'drivers', customers: JSON.parse(JSON.stringify(dummyCustomers)), activeDiscount: null, adminUser: null, adminOrderTab: 'active', drivers: JSON.parse(JSON.stringify(initialDrivers)) } // NEW: currentCategory
};

const CATEGORIES = ['Ø§Ù„ÙƒÙ„', 'Ø´Ø±Ù‚ÙŠ', 'ØºØ±Ø¨ÙŠ', 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª']; // NEW: Category list

let soundEnabled = true;
let activeModalData = null;
let activeLevel = 1;
let activeRatingOrderId = null; 
// NEW: Global variables for confirmation modal actions
let confirmActionCallback = null;
let confirmCancelCallback = null;
let confirmContext = null;

// NEW: Global var for reject modal
let activeRejectOrderId = null; 


/* --- 3. INIT --- */
function init() {
    // Attach event listeners for dynamic star rating UI on modals
    attachRatingListeners(2);
    attachRatingListeners(3);
    renderLevel(1);
    
    // NEW: Initialize confirmation modal listeners
    // Note: We move the listeners outside the rendered HTML to ensure they are bound correctly
    const confirmModal = document.getElementById('modal-confirm');
    const assignModal2 = document.getElementById('modal-driver-assign-2');
    const assignModal3 = document.getElementById('modal-driver-assign-3');

    if (confirmModal) {
        confirmModal.querySelector('#confirm-cancel-btn').onclick = () => { closeModal('confirm', 'modal'); if (confirmCancelCallback) confirmCancelCallback(); };
        confirmModal.querySelector('#confirm-action-btn').onclick = () => { closeModal('confirm', 'modal'); if (confirmActionCallback) confirmActionCallback(confirmContext); };
    }
    
    // Re-bind click listeners for other modals (just close action for safety)
    if (assignModal2) {
        assignModal2.querySelector('.btn-outline').onclick = () => closeModal(2, 'driver-assign');
    }
    if (assignModal3) {
        assignModal3.querySelector('.btn-outline').onclick = () => closeModal(3, 'driver-assign');
    }
    // Bind reject modal close
    document.querySelector('#modal-reject-order .btn-outline').onclick = () => closeModal('reject-order');
}

// NEW: Function to display custom confirmation modal
function showConfirmModal(message, actionCallback, context) {
    document.getElementById('confirm-message').textContent = message;
    confirmActionCallback = actionCallback;
    confirmContext = context;
    document.getElementById('modal-confirm').classList.add('open');
}

// NEW: Function to attach rating UI listeners
function attachRatingListeners(lvl) {
    // NOTE: This must be called when the rating page/modal is rendered, not just on init.
    // The elements are now part of the main body, so they are re-rendered often.
}

// NEW: Function to setup rating UI on the page body
function setupRatePageListeners(lvl) {
    const starsContainer = document.getElementById(`rating-stars-${lvl}`);
    if (!starsContainer) return;
    
    // Reverse order for visual (5 is first star)
    const stars = Array.from(starsContainer.querySelectorAll('.fa-star')).reverse();

    // Reset data attribute
    starsContainer.setAttribute('data-rating', '0');
    
    // Set up click/hover listeners dynamically
    stars.forEach((star, index) => {
        const ratingValue = index + 1;
        
        star.onclick = () => {
            setRating(lvl, ratingValue);
        };

        star.onmouseover = () => {
            setVisualRating(stars, ratingValue);
        };

        star.onmouseout = () => {
            // Restore actual rating on mouse out
            const currentRating = parseInt(starsContainer.getAttribute('data-rating') || 0);
            setVisualRating(stars, currentRating);
        };
    });
}

// NEW: Function to update visual stars
function setVisualRating(starsArray, rating) {
    starsArray.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('checked');
        } else {
            star.classList.remove('checked');
        }
    });
}

// NEW: Function to set actual rating value
function setRating(lvl, ratingValue) {
    const starsContainer = document.getElementById(`rating-stars-${lvl}`);
    if (!starsContainer) return;
    starsContainer.setAttribute('data-rating', ratingValue);
    
    const stars = Array.from(starsContainer.querySelectorAll('.fa-star')).reverse();
    setVisualRating(stars, ratingValue);
    
    playSound('pop');
    // Enable submit button if rating is set
    const submitBtn = document.getElementById(`rate-submit-${lvl}`);
    if(submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = `Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (${ratingValue} Ù†Ø¬ÙˆÙ…)`;
    }
}


/* --- 4. CORE & AUDIO --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (!soundEnabled) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;

    switch (type) {
        case 'success':
            osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
            break;
        case 'error':
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
            break;
        case 'click':
            osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
            osc.start(now); osc.stop(now + 0.05);
            break;
        case 'pop':
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
            break;
        case 'notify':
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.setValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.2, now + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
            break;
    }
}

function toggleTheme() { document.documentElement.classList.toggle('dark'); }
function toggleSound() { soundEnabled = !soundEnabled; showBanner(soundEnabled?'ğŸ”” Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„':'ğŸ”• ØµØ§Ù…Øª','general'); }
function togglePresentation(type) { 
    playSound('click');
    if (!type) {
        document.body.classList.remove('pres-active', 'pres-mobile', 'pres-tablet');
        showBanner('âŒ ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶', 'general');
    } else {
        document.body.classList.remove('pres-active', 'pres-mobile', 'pres-tablet');
        document.body.classList.add('pres-active');
        document.body.classList.add(type === 'mobile' ? 'pres-mobile' : 'pres-tablet');
        showBanner(type === 'mobile' ? 'ğŸ“± Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚' : 'ğŸª Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„', 'general');
    }
}

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Toast ÙÙŠ Ø­Ø§ÙˆÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
 * @param {string} msg - Ø§Ù„Ø±Ø³Ø§Ù„Ø©
 * @param {string} type - Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ('general', 'client', 'admin') Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
 * @param {string} containerId - Ù…ÙØ¹Ø±Ù Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Ù…Ø«Ù„ 'client-toast-1')
 */
function displayToast(msg, type, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    let icon = '';
    if (msg.includes('âŒ') || msg.includes('ğŸ›‘')) {
        icon = '<i class="fas fa-times-circle" style="color: var(--danger)"></i>';
    } else if (msg.includes('âœ…') || msg.includes('ğŸ') || msg.includes('â¤ï¸') || msg.includes('â­')) {
        icon = '<i class="fas fa-check-circle" style="color: var(--success)"></i>';
    } else if (msg.includes('âš ï¸')) {
        icon = '<i class="fas fa-exclamation-triangle" style="color: var(--accent)"></i>';
    } else if (msg.includes('ğŸ””') || msg.includes('ğŸ”•')) {
        icon = '<i class="fas fa-volume-up" style="color: var(--l2)"></i>';
    } else if (msg.includes('ğŸ“±') || msg.includes('ğŸª')) {
        icon = '<i class="fas fa-tv" style="color: var(--l3)"></i>';
    } else if (msg.includes('ğŸ”‘')) {
        icon = '<i class="fas fa-key" style="color: var(--l2)"></i>';
    } else {
         icon = '<i class="fas fa-info-circle" style="color: var(--muted)"></i>';
    }
    
    const toastElement = document.createElement('div');
    toastElement.className = 'toast';
    toastElement.innerHTML = `${icon} ${msg}`;
    
    container.prepend(toastElement); // Ø£Ø¶ÙÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

    setTimeout(() => {
        toastElement.classList.add('show');
    }, 10); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±Ø§Ù†Ø²ÙŠØ´Ù†

    setTimeout(() => {
        toastElement.classList.remove('show');
        // Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ø§Ù†Ø²ÙŠØ´Ù†ØŒ Ù‚Ù… Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ±
        setTimeout(() => {
            container.removeChild(toastElement);
        }, 300); 
    }, 3000); // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¸Ø§Ù‡Ø±Ø© Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†Ù
}


/**
 * Ø¯Ø§Ù„Ø© showBanner Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØµÙ„ Ø¨ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¹Ø±Ø¶.
 * @param {string} msg - Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡Ø§.
 * @param {string} [contextType='client'] - Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø°ÙŠ Ø£Ø·Ù„Ù‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ('client', 'admin', 'general').
 * @param {string} [modalId=null] - Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ®ØµÙ‡Ø§ (Ù…Ø«Ù„ 'modal-toast-login-2').
 */
function showBanner(msg, contextType = 'client', modalId = null) {
    const currentLevel = activeLevel;
    
    // 1. ØªØ­Ø¯ÙŠØ¯ ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
    const isClientMsg = CLIENT_MSGS.some(keyword => msg.includes(keyword));
    const isAdminMsg = ADMIN_MSGS.some(keyword => msg.includes(keyword));

    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    let finalType = 'general';
    if (contextType === 'client' || isClientMsg) {
        finalType = 'client';
    } else if (contextType === 'admin' || isAdminMsg) {
        finalType = 'admin';
    }

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø·
    const isPresMobile = document.body.classList.contains('pres-mobile');
    const isPresTablet = document.body.classList.contains('pres-tablet');
    const isPresActive = isPresMobile || isPresTablet;

    let targetContainerId = null;
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ®Øµ Ù…ÙˆØ¯Ø§Ù„ (Ù…Ø«Ù„ Login/Address)ØŒ Ø§Ø³ØªØ®Ø¯Ù… ID Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
    if (modalId) {
        targetContainerId = modalId;
    } 
    // --- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù‡Ø¯Ù Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
    else {
        // A. Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© (ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹)
        if (finalType === 'general') {
            if (isPresMobile || (currentLevel === 1 && !isPresActive)) {
                targetContainerId = `client-toast-${currentLevel}`;
            } else if (isPresTablet || (currentLevel > 1 && !isPresActive)) {
                targetContainerId = `admin-toast-${currentLevel}`;
            }
            // ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¯ÙˆÙ† Pres modeØŒ ÙŠØªÙ… Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¹Ø±Ø¶
            else if (!isPresActive && currentLevel <= 3) {
                targetContainerId = `client-toast-${currentLevel}`;
            }
        }
        // B. Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ (ØªØ¸Ù‡Ø± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
        else if (finalType === 'client') {
            targetContainerId = `client-toast-${currentLevel}`;
        }
        // C. Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ØªØ¸Ù‡Ø± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
        else if (finalType === 'admin' && currentLevel <= 3) { 
            targetContainerId = `admin-toast-${currentLevel}`;
        }
    }
    
    // --- Ø§Ù„Ø¹Ø±Ø¶ ---
    if (targetContainerId) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ Ù‡Ùˆ Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ø­Ø¯Ø© (Pres Mode)ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
        if (isPresActive && !modalId) { // Ù„Ø§ Ù†Ø·Ø¨Ù‚ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØµÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„
            const isClientTarget = targetContainerId.startsWith('client-toast');
            
            // ØªØ¬Ø§Ù‡Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ù„ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ ÙˆØ§Ù„Ø¹ÙƒØ³ ØµØ­ÙŠØ­
            if ((isClientTarget && isPresTablet) || (!isClientTarget && isPresMobile)) {
                 return; 
            }
        }
        
        displayToast(msg, finalType, targetContainerId);
    }
}


// FIX: Making switchLevel global
window.switchLevel = function (lvl) {
    playSound('click');
    activeLevel = lvl;
    document.querySelectorAll('.level-container').forEach(el => el.classList.remove('active'));
    document.getElementById(`level-${lvl}`).classList.add('active');
    document.querySelectorAll('.lvl-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.lvl-btn[data-lvl="${lvl}"]`).classList.add('active');
    renderLevel(lvl);
    showBanner(`ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${lvl}`, 'general');
};

function nav(lvl, view) {
    playSound('click');
    if(lvl === 1) {
        db[lvl].currentView = view; // FIX: Set current view for Level 1
        if(view === 'menu') renderClientL1(db[1]);
        else if(view === 'cart') renderCartL1();
        else if(view === 'settings') renderSettingsL1();
        
        document.querySelectorAll('#level-1 .nav-item').forEach(el => el.classList.remove('active'));
        if(view === 'menu') document.querySelectorAll('#level-1 .nav-item')[0].classList.add('active');
        if(view === 'cart') document.querySelectorAll('#level-1 .nav-item')[1].classList.add('active');
        if(view === 'settings') document.querySelectorAll('#level-1 .nav-item')[2].classList.add('active');
    } else {
        db[lvl].currentView = view;
        renderClientApp(lvl);
        const icons = document.querySelectorAll(`#level-${lvl} .nav-item`);
        icons.forEach(el => el.classList.remove('active'));
        const map = {'home':0, 'cart':1, 'track':2, 'notif':3, 'settings': 4};
        if(map[view] !== undefined && icons[map[view]]) icons[map[view]].classList.add('active');
    }
}
function setAdminTab(lvl, tab, btn) {
    playSound('click');
    db[lvl].adminView = tab;
    const parent = btn.parentElement;
    Array.from(parent.children).forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderAdminPanel(lvl);
}

// NEW: Function to handle category filtering
function filterByCategory(lvl, category) {
    playSound('click');
    db[lvl].currentCategory = category;
    if (lvl === 1) {
        renderClientL1(db[1]);
    } else {
        renderClientApp(lvl);
    }
}

/* --- 5. RENDER LOGIC --- */
function renderLevel(lvl) {
    // Sync Store Toggle State UI (Handle if element exists)
    const storeToggle = document.getElementById(`store-check-${lvl}`);
    const storeText = document.getElementById(`store-status-text-${lvl}`);
    if (storeToggle) {
        storeToggle.checked = db[lvl].storeOpen;
        storeText.textContent = db[lvl].storeOpen ? 'Ù…ÙØªÙˆØ­' : 'Ù…ØºÙ„Ù‚';
    }

    // FIX: Update L1 Store Badge
    if (lvl === 1) {
        const badge = document.getElementById('store-badge-1');
        if (badge) {
            badge.textContent = db[1].storeOpen ? 'Ù…ÙØªÙˆØ­' : 'Ù…ØºÙ„Ù‚';
            badge.style.background = db[1].storeOpen ? 'rgba(22, 163, 74, 0.2)' : 'rgba(220, 38, 38, 0.2)';
            badge.style.color = db[1].storeOpen ? 'var(--success)' : 'var(--danger)';
        }
        // Use db[1].currentView to render the correct page
        if(db[1].currentView === 'settings') renderSettingsL1();
        else if(db[1].currentView === 'cart') renderCartL1();
        else renderClientL1(db[1]); 
    } else {
        renderClientApp(lvl);
    }
    
    // Unified Admin Render Logic
    renderAdminInterface(lvl);
    
    updateCounts(lvl);
    document.getElementById(`offline-${lvl}`).classList.toggle('active', !db[lvl].storeOpen);
}

// --- NEW ADMIN AUTH & RENDERERS ---
function renderAdminInterface(lvl) {
    const frameId = `admin-frame-${lvl}`;
    const frame = document.getElementById(frameId);
    if (!frame) return;

    const d = db[lvl];
    const user = d.adminUser;
    
    // --- 1. LOGIN SCREEN ---
    if (!user) {
        frame.innerHTML = `
            <div class="toast-container" id="admin-toast-${lvl}"></div> <!-- NEW TOAST CONTAINER -->
            <div class="app-header">
                <span>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
            </div>
            <div class="app-body flex-center" style="flex-direction:column; background:var(--bg)">
                <div class="card p-4" style="width:100%; max-width:320px; text-align:center">
                    <div style="font-size:3rem; margin-bottom:10px">ğŸ”</div>
                    <h3 class="mb-4">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­Ù„</h3>
                    <input id="admin-name-${lvl}" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" style="text-align:center">
                    <select id="admin-role-${lvl}" class="select" style="text-align:center">
                        <option value="admin">Ù…Ø¯ÙŠØ± (Admin)</option>
                        <option value="cashier">ÙƒØ§Ø´ÙŠØ± (Cashier)</option>
                    </select>
                    <button class="btn btn-block bg-l${lvl} mt-2" onclick="adminLogin(${lvl})">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                </div>
            </div>
        `;
        return;
    }

    // --- 2. DASHBOARD SCREEN (LOGGED IN) ---
    const isAdmin = user.role === 'admin';
    const title = lvl === 1 ? 'KDS (Ø§Ù„Ù…Ø·Ø¨Ø®)' : (lvl === 2 ? 'ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª' : 'Dashboard');
    
    let headerActions = `
        <div style="display:flex;align-items:center;gap:8px;direction:ltr">
            <button class="btn btn-sm btn-danger" style="padding:4px 8px;font-size:0.7rem" onclick="adminLogout(${lvl})">Ø®Ø±ÙˆØ¬</button>
            <span class="small bold text-l${lvl}">${user.name} (${user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'ÙƒØ§Ø´ÙŠØ±'})</span>
            ${isAdmin ? `<span class="text-gray-300">|</span> <span id="store-status-text-${lvl}" class="toggle-label">${d.storeOpen ? 'Ù…ÙØªÙˆØ­' : 'Ù…ØºÙ„Ù‚'}</span><label class="switch"><input type="checkbox" id="store-check-${lvl}" ${d.storeOpen ? 'checked' : ''} onchange="toggleStore(${lvl})"><span class="slider"></span></label>` : ''}
        </div>
    `;

    // Tabs for Order Section
    const activeTab = d.adminOrderTab || 'active';
    const orderTabsHTML = `
        <div class="order-tabs">
            <button class="order-tab-btn ${activeTab === 'active' ? 'active' : ''}" onclick="setAdminOrderTab(${lvl}, 'active')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
            <button class="order-tab-btn ${activeTab === 'history' ? 'active' : ''}" onclick="setAdminOrderTab(${lvl}, 'history')">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
    `;
    
    let leftColumnContent = '';
    let rightColumnContent = '';

    if (lvl === 1) { // L1 KDS is mostly orders
        leftColumnContent = `
            <div style="flex:2;overflow-y:auto;padding-right:10px;min-height:0;display:flex;flex-direction:column">
                ${orderTabsHTML}
                <div id="orders-list-1" class="orders-stack" style="flex:1;overflow-y:auto"></div>
            </div>
            ${isAdmin ? `
            <div style="flex:1;border-right:1px solid var(--btn-default-bg);padding-right:16px;overflow-y:auto;min-height:0">
                <h4 class="mb-4 text-l1">Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h4>
                <div id="menu-list-1" style="display:flex;flex-direction:column;gap:8px"></div>
            </div>` : ''}
        `;
    } else { 
        // L2 & L3 Admin - RIGHT COLUMN for Management/Analytics, LEFT for orders
        
        // RIGHT COLUMN (Management Panel)
        if (isAdmin) {
            rightColumnContent = `
                <div style="flex:1.5;border-right:1px solid var(--btn-default-bg);padding-right:16px;display:flex;flex-direction:column;min-height:0">
                    <div class="admin-tabs">
                        <div class="admin-tab ${d.adminView === (lvl===3?'analytics':'menu') ? 'active' : ''}" onclick="setAdminTab(${lvl}, '${lvl===3?'analytics':'menu'}', this)">${lvl===3?'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ğŸ“Š':'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'}</div>
                        <div class="admin-tab ${d.adminView === 'customers' ? 'active' : ''}" onclick="setAdminTab(${lvl}, 'customers', this)">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                        <!-- ADDED DRIVERS TAB -->
                        <div class="admin-tab ${d.adminView === 'drivers' ? 'active' : ''}" onclick="setAdminTab(${lvl}, 'drivers', this)">Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† ğŸï¸</div>
                        ${lvl===3 ? `<div class="admin-tab ${d.adminView === 'menu' ? 'active' : ''}" onclick="setAdminTab(3, 'menu', this)">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>` : ''}
                    </div>
                    <div id="admin-panel-${lvl}" style="flex:1;overflow-y:auto"></div>
                </div>
            `;
        }
        
        // LEFT COLUMN: Orders
        leftColumnContent = `
            <div style="flex:1;overflow-y:auto;padding-right:10px;min-height:0;display:flex;flex-direction:column">
                ${orderTabsHTML}
                <div id="orders-list-${lvl}" class="orders-stack" style="flex:1;overflow-y:auto"></div>
            </div>
        `;
    }

    // MODIFIED HTML STRUCTURE: Admin orders moved to the left side in L2/L3
    frame.innerHTML = `
        <div class="toast-container" id="admin-toast-${lvl}"></div> <!-- NEW TOAST CONTAINER -->
        <div class="app-header">
            <span>${title}</span>
            ${headerActions}
        </div>
        <div class="app-body" style="flex-direction:row;gap:20px;background:var(--card-bg)">
            ${lvl === 1 ? leftColumnContent : `
                <!-- L2/L3 Structure: Right column for management/analytics, Left for orders -->
                ${rightColumnContent}
                ${leftColumnContent}
            `}
        </div>
    `;

    // Inject Modals into the Frame for local scope/containment
    const modalsContainer = document.createElement('div');
    modalsContainer.innerHTML = `
        <!-- MODALS INJECTED HERE -->
        <div id="modal-invoice-${lvl}" class="modal-overlay">
            <div class="modal-content" style="max-width:400px">
                <div id="invoice-content-${lvl}"></div>
            </div>
        </div>
        <div id="modal-driver-assign-${lvl}" class="modal-overlay">
            <div class="toast-container" id="modal-toast-driver-assign-${lvl}"></div> <!-- NEW MODAL TOAST CONTAINER -->
            <div class="modal-content" style="max-width:400px">
                <h3 class="center mb-4 text-l${lvl === 2 ? '2' : '3'}">ØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚ Ù„Ù„Ø·Ù„Ø¨ #<span id="assign-order-id-${lvl}"></span></h3>
                <p class="muted small mb-4">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ "ØªÙˆØµÙŠÙ„".</p>
                <input type="hidden" id="assign-order-target-${lvl}">
                
                <label for="driver-select-3" class="small bold block mb-1">Ø§Ø®ØªØ± Ø§Ù„Ø·ÙŠØ§Ø±:</label>
                <select id="driver-select-${lvl}" class="input select mb-4">
                    <!-- Options populated by JS -->
                </select>
                
                <div class="flex justify-between gap-3 mt-4">
                    <button class="btn btn-outline" style="flex:1" onclick="closeModal('${lvl}', 'driver-assign')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="btn bg-l${lvl}" style="flex:2" onclick="assignDriver(${lvl})">ØªØ¹ÙŠÙŠÙ† ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
                </div>
            </div>
        </div>
        <div id="modal-confirm" class="modal-overlay">
            <div class="toast-container" id="modal-toast-confirm"></div> <!-- NEW MODAL TOAST CONTAINER -->
            <div class="modal-content" style="max-width:320px; text-align:center;">
                <h3 class="mb-4 text-danger">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <p id="confirm-message" class="muted mb-6"></p>
                <div class="flex justify-around gap-4">
                    <button id="confirm-cancel-btn" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="btn btn-danger" id="confirm-action-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    `;
    frame.appendChild(modalsContainer);


    // Populate Data after generating HTML structure
    if (lvl === 1) renderAdminL1List();
    else renderAdminAppList(lvl);
}

function adminLogin(lvl) {
    const name = document.getElementById(`admin-name-${lvl}`).value;
    const role = document.getElementById(`admin-role-${lvl}`).value;
    const toastId = `admin-toast-${lvl}`;
    
    // * FIX: ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø·Ø£ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ù„.
    if (!name.trim()) { 
        playSound('error'); 
        return showBanner('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'admin', toastId); 
    }
    
    db[lvl].adminUser = { name, role };
    playSound('success');
    renderAdminInterface(lvl);
}

function adminLogout(lvl) {
    db[lvl].adminUser = null;
    playSound('click');
    renderAdminInterface(lvl);
}

function setAdminOrderTab(lvl, tab, btn) {
    playSound('click');
    db[lvl].adminOrderTab = tab;
    // We already re-render the whole panel on tab click via renderAdminInterface
    renderAdminInterface(lvl); 
}

// Renamed internal render functions to avoid confusion and called by renderAdminInterface
function renderAdminL1List() {
    const d = db[1];
    const listEl = document.getElementById('orders-list-1');
    if (listEl) {
        const tab = d.adminOrderTab || 'active';
        const filteredOrders = d.orders.filter(o => tab === 'active' ? (o.status !== 'done' && o.status !== 'cancelled') : (o.status === 'done' || o.status === 'cancelled'));
        
        listEl.innerHTML = filteredOrders.length > 0 
            ? filteredOrders.map(o => generateOrderCardHTML(1, o)).join('') 
            : `<p class="muted center">${tab === 'active' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ©' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù„Ø·Ù„Ø¨Ø§Øª'}</p>`;
    }
    const menuEl = document.getElementById('menu-list-1');
    if (menuEl) {
        menuEl.innerHTML = d.menu.map(p => `
            <div class="flex-between card mb-1" style="padding:8px">
                <span class="small bold">${p.name}</span>
                <label class="switch">
                    <input type="checkbox" ${p.active?'checked':''} onchange="toggleProduct(1, ${p.id})">
                    <span class="slider"></span>
                </label>
            </div>
        `).join('');
    }
}

function renderAdminAppList(lvl) {
    const d = db[lvl];
    const listEl = document.getElementById(`orders-list-${lvl}`);
    if (listEl) {
        const tab = d.adminOrderTab || 'active';
        // NEW: Filter by cancelled status
        const filteredOrders = d.orders.filter(o => tab === 'active' ? (o.status !== 'done' && o.status !== 'cancelled') : (o.status === 'done' || o.status === 'cancelled'));
        
        listEl.innerHTML = filteredOrders.length > 0 
            ? filteredOrders.map(o => generateOrderCardHTML(lvl, o)).join('') 
            : `<p class="muted center">${tab === 'active' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ©' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù„Ø·Ù„Ø¨Ø§Øª'}</p>`;
    }
    renderAdminPanel(lvl);
}

function generateOrderCardHTML(lvl, o) {
    // NEW: Include cancelled status in status map
    const isCancelled = o.status === 'cancelled';
    const isCompleted = o.status === 'done';
    
    // Disable buttons if cancelled or done
    const isDisabled = isCancelled || isCompleted ? 'disabled' : '';
    
    // NEW: Display rating in admin ticket
    const ratingHtml = o.rated ? `
        <span class="small bold" style="color:var(--accent); margin-right: 10px;">
            ${o.rating} â­
        </span>` : '';
        
    // NEW: Display assigned driver
    const driverInfo = o.driverName ? `
        <span class="small bold text-l${lvl}" style="margin-right: 10px;">
             ğŸï¸ ${o.driverName}
        </span>` : '';
        
    // NEW: Display rejection reason if cancelled
    const rejectReason = isCancelled ? `
        <div class="small text-danger mt-2">ğŸ›‘ Ø§Ù„Ø³Ø¨Ø¨: ${o.rejectReason}</div>
    ` : '';
    
    // * NEW: Display Addons in Admin Ticket
    const itemsWithAddons = o.items.map(item => {
        let itemHtml = `<div class="mt-item"><span>${item.name}</span><span>${item.weightLabel}</span></div>`;
        if (item.addons && item.addons.length > 0) {
            item.addons.forEach(addon => {
                itemHtml += `<div class="mt-item small muted" style="margin-right: 15px; margin-bottom: 0;">
                    <span>+ ${addon.name}</span>
                    <span style="font-weight: 500">+${addon.price} Ø¬.Ù…</span>
                </div>`;
            });
        }
        return itemHtml;
    }).join('');

    return `
    <div class="card modern-ticket st-${o.status}">
        <div class="mt-header">
            <span class="mt-id">#${o.id} - ${o.client}</span>
            <span class="mt-time">${o.time} ${ratingHtml} ${driverInfo}</span>
        </div>
        <div class="mt-body">
            ${itemsWithAddons} <!-- UPDATED to show addons -->
            ${o.note ? `<div class="small text-danger mt-2">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø¨: ${o.note}</div>` : ''}
            ${rejectReason}
            ${o.rated && o.feedback ? `<div class="small muted mt-2">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„: ${o.feedback}</div>` : ''}
        </div>
        <div class="mt-footer">
            <span class="mt-status status-${o.status}">
                ${isCancelled ? '<i class="fas fa-ban"></i>' : 
                  isCompleted ? '<i class="fas fa-check-circle"></i>' : 
                  o.status === 'new' ? '<i class="fas fa-bell"></i>' : 
                  o.status === 'prep' ? '<i class="fas fa-fire-burner"></i>' : 
                  '<i class="fas fa-motorcycle"></i>'}
                ${getStatusText(o.status)}
            </span>
            <div style="display:flex; gap:5px">
                <button class="btn btn-sm btn-outline" onclick="showInvoice(${lvl}, ${o.id})"><i class="fas fa-print"></i></button>
                ${!isCompleted && !isCancelled ? `<button class="btn btn-sm btn-danger" onclick="openRejectModal(${lvl}, ${o.id})" style="margin-right:5px">âŒ Ø±ÙØ¶</button>` : ''}
                <button class="btn btn-sm btn-update" onclick="nextStatus(${lvl}, ${o.id})" ${isDisabled}>ØªØ­Ø¯ÙŠØ«</button> <!-- FIX: Changed class to btn-update -->
            </div>
        </div>
    </div>`;
}

// Level 1 Specific
function renderClientL1(d) {
    
    // NEW: Render Category Chips
    const categoryChips = CATEGORIES.map(cat => `
        <div class="chip category ${d.currentCategory === cat ? 'active' : ''}" onclick="filterByCategory(1, '${cat}')">
            ${cat}
        </div>
    `).join('');
    
    // Filter products based on selected category
    const filteredProducts = d.menu.filter(p => p.active && (d.currentCategory === 'Ø§Ù„ÙƒÙ„' || p.category === d.currentCategory));
    
    document.getElementById('body-1').innerHTML = `
        <div class="category-chips">${categoryChips}</div>
        ${filteredProducts.map(p => `
            <div class="card product-card mb-2" onclick="openProductModal(1, ${p.id})" style="cursor:pointer">
                <img src="${p.img}" class="p-img" style="height:120px">
                <div class="p-info" style="padding:10px">
                    <div class="flex-between">
                        <div class="p-title" style="font-size:1rem;margin:0">${p.name}</div>
                        <div class="small bold text-l1">${p.price} Ø¬.Ù…</div>
                    </div>
                </div>
            </div>
        `).join('')}
    `;
}
function renderCartL1() {
    const d = db[1];
    const total = d.cart.reduce((s,i)=>s+i.finalPrice, 0);
    
    // * L1 Cart Item Display (Simple - no addons display logic needed here)
    const html = d.cart.length===0 ? '<p class="muted center">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>' : d.cart.map((item,i) => `
        <div class="card mb-2 flex-between">
            <div><div class="bold">${item.name}</div><div class="small muted">${item.weightLabel}</div></div>
            <div><div class="bold text-l1">${item.finalPrice} Ø¬.Ù…</div><button class="btn btn-sm btn-danger" onclick="removeFromCart(1, ${i})"><i class="fas fa-trash"></i></button></div>
        </div>
    `).join('');
    const form = d.cart.length>0 ? `
        <div class="card mt-4"><h4 class="mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
        <input id="guest-name-1" class="input" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø·Ù„ÙˆØ¨)">
        <input id="guest-phone-1" class="input" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
        <input id="guest-addr-1" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <textarea id="note-1" class="textarea" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
        <div class="flex-between mb-2 mt-2"><span class="bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><strong class="text-l1">${total} Ø¬.Ù…</strong></div>
        <button class="btn btn-block bg-l1" onclick="submitOrder(1)">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button></div>` : '';
    document.getElementById('body-1').innerHTML = `<h3 class="mb-4">Ø§Ù„Ø³Ù„Ø© (${d.cart.length})</h3>` + html + form;
}

function renderSettingsL1() {
    // Only About Us in L1 Settings
    document.getElementById('body-1').innerHTML = `
        <h3 class="mb-4">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <div class="card" onclick="renderAboutPage(1)" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-info-circle text-l1" style="font-size:1.2rem"></i>
            <span class="bold">Ù…Ù† Ù†Ø­Ù†</span>
            <i class="fas fa-chevron-left muted" style="margin-right:auto"></i>
        </div>
    `;
}

function renderAboutPage(lvl) {
    const body = document.getElementById(`body-${lvl}`);
    body.innerHTML = `
        <div class="flex-between mb-4">
             <button class="btn btn-sm btn-outline" onclick="nav(${lvl}, 'settings')"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button>
             <h3>Ù…Ù† Ù†Ø­Ù†</h3>
        </div>
        <div class="card center mb-4">
            <img src="https://placehold.co/600x400/F8FAFC/0F172A?text=Map+Location" style="width:100%;border-radius:12px;margin-bottom:15px">
            <h3 class="mb-2">Ø­Ù„ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©</h3>
            <p class="muted mb-4">Ù†Ù‚Ø¯Ù… Ø£Ø´Ù‡Ù‰ Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª Ø§Ù„Ø´Ø±Ù‚ÙŠØ© ÙˆØ§Ù„ØºØ±Ø¨ÙŠØ© Ø¨Ø£Ø¬ÙˆØ¯ Ø§Ù„Ø®Ø§Ù…Ø§Øª.</p>
            <div class="flex-between mb-2 w-full" style="padding:10px;background:var(--input-bg);border-radius:8px">
                <span><i class="fas fa-clock text-l1"></i> Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„</span>
                <strong>10 Øµ - 12 Øµ</strong>
            </div>
            <div class="flex-between mb-2 w-full" style="padding:10px;background:var(--input-bg);border-radius:8px">
                <span><i class="fas fa-phone text-l1"></i> Ø§Ù„Ù‡Ø§ØªÙ</span>
                <strong style="direction:ltr">01000000000</strong>
            </div>
            <a href="tel:01000000000" class="btn btn-block bg-l1 mt-2"><i class="fas fa-phone-alt"></i> Ø§ØªØµÙ„ Ø§Ù„Ø¢Ù†</a>
        </div>
    `;
}

// NEW: Function to render the full-screen rate order page
function renderRateOrder(lvl, oid) {
    const d = db[lvl];
    const o = d.orders.find(x => x.id === oid);
    const body = document.getElementById(`body-${lvl}`);
    
    if (!o || o.rated) {
        showBanner('âŒ ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
        nav(lvl, 'track');
        return;
    }
    
    activeRatingOrderId = oid;
    const color = lvl === 2 ? 'bg-l2' : 'bg-l3';
    
    const html = `
        <div class="flex-between mb-4" style="flex-shrink:0;">
             <button class="btn btn-sm btn-outline" onclick="nav(${lvl}, 'track')">ØªØ®Ø·ÙŠ</button>
             <h3>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ #${oid}</h3>
        </div>
        <div class="card" style="flex:1; display:flex; flex-direction:column; padding: 25px;">
            <p class="muted small text-center mb-4">Ø³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø®Ø¯Ù…Ø§ØªÙ†Ø§. ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø³Ø±ÙŠ.</p>
            
            <div id="rating-stars-${lvl}" class="rating flex-center mb-6" data-rating="0">
                <!-- Stars are reversed here for display in RTL -->
                <i class="fas fa-star" data-value="5"></i>
                <i class="fas fa-star" data-value="4"></i>
                <i class="fas fa-star" data-value="3"></i>
                <i class="fas fa-star" data-value="2"></i>
                <i class="fas fa-star" data-value="1"></i>
            </div>
            
            <textarea id="rate-feedback-${lvl}" class="textarea" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø£Ùˆ Ø´ÙƒÙˆØ§Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="flex:1; min-height: 100px;"></textarea>
            <button id="rate-submit-${lvl}" class="btn btn-block ${color} mt-4" onclick="submitRating(${lvl})">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        </div>
    `;
    
    body.innerHTML = html;
    
    // Deactivate nav items visually
    document.querySelectorAll(`#level-${lvl} .nav-item`).forEach(el => el.classList.remove('active'));

    // Setup the listeners on the newly rendered elements
    setupRatePageListeners(lvl);
    
    // Initial state setup
    const submitBtn = document.getElementById(`rate-submit-${lvl}`);
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
    }
}


// --- NEW SUCCESS PAGE RENDERER (Updated with Track Button & View Mode) ---
function renderSuccessPage(lvl, oid, isViewOnly = false) {
    const o = db[lvl].orders.find(x => x.id === oid);
    if (!o) return;

    const body = document.getElementById(`body-${lvl}`);
    
    // Determine Theme Colors based on level
    const themeColor = lvl === 1 ? 'var(--l1)' : lvl === 2 ? 'var(--l2)' : 'var(--l3)';
    const bgTheme = lvl === 1 ? 'bg-l1' : lvl === 2 ? 'bg-l2' : 'bg-l3';

    // Calculations for Invoice Display
    const subTotal = o.subTotal !== undefined ? o.subTotal : (o.total + (o.discountVal || 0));
    
    let discountDetailsHTML = '';
    if (o.discountVal > 0) {
        let discountLabel = 'Ø®ØµÙ… Ø®Ø§Øµ';
        if (o.discountType === 'percent') {
            discountLabel = `Ø®ØµÙ… (${o.discountRate}%)`;
        } else if (o.discountType === 'fixed') {
            discountLabel = `Ø®ØµÙ… (Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª)`;
        }
        discountDetailsHTML = `<div class="flex-between mb-1 text-success small"><strong>${discountLabel}:</strong> <span>-${o.discountVal} Ø¬.Ù…</span></div>`;
    }

    let giftInfo = '';
    if (o.gift) {
        giftInfo = `
        <div style="margin: 10px 0; padding: 10px; background: #FFF7ED; border: 1px dashed #F97316; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.2rem;">ğŸ</div>
            <div style="font-weight: bold; color: #9A3412; font-size:0.9rem">Ù‡Ø¯ÙŠØ©: ${o.gift}</div>
        </div>`;
    }

    const schedInfo = o.sched ? `<div class="mb-1 small"><strong>â° ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©:</strong> ${o.sched.replace('T', ' ')}</div>` : '';
    const noteInfo = o.note ? `<div class="mb-1 small"><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${o.note}</div>` : '';
    
    // NEW: Rating Display for order details
    const ratingInfo = o.rated ? `
        <div class="mb-1 small">
            <strong>ØªÙ‚ÙŠÙŠÙ…Ùƒ:</strong> 
            <span style="color: var(--accent); font-weight: 700;">${o.rating} â­</span>
            ${o.feedback ? `<span class="muted"> | ${o.feedback}</span>` : ''}
        </div>
    ` : '';

    // NEW: Driver Display for client's detailed tracking view
    const clientDriverInfo = (o.status === 'deliv' || o.status === 'done') && o.driverName ? `
        <div class="card p-3 mb-2 bg-l${lvl===2?'2':'3'}/10 border-l-4 border-l${lvl===2?'2':'3'}">
            <div class="small bold flex justify-between items-center">
                <span><i class="fas fa-motorcycle"></i> Ø§Ù„Ø·ÙŠØ§Ø±: ${o.driverName}</span>
                <a href="https://wa.me/966${o.driverPhone.replace(/[^\d]/g, '')}" target="_blank" class="text-l${lvl===2?'2':'3'} hover:text-l${lvl===2?'2':'3'}/80 font-bold" style="direction:ltr">
                    <i class="fab fa-whatsapp"></i> ØªÙˆØ§ØµÙ„
                </a>
            </div>
        </div>
    ` : '';
    
    // NEW: Cancelled Info
    const cancelledInfo = o.status === 'cancelled' ? `
        <div class="card p-3 mb-2 text-danger" style="border-left: 4px solid var(--danger); background: var(--danger-light);">
            <div class="small bold flex justify-between items-center">
                <span>ğŸ›‘ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</span>
            </div>
            <div class="small mt-1">Ø§Ù„Ø³Ø¨Ø¨: ${o.rejectReason}</div>
        </div>
    ` : '';
    

    // * MODIFIED: Build Items List HTML to include addons
    const itemsHTML = o.items.map(i => {
        let html = `
            <div class="flex-between" style="border-bottom:1px dashed #eee; padding-bottom:4px; margin-bottom:4px;">
                <span class="bold">${i.name} <small class="muted">(${i.weightLabel})</small></span>
                <span class="bold">${i.finalPrice} Ø¬.Ù…</span>
            </div>`;
        
        if (i.addons && i.addons.length > 0) {
            i.addons.forEach(addon => {
                html += `
                    <div class="flex-between small" style="margin-right: 10px; color:var(--muted); padding-bottom:4px;">
                        <span>+ ${addon.name}</span>
                        <span class="bold">+${addon.price} Ø¬.Ù…</span>
                    </div>
                `;
            });
        }
        return html;
    }).join('');

    // Conditional Header (Lottie vs Title)
    let headerHtml = '';
    if (!isViewOnly && o.status !== 'cancelled') {
        headerHtml = `
            <div style="text-align:center; margin-bottom:15px;">
                <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_u4yrau.json" background="transparent" speed="1" style="width:100px; height:100px; margin:0 auto;" loop="false" autoplay></lottie-player>
                <h2 style="font-size:1.6rem; color:var(--success); margin-top:-10px">ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                <p class="muted small">ÙŠØ±Ø¬Ù‰ ØªØµÙˆÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© ÙƒØ¥Ø«Ø¨Ø§Øª Ù„Ù„Ø·Ù„Ø¨</p>
            </div>
        `;
    } else {
        headerHtml = `
            <div style="text-align:center; margin-bottom:15px; margin-top:10px">
                <h3 class="text-l${lvl}">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #${oid}</h3>
            </div>
        `;
    }

    // Conditional Buttons
    let actionButtons = '';
    if (o.status === 'cancelled') {
        actionButtons += `<button class="btn btn-block ${bgTheme} mb-2" onclick="reOrder(${lvl}, ${oid})">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</button>`;
        actionButtons += `<button class="btn btn-block btn-outline" onclick="nav(${lvl}, 'track')">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>`;
    } else if (!isViewOnly) {
        // New Order Mode
        if (lvl > 1) {
            actionButtons += `<button class="btn btn-block btn-outline mb-2" onclick="nav(${lvl}, 'track')">ğŸšš ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</button>`;
        }
        actionButtons += `<button class="btn btn-block ${bgTheme}" onclick="nav(${lvl}, ${lvl===1 ? "'menu'" : "'home'"})">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>`;
    } else {
        // View History Mode
        // Re-order button is always available, but rate button appears if not rated AND status is done
        if (o.status === 'done' && !o.rated && lvl > 1) {
            // UPDATED: Use renderRateOrder instead of openRateModal
            actionButtons += `<button class="btn btn-block ${bgTheme} mb-2" onclick="renderRateOrder(${lvl}, ${oid})">â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>`;
        }
        
        actionButtons += `<button class="btn btn-block ${bgTheme} ${o.status !== 'done' && o.rated === undefined ? 'mt-2' : ''} mb-2" onclick="reOrder(${lvl}, ${oid})">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</button>`;
        actionButtons += `<button class="btn btn-block btn-outline" onclick="nav(${lvl}, 'track')">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>`;
    }

    body.innerHTML = `
        <div style="display:flex; flex-direction:column; height:100%; overflow-y:auto; padding:20px; animation: fadeIn 0.5s ease;">
            
            ${headerHtml}
            ${cancelledInfo}
            
            <!-- Full Invoice Card -->
            <div class="card" style="border:2px solid ${themeColor}; padding:20px; position:relative; flex:1; display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                
                <!-- Header -->
                <div style="text-align:center; border-bottom:2px dashed #eee; padding-bottom:15px; margin-bottom:10px;">
                    <h3 style="margin-bottom:5px;">Ø­Ù„ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©</h3>
                    <div class="small muted">${o.time} | ${new Date().toLocaleDateString('ar-EG')}</div>
                </div>

                <!-- Order ID Block (Prominent) -->
                <div style="text-align:center; background:${themeColor}; color:#fff; padding:10px; border-radius:12px; margin-bottom:10px;">
                    <div style="font-size:0.8rem; opacity:0.9;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Order ID</div>
                    <div style="font-size:2.5rem; font-weight:900; line-height:1;">#${oid}</div>
                </div>

                <!-- Customer Details -->
                <div class="small" style="background:var(--input-bg); padding:10px; border-radius:8px;">
                    <div class="flex-between mb-1"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span>${o.client}</span></div>
                    <div class="flex-between mb-1"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span>${o.phone||'-'}</span></div>
                    <div class="flex-between"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span style="max-width:70%; text-align:left">${o.addr||'-'}</span></div>
                </div>

                <!-- Extras -->
                ${schedInfo} ${noteInfo} ${giftInfo}
                ${ratingInfo} <!-- NEW: Show rating info -->
                ${clientDriverInfo} <!-- NEW: Show client driver info with WhatsApp -->

                <!-- Items List -->
                <div style="margin-top:10px;">
                    <h5 class="mb-2 border-bottom pb-1">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
                    ${itemsHTML}
                </div>

                <!-- Totals Section -->
                <div style="margin-top:auto; padding-top:15px; border-top:2px solid #eee;">
                    <div class="flex-between mb-1 small"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ</span><span>${subTotal} Ø¬.Ù…</span></div>
                    ${discountDetailsHTML}
                    <div class="flex-between bold" style="font-size:1.2rem; color:${themeColor}; padding:5px 0;">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
                        <span>${o.total} Ø¬.Ù…</span>
                    </div>
                </div>
            </div>

            <!-- Back Buttons -->
            <div style="width:100%; display:flex; flex-direction:column; gap:10px; margin-top:auto;">
                ${actionButtons}
            </div>
        </div>
    `;
    
    // Deactivate nav items visually since we are on a special page
    document.querySelectorAll(`#level-${lvl} .nav-item`).forEach(el => el.classList.remove('active'));
}

// Level 2 & 3 Generic
function renderClientApp(lvl) {
    const d = db[lvl];
    const body = document.getElementById(`body-${lvl}`);
    const color = lvl===2?'bg-l2':'bg-l3'; const txtC = lvl===2?'text-l2':'text-l3';
    
    // UPDATE HEADER
    const headerUser = document.getElementById(`header-user-${lvl}`);
    const loginBtn = document.getElementById(`login-btn-${lvl}`);
    if (d.user && d.user.phone) { 
        headerUser.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${d.user.name}`;
        loginBtn.textContent = 'Ø®Ø±ÙˆØ¬';
        loginBtn.className = "btn btn-sm btn-danger"; /* Logout is Red */
        loginBtn.onclick = () => logout(lvl);
    } else {
        headerUser.textContent = 'Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø²Ø§Ø¦Ø±';
        loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„';
        loginBtn.className = `btn btn-sm ${color}`; /* Login matches level color */
        loginBtn.onclick = () => openLogin(lvl);
    }
    
    // NEW: Render Category Chips
    const categoryChips = CATEGORIES.map(cat => `
        <div class="chip category ${d.currentCategory === cat ? 'active' : ''}" onclick="filterByCategory(${lvl}, '${cat}')">
            ${cat}
        </div>
    `).join('');
    
    // Filter products based on selected category
    const filteredProducts = d.menu.filter(p => p.active && (d.currentCategory === 'Ø§Ù„ÙƒÙ„' || p.category === d.currentCategory));


    // --- LOCK INTERFACE IF NOT LOGGED IN ---
    if (!d.user || !d.user.phone) {
        const nav = document.querySelector(`#level-${lvl} .app-nav`);
        if(nav) nav.style.display = 'none';

        body.innerHTML = `
            <div class="flex-center" style="height:100%; flex-direction:column; text-align:center; padding:20px">
                <div style="font-size:4rem; margin-bottom:20px">ğŸ”</div>
                <h2 class="mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
                <p class="muted mb-4">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ØªØ¬Ø±</p>
                <button class="btn btn-block ${color}" onclick="openLogin(${lvl})">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </div>
        `;
        return; // Stop rendering rest of the app
    } else {
        // Show Nav if user exists
        const nav = document.querySelector(`#level-${lvl} .app-nav`);
        if(nav) nav.style.display = 'flex';
    }

    if(d.currentView === 'home') {
        let h = '';
        if (lvl===3&&d.promo) {
            h += `<div class="card mb-4" style="background:#DCFCE7;border:1px solid var(--success);color:var(--success);text-align:center;font-weight:700">ğŸ‰ ${d.promo}</div>`;
        }
        
        h += `<div class="category-chips">${categoryChips}</div>`; // Add chips here
        
        h += filteredProducts.map(p => {
            let badgeHtml = '';
            if (p.badge) {
                let badgeClass = 'badge-new';
                if (p.badge === 'Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹') badgeClass = 'badge-best';
                if (p.badge === 'Ø­Ø§Ø±') badgeClass = 'badge-hot';
                if (p.badge === 'Ø®ØµÙ…') badgeClass = 'badge-sale';
                badgeHtml = `<span class="prod-badge ${badgeClass}">${p.badge}</span>`;
            }

            return `
            <div class="card product-card mb-2" onclick="openProductModal(${lvl}, ${p.id})" style="cursor:pointer">
                ${badgeHtml}
                <img src="${p.img}" class="p-img" style="height:140px">
                <div class="p-info">
                    <div class="flex-between">
                        <div class="p-title" style="margin-bottom:4px">${p.name}</div>
                        <i class="fas fa-heart ${d.fav.includes(p.id)?'text-danger':'muted'}" onclick="event.stopPropagation(); toggleFav(${lvl}, ${p.id})"></i>
                    </div>
                    <div class="small muted">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ: ${p.price} Ø¬.Ù…</div>
                </div>
            </div>`}).join('');
        body.innerHTML = h;
    } else if(d.currentView === 'cart') {
        let total = d.cart.reduce((s,i)=>s+i.finalPrice,0);
        let discountHtml = '';
        if (lvl === 3 && d.activeDiscount) {
            let discountVal = 0;
            if (d.activeDiscount.type === 'percent') {
                discountVal = Math.round(total * (d.activeDiscount.val / 100));
                discountHtml = `<div class="flex-between text-success small mb-1"><span>Ø®ØµÙ… (${d.activeDiscount.val}%)</span><span>-${discountVal} Ø¬.Ù…</span></div>`;
            } else {
                discountVal = d.activeDiscount.val;
                discountHtml = `<div class="flex-between text-success small mb-1"><span>Ø®ØµÙ… Ø®Ø§Øµ</span><span>-${discountVal} Ø¬.Ù…</span></div>`;
            }
            total = Math.max(0, total - discountVal);
        }

        if(d.cart.length===0) return body.innerHTML='<div class="center" style="height:100%"><p class="muted">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p></div>';
        
        // * MODIFIED: Cart Item Display for L2/L3 to show addons and separate base price
        const items = d.cart.map((item,i) => {
            const isReward = item.isReward;
            const priceClass = item.finalPrice < 0 ? 'text-success' : txtC;
            const basePrice = item.basePrice !== undefined ? item.basePrice : item.finalPrice; // Use basePrice if available, otherwise use finalPrice (for L1 items)
            
            // NEW: Addons Display in Cart
            const addonsHtml = item.addons && item.addons.length > 0 ? 
                `<div class="small muted mt-1" style="border-right: 2px solid var(--muted); padding-right: 8px;">
                    ${item.addons.map(a => `+ ${a.name} (+${a.price} Ø¬.Ù…)`).join('<br>')}
                </div>` : '';

            return `<div class="card mb-2 flex-between" style="${isReward?'border-right:4px solid var(--success)':''}">
                <div>
                    <div class="bold">${item.name}</div>
                    <div class="small muted">${item.weightLabel} | Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${basePrice} Ø¬.Ù…</div>
                    ${addonsHtml}
                </div>
                <div>
                    <div class="bold ${priceClass}" style="font-size: 1.1rem;">${item.finalPrice} Ø¬.Ù…</div>
                    <button class="btn btn-sm btn-danger" onclick="removeFromCart(${lvl}, ${i})"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        }).join('');
        
        const checkout = !d.user ? `<div class="card mt-4 center"><p class="text-danger mb-2">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p><button class="btn btn-sm btn-outline" onclick="openLogin(${lvl})">Ø¯Ø®ÙˆÙ„</button></div>` : `
            <div class="card mt-4"><h4 class="mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h4><div class="small mb-1">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${d.user.name}</div>
            <label class="small bold block mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
            <div style="display:flex;gap:5px"><select id="addr-sel-${lvl}" class="select" style="margin-bottom:0">${d.addresses.map(a=>`<option>${a}</option>`).join('')}</select><button class="btn btn-sm ${color}" onclick="openAddressModal(${lvl})">+</button></div>
            
            <div class="flex-between mb-2 mt-2">
                <div style="display:flex; align-items:center; gap:8px;">
                    <label class="switch">
                        <input type="checkbox" onchange="toggleElem('gift-input-${lvl}')">
                        <span class="slider"></span>
                    </label>
                    <span class="small bold">ğŸ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ‡Ø¯ÙŠØ©ØŸ</span>
                </div>
            </div>
            <input id="gift-input-${lvl}" class="input hidden" placeholder="Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‡Ø¯ÙŠØ©">
            
            <div class="flex-between mb-2">
                <div style="display:flex; align-items:center; gap:8px;">
                    <label class="switch">
                        <input type="checkbox" onchange="toggleElem('sched-input-${lvl}')">
                        <span class="slider"></span>
                    </label>
                    <span class="small bold">â° Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø·Ù„Ø¨ØŸ</span>
                </div>
            </div>
            <input id="sched-input-${lvl}" type="datetime-local" class="input hidden">

            <textarea id="note-${lvl}" class="textarea mt-2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
            ${lvl===3?`<div class="small text-success mb-2"><i class="fas fa-star"></i> Ø³ØªÙƒØ³Ø¨ ${Math.floor(total/10)} Ù†Ù‚Ø·Ø©</div>`:''}
            ${discountHtml}
            <div class="flex-between mb-2 mt-2"><span class="bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><strong class="${txtC}" style="font-size:1.2rem">${total} Ø¬.Ù…</strong></div>
            <button class="btn btn-block ${color}" onclick="submitOrder(${lvl})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button></div>`;
        body.innerHTML = `<h3 class="mb-4">Ø§Ù„Ø³Ù„Ø© (${d.cart.length})</h3>` + items + checkout;
    } else if(d.currentView === 'track') {
        body.innerHTML = `<h3 class="mb-4">Ø·Ù„Ø¨Ø§ØªÙŠ</h3>` + (d.orders.map(o => {
            // Check if status is done and not yet rated to show a prompt on the list item
            // UPDATED: Now calls renderRateOrder
            const ratePrompt = (o.status === 'done' && !o.rated && lvl > 1) ? 
                `<span class="chip" style="background: var(--accent); color: white; margin-right: auto; cursor: pointer;" onclick="event.stopPropagation(); renderRateOrder(${lvl}, ${o.id})">â­ Ù‚ÙŠÙ…</span>` : '';
            const ratingIcon = o.rated ? `<i class="fas fa-star" style="color: var(--accent); font-size: 0.9rem; margin-right: 5px;"></i>` : '';

            // NEW: Driver Status Info
            const driverStatus = o.status === 'deliv' && o.driverName ? `
                <div class="small text-l2 font-bold mt-1">ğŸï¸ Ø§Ù„Ø·ÙŠØ§Ø±: ${o.driverName}</div>
            ` : '';
            
            return `
            <div class="card modern-ticket st-${o.status}" onclick="renderSuccessPage(${lvl}, ${o.id}, true)" style="cursor:pointer">
                <div class="mt-header">
                    <span class="mt-id">#${o.id}</span>
                    <span class="mt-time">${o.time} ${ratingIcon}</span>
                </div>
                <div class="mt-body">
                    ${o.items.map(i => `
                    <div class="mt-item">
                        <span>${i.name}</span>
                        <span>${i.weightLabel}</span>
                    </div>`).join('')}
                    ${driverStatus}
                </div>
                <div class="mt-footer">
                    <span class="mt-status status-${o.status}">
                        ${o.status === 'new' ? '<i class="fas fa-bell"></i>' : 
                          o.status === 'prep' ? '<i class="fas fa-fire-burner"></i>' : 
                          o.status === 'deliv' ? '<i class="fas fa-motorcycle"></i>' : 
                          o.status === 'cancelled' ? '<i class="fas fa-ban"></i>' :
                          '<i class="fas fa-check-circle"></i>'}
                        ${getStatusText(o.status)}
                    </span>
                    ${ratePrompt}
                </div>
            </div>`;
        }).join('') || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>');
    } else if(d.currentView === 'notif') {
        const typeConfig = {
            'order': { icon: 'fa-box-open', color: 'var(--notif-order)', label: 'Ø·Ù„Ø¨' },
            'points': { icon: 'fa-star', color: 'var(--notif-points)', label: 'Ù†Ù‚Ø§Ø·' },
            'promo': { icon: 'fa-fire', color: 'var(--notif-promo)', label: 'Ø¹Ø±Ø¶' }
        };

        const statusColors = {
            'new': '#D97706',   // Warning/Yellow-Orange
            'prep': '#2563EB',  // Blue
            'deliv': '#7E22CE', // Purple
            'done': '#15803D',   // Green
            'cancelled': '#DC2626' // Danger
        };

        body.innerHTML = `<h3 class="mb-4">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>` + (d.notif.map((n, i) => {
            const conf = typeConfig[n.type] || typeConfig['order'];
            
            // Logic to determine border color
            let borderColor = conf.color;
            if (n.type === 'order' && n.data && n.data.status && statusColors[n.data.status]) {
                borderColor = statusColors[n.data.status];
            }

            return `
            <div class="notif-card type-${n.type || 'order'}" style="border-right-color: ${borderColor} !important">
                <div class="flex-between mb-2">
                    <div style="display:flex;align-items:center;gap:10px">
                        <i class="fas ${conf.icon} notif-icon" style="color:${borderColor};font-size:1.2rem"></i>
                        <div class="bold" style="font-size:1.1rem">${n.title}</div>
                    </div>
                    ${n.type === 'promo' ? 'âœ¨' : ''}
                </div>
                <div class="small muted mb-2" style="margin-right:28px">${n.body}</div>
                ${n.type === 'promo' && n.data ? `<button class="btn btn-sm text-white mt-2" style="background:${conf.color};border:none;width:auto;float:left" onclick="applyDiscount(${lvl}, ${i})">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶</button>` : ''}
                <div style="clear:both"></div>
                <div class="small muted mt-2 text-left" style="direction:ltr;margin-left:5px">${n.time}</div>
            </div>`;
        }).join('')) || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>';
    } else if(d.currentView === 'settings') {
        let menu = '';
        
        if (d.user && d.user.phone) {
            
            // Calculate and display user rating average
            const avgRating = d.user.ratingsCount > 0 ? (d.user.totalRatings / d.user.ratingsCount).toFixed(1) : 'ØºÙŠØ± Ù…Ù‚ÙŠÙ‘Ù…';
            const ratingHtml = `<div class="small muted text-center mt-2">Ù…ØªÙˆØ³Ø· ØªÙ‚ÙŠÙŠÙ…Ùƒ: <strong style="color:var(--accent)">${avgRating} â­</strong></div>`;


            menu += `
            <div class="card mb-2" onclick="nav(${lvl}, 'profile')" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-user text-l${lvl===2?'2':'3'}"></i> <span class="bold">Ø­Ø³Ø§Ø¨ÙŠ</span> <i class="fas fa-chevron-left muted" style="margin-right:auto"></i>
            </div>
            ${ratingHtml} <!-- Display rating average in settings -->
            <div class="card mb-2" onclick="nav(${lvl}, 'address')" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-map-marker-alt text-l${lvl===2?'2':'3'}"></i> <span class="bold">Ø¹Ù†Ø§ÙˆÙŠÙ†ÙŠ</span> <i class="fas fa-chevron-left muted" style="margin-right:auto"></i>
            </div>
            <div class="card mb-2" onclick="nav(${lvl}, 'fav')" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-heart text-l${lvl===2?'2':'3'}"></i> <span class="bold">Ø§Ù„Ù…ÙØ¶Ù„Ø©</span> <i class="fas fa-chevron-left muted" style="margin-right:auto"></i>
            </div>
            `;
            if (lvl === 3) {
                menu += `
                <div class="card mb-2" onclick="nav(${lvl}, 'wallet')" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-gift text-l3"></i> <span class="bold">Ù…ÙƒØ§ÙØ¢ØªÙŠ</span> <i class="fas fa-chevron-left muted" style="margin-right:auto"></i>
                </div>`;
            }
        }

        menu += `
        <div class="card mb-2" onclick="nav(${lvl}, 'about')" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-info-circle text-l${lvl===2?'2':'3'}"></i> <span class="bold">Ù…Ù† Ù†Ø­Ù†</span> <i class="fas fa-chevron-left muted" style="margin-right:auto"></i>
        </div>
        `;

        if (d.user && d.user.phone) {
            menu += `<button class="btn btn-block btn-danger mt-4" onclick="logout(${lvl})">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>`;
        }

        body.innerHTML = `<h3 class="mb-4">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>${menu}`;

    } else if(d.currentView === 'about') {
        renderAboutPage(lvl);
    } else if(d.currentView === 'profile' && d.user && d.user.phone) {
        // Show Customer rating data in profile
        const avgRating = d.user.ratingsCount > 0 ? (d.user.totalRatings / d.user.ratingsCount).toFixed(1) : 'ØºÙŠØ± Ù…Ù‚ÙŠÙ‘Ù…';

        body.innerHTML = `
            <div class="flex-between mb-4"><button class="btn btn-sm btn-outline" onclick="nav(${lvl}, 'settings')"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button><h3>Ø­Ø³Ø§Ø¨ÙŠ</h3></div>
            <div class="card mb-4">
                <div class="flex-between mb-2"><span>Ø§Ù„Ø§Ø³Ù…</span><strong>${d.user.name}</strong></div>
                <div class="flex-between mb-2"><span>Ø§Ù„Ù‡Ø§ØªÙ</span><strong>${d.user.phone}</strong></div>
                <div class="flex-between mb-2"><span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span><strong>${d.orders.length}</strong></div>
                <div class="flex-between"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span><strong style="color:var(--accent)">${avgRating} â­</strong></div>
            </div>`;
    } else if(d.currentView === 'address' && d.user && d.user.phone) {
        body.innerHTML = `<div class="flex-between mb-4"><button class="btn btn-sm btn-outline" onclick="nav(${lvl}, 'settings')"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button><h3>Ø¹Ù†Ø§ÙˆÙŠÙ†ÙŠ</h3> <button class="btn btn-sm ${color}" onclick="openAddressModal(${lvl})">+</button></div>${d.addresses.map(a=>`<div class="card mb-2 small">${a}</div>`).join('')}`;
    } else if(d.currentView === 'fav' && d.user && d.user.phone) {
        body.innerHTML = `<div class="flex-between mb-4"><button class="btn btn-sm btn-outline" onclick="nav(${lvl}, 'settings')"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button><h3>Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3></div>` + (d.menu.filter(p=>d.fav.includes(p.id)).map(p => `
            <div class="card product-card mb-2">
                <img src="${p.img}" class="p-img">
                <div class="p-info">
                    <div class="flex-between"><div class="p-title">${p.name}</div><i class="fas fa-heart text-danger" onclick="toggleFav(${lvl}, ${p.id})"></i></div>
                    <div class="p-desc">${p.price} Ø¬.Ù…</div>
                    <div class="flex-between mt-2">
                        <select id="w-fav-${lvl}-${p.id}" class="select" style="width:auto;padding:4px;margin:0;font-size:0.8rem">
                            <option value="0.25">Â¼ ÙƒØ¬Ù…</option>
                            <option value="0.5">Â½ ÙƒØ¬Ù…</option>
                            <option value="1">1 ÙƒØ¬Ù…</option>
                        </select>
                        <button class="btn btn-sm ${color}" onclick="quickAddFav(${lvl}, ${p.id})">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>
            </div>`).join('') || '<p class="muted center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ¶Ù„Ø©</p>');
    } else if(d.currentView === 'wallet' && d.user && d.user.phone && lvl===3) {
        body.innerHTML = `<div class="flex-between mb-4"><button class="btn btn-sm btn-outline" onclick="nav(${lvl}, 'settings')"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button><h3>Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</h3></div><div class="card mb-4 center"><h1 style="font-size:3rem">${d.points}</h1><span>Ù†Ù‚Ø·Ø© ÙˆÙ„Ø§Ø¡ â­</span></div><h4 class="mb-2">Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>${l3Offers.map(o=>`<div class="card flex-between mb-2"><div><div class="bold">${o.title}</div><div class="small muted">${o.pts} Ù†Ù‚Ø·Ø©</div></div><button class="btn btn-sm btn-outline" onclick="redeemPoints(${o.id})">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button></div>`).join('')}`;
    }
}
function renderAdminPanel(lvl) {
    const d = db[lvl]; const container = document.getElementById(`admin-panel-${lvl}`);
    if (!container) return;
    
    // Check which panel to render
    if(d.adminView === 'menu') container.innerHTML = d.menu.map(p => `
        <div class="flex-between card mb-1" style="padding:8px">
            <span class="small bold">${p.name}</span>
            <label class="switch">
                <input type="checkbox" ${p.active?'checked':''} onchange="toggleProduct(${lvl}, ${p.id})">
                <span class="slider"></span>
            </label>
        </div>
    `).join('');
    
    else if(d.adminView === 'customers') container.innerHTML = d.customers.map(c => {
        const avgRating = c.ratingsCount > 0 ? (c.totalRatings / c.ratingsCount).toFixed(1) : 'ØºÙŠØ± Ù…Ù‚ÙŠÙ‘Ù…';
        return `
        <div class="card mb-2 small">
            <div class="flex-between"><strong>${c.name}</strong> <span>${c.orders} Ø·Ù„Ø¨</span></div>
            <div class="flex-between muted"><span>${c.phone}</span> <span>${c.total} Ø¬.Ù…</span></div>
            <div class="flex-between small mt-1"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</span> <strong style="color:var(--accent)">${avgRating} â­</strong></div>
        </div>`;
    }).join('');
    else if(d.adminView === 'drivers' && lvl > 1) { // NEW DRIVER MANAGEMENT VIEW
        renderDriversManagement(lvl, container);
    }
    else if(d.adminView === 'analytics' && lvl===3) {
        renderAnalyticsDashboard(container, d);
    }
}

// NEW: Driver Management Functions
function renderDriversManagement(lvl, container) {
    const drivers = db[lvl].drivers;
    const color = lvl === 2 ? 'bg-l2' : 'bg-l3';
    const editingDriver = drivers.find(d => d.isEditing);
    
    // Filtered list of drivers to show active ones first
    const sortedDrivers = [...drivers].sort((a, b) => b.isEditing - a.isEditing || a.name.localeCompare(b.name));
    
    const driverListHtml = sortedDrivers.map(d => `
        <div class="card p-4 flex justify-between items-center gap-4 shadow-md">
            <div class="flex-1 min-w-0">
                <h4 class="text-xl font-extrabold text-l${lvl} truncate">${d.name}</h4>
                <p class="text-sm text-text font-medium mt-1">
                    <i class="fas fa-phone-alt text-l${lvl}"></i> ${d.phone}
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="editDriver(${lvl}, '${d.id}')" class="btn btn-sm btn-outline" style="border-color:var(--accent); color:var(--accent)">
                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                </button>
                <button onclick="confirmDeleteDriver(${lvl}, '${d.id}', '${d.name}')" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `
        <h2 class="text-3xl font-extrabold text-text mb-6 border-b border-cardBorder pb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† (Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ†) ğŸï¸</h2>
        
        <div class="card p-4 shadow-lg mb-6">
            <h3 class="text-xl font-extrabold text-l${lvl} mb-4">${editingDriver ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚' : 'Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯'}</h3>
            <div class="grid grid-cols-1 gap-4">
                <!-- Removed carDetails input, kept name and phone -->
                <input type="text" id="driver-name-input-${lvl}" value="${editingDriver?.name || ''}" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø·Ù„ÙˆØ¨)" class="input p-3 rounded-lg">
                <input type="tel" id="driver-phone-input-${lvl}" value="${editingDriver?.phone || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø·Ù„ÙˆØ¨)" class="input p-3 rounded-lg">
            </div>
            <div class="flex justify-end gap-3 mt-4">
                ${editingDriver ? `
                    <button onclick="cancelDriverEdit(${lvl})" class="btn btn-outline" style="flex:0.5">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button onclick="saveDriver(${lvl}, '${editingDriver.id}')" class="btn ${color}" style="flex:1">
                        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                ` : `
                    <button onclick="saveDriver(${lvl})" class="btn ${color}" style="flex:1">
                        Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¦Ù‚
                    </button>
                `}
            </div>
        </div>

        <h3 class="text-2xl font-extrabold text-text mb-4 border-b border-cardBorder pb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† (${drivers.length})</h3>
        
        <div class="space-y-3">
            ${driverListHtml}
        </div>
    `;
}

function saveDriver(lvl, driverId = null) {
    const name = document.getElementById(`driver-name-input-${lvl}`).value.trim();
    const phone = document.getElementById(`driver-phone-input-${lvl}`).value.trim();
    
    if (!name || !phone) {
        playSound('error');
        return showBanner('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙƒÙ„Ø§Ù‡Ù…Ø§ Ù…Ø·Ù„ÙˆØ¨).', 'admin');
    }
    
    // Remove editing state globally
    let drivers = db[lvl].drivers.map(d => ({ ...d, isEditing: false }));
    
    if (driverId) {
        // Update existing driver
        const index = drivers.findIndex(d => d.id === driverId);
        if (index !== -1) {
            drivers[index] = { id: driverId, name, phone, isEditing: false };
            showBanner(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ${name}.`, 'admin');
        }
    } else {
        // Add new driver
        const newId = Date.now().toString(36) + Math.random().toString(36).substring(2);
        drivers.push({ id: newId, name, phone, isEditing: false });
        showBanner(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¦Ù‚ ${name} Ø¨Ù†Ø¬Ø§Ø­.`, 'admin');
    }

    db[lvl].drivers = drivers;
    renderAdminPanel(lvl);
}

function editDriver(lvl, driverId) {
    // Set editing state for the target driver
    db[lvl].drivers = db[lvl].drivers.map(d => ({ ...d, isEditing: d.id === driverId }));
    renderAdminPanel(lvl);
}

function cancelDriverEdit(lvl) {
    db[lvl].drivers = db[lvl].drivers.map(d => ({ ...d, isEditing: false }));
    renderAdminPanel(lvl);
}

// NEW: Function to open the custom confirmation modal for driver deletion
function confirmDeleteDriver(lvl, driverId, driverName) {
    showConfirmModal(
        `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³Ø§Ø¦Ù‚ "${driverName}"ØŸ Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªØ¹ÙŠÙŠÙ†Ù‡ Ù…Ù† Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„.`,
        deleteDriver,
        { lvl: lvl, id: driverId } // Context to pass to deleteDriver
    );
}

// MODIFIED: Accepts context object from confirm modal
function deleteDriver(context) {
    const { lvl, id: driverId } = context;
    
    // Filter out the driver
    db[lvl].drivers = db[lvl].drivers.filter(d => d.id !== driverId).map(d => ({ ...d, isEditing: false }));

    // Unassign driver from any active orders
    db[lvl].orders.forEach(o => {
        if (o.driverId === driverId) {
            o.driverId = null;
            o.driverName = null;
            o.driverPhone = null;
        }
    });

    showBanner('âŒ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­.', 'admin');
    renderAdminPanel(lvl);
}

function renderAnalyticsDashboard(container, d) {
    const trendRev = generateRandomTrend();
    const trendAOV = generateRandomTrend();
    const trendConv = generateRandomTrend();
    const trendPts = generateRandomTrend();
    
    // NEW: Calculate overall rating for Admin KPI
    const totalRatedOrders = d.orders.filter(o => o.rated);
    const sumRatings = totalRatedOrders.reduce((sum, o) => sum + o.rating, 0);
    const overallAvgRating = totalRatedOrders.length > 0 ? (sumRatings / totalRatedOrders.length).toFixed(1) : 'N/A';

    container.innerHTML = `
    <div class="dashboard-grid">
        <div class="kpi-card">
            <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
            <div class="kpi-value text-l3">${(d.sales + 12500).toLocaleString()} Ø¬.Ù…</div>
            <div class="trend ${trendRev.dir}">${trendRev.icon} ${trendRev.val}%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ù„Ø©</div>
            <div class="kpi-value text-l2">185 Ø¬.Ù…</div>
            <div class="trend ${trendAOV.dir}">${trendAOV.icon} ${trendAOV.val}%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="kpi-value text-l3">${d.orders.length + 42}</div>
            <div class="trend ${trendConv.dir}">${trendConv.icon} ${trendConv.val}%</div>
        </div>
        <div class="kpi-card" style="border-right: 4px solid var(--accent)"> <!-- Highlight for new metric -->
            <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
            <div class="kpi-value" style="color:var(--accent)">${overallAvgRating} â­</div>
            <div class="trend up">ğŸ”¼ 0.5%</div>
        </div>
    </div>

    <div class="chart-box">
        <div class="chart-header">
            <span>ğŸ“ˆ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø£Ø³Ø¨ÙˆØ¹ÙŠ)</span>
            <span class="small muted">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</span>
        </div>
        <svg class="line-chart-svg" viewBox="0 0 100 50" preserveAspectRatio="none">
            <line x1="0" y1="10" x2="100" y2="10" class="chart-axis" />
            <line x1="0" y1="25" x2="100" y2="25" class="chart-axis" />
            <line x1="0" y1="40" x2="100" y2="40" class="chart-axis" />
            <path d="M0,50 L0,30 L15,20 L30,35 L45,15 L60,25 L75,10 L90,20 L100,5 L100,50 Z" class="line-area" />
            <path d="M0,30 L15,20 L30,35 L45,15 L60,25 L75,10 L90,20 L100,5" class="line-path" />
        </svg>
    </div>

    <div class="chart-box">
        <div class="chart-header">
            <span>ğŸ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</span>
        </div>
        ${[
            {name:'Ø·Ø¨Ù‚ Ø´Ø±Ù‚ÙŠ Ù…Ø´ÙƒÙ„', val:85, fill:'90%'},
            {name:'ØªÙˆØ±ØªØ© Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', val:62, fill:'75%'},
            {name:'ÙƒÙ†Ø§ÙØ© Ù†Ø§Ø¨Ù„Ø³ÙŠØ©', val:45, fill:'50%'},
            {name:'Ø¨Ø³Ø¨ÙˆØ³Ø© Ø¨Ø§Ù„Ù‚Ø´Ø·Ø©', val:30, fill:'35%'}
        ].map(i => `
            <div class="prog-row">
                <div class="prog-name">${i.name}</div>
                <div class="prog-track"><div class="prog-fill" style="width:${i.fill}"></div></div>
                <div class="prog-val">${i.val}</div>
            </div>
        `).join('')}
    </div>

    <div class="card mb-2" style="border:1px dashed var(--l3)"><h5 class="mb-2">ğŸ“¢ Ù†Ø´Ø± Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</h5>
        <input id="promo-title-3" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø«Ù„Ø§Ù‹: Ø®ØµÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©)">
        <div class="grid-2">
            <select id="promo-type-3" class="select"><option value="percent">Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© %</option><option value="fixed">Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (Ø¬.Ù…)</option></select>
            <input id="promo-val-3" type="number" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù…Ø«Ù„Ø§Ù‹ 20)">
        </div>
        <button class="btn btn-block bg-l3" onclick="sendPromo(3)">Ù†Ø´Ø± ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</button>
    </div>
    `;
}

function generateRandomTrend() {
    const isUp = Math.random() > 0.3; 
    return {
        val: Math.floor(Math.random() * 20) + 1,
        dir: isUp ? 'up' : 'down',
        icon: isUp ? 'ğŸ”¼' : 'ğŸ”½'
    };
}

/* --- 6. ACTIONS --- */
function openProductModal(lvl, pid) {
    playSound('pop');
    const p = db[lvl].menu.find(x => x.id === pid); activeModalData = {lvl, p};
    
    document.getElementById(`mp-img-${lvl}`).src = p.img; 
    document.getElementById(`mp-name-${lvl}`).textContent = p.name;
    document.getElementById(`mp-weight-${lvl}`).value = 0.25;
    
    // * NEW: Logic for Addons (Only for L2 and L3)
    const isModifierLevel = lvl === 2 || lvl === 3;
    const addonsContainer = document.getElementById(`mp-addons-${lvl}`);
    const addonsOuterContainer = document.getElementById(`mp-addons-container-${lvl}`);
    
    if (isModifierLevel && p.modifiers && p.modifiers.length > 0) {
        addonsOuterContainer.classList.remove('hidden');
        addonsContainer.innerHTML = '';
        
        p.modifiers.forEach((m, index) => {
            const checkboxId = `mod-${lvl}-${index}`;
            addonsContainer.innerHTML += `
                <div class="flex-between small">
                    <label for="${checkboxId}" style="display:flex;align-items:center;cursor:pointer; font-weight: 500;">
                        <input type="checkbox" id="${checkboxId}" data-name="${m.name}" data-price="${m.price}" onchange="updateModalPrice(${lvl})" style="margin-left:10px; width:16px; height:16px; flex-shrink:0;">
                        ${m.name} 
                    </label>
                    <span class="bold text-l${lvl===2?'2':'3'}">+${m.price} Ø¬.Ù…</span>
                </div>
            `;
        });
    } else {
        // Hide addons for L1 or products without modifiers
        if(addonsOuterContainer) addonsOuterContainer.classList.add('hidden');
    }
    
    // Set initial price (calls updateModalPrice)
    updateModalPrice(lvl); 
    document.getElementById(`modal-product-${lvl}`).classList.add('open');
}

// * MODIFIED: To include addon price calculation
function updateModalPrice(lvl) {
    if (!activeModalData || !activeModalData.p) return; 
    
    const p = activeModalData.p;
    const w = parseFloat(document.getElementById(`mp-weight-${lvl}`).value);
    
    let basePrice = p.price * w;
    let addonsTotal = 0;
    
    // Calculate Addons Total (Only applies if element exists, implicitly L2/L3)
    const addonsCheckboxes = document.querySelectorAll(`#mp-addons-${lvl} input[type="checkbox"]:checked`);
    addonsCheckboxes.forEach(checkbox => {
        addonsTotal += parseFloat(checkbox.dataset.price);
    });
    
    const finalPrice = Math.round(basePrice + addonsTotal);
    
    document.getElementById(`mp-price-${lvl}`).textContent = finalPrice + ' Ø¬.Ù…';
}

// * MODIFIED: To collect and save addon details in the cart item
function addToCartFromModal(lvl) {
    playSound('click');
    if (!activeModalData || !activeModalData.p) return; 
    
    const p = activeModalData.p;
    const w = parseFloat(document.getElementById(`mp-weight-${lvl}`).value);
    const wLabels = {0.25:'Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ', 0.5:'Ù†ØµÙ ÙƒÙŠÙ„Ùˆ', 1:'ÙƒÙŠÙ„Ùˆ'};

    let addonsTotal = 0;
    const selectedAddons = [];
    
    // Collect selected addons details (Only for L2/L3 where the element exists)
    if (lvl > 1) {
        const addonsCheckboxes = document.querySelectorAll(`#mp-addons-${lvl} input[type="checkbox"]:checked`);
        addonsCheckboxes.forEach(checkbox => {
            const addonPrice = parseFloat(checkbox.dataset.price);
            addonsTotal += addonPrice;
            selectedAddons.push({ 
                name: checkbox.dataset.name, 
                price: addonPrice 
            });
        });
    }
    
    const basePrice = Math.round(p.price * w);
    const finalPrice = basePrice + addonsTotal;

    db[lvl].cart.push({ 
        ...p, 
        weight: w, 
        weightLabel: wLabels[w], 
        basePrice: basePrice, 
        addons: selectedAddons, // Empty array for L1, populated for L2/L3
        addonsTotal: addonsTotal, 
        finalPrice: finalPrice 
    });
    
    closeModal(lvl, 'product');
    playSound('success');
    showBanner('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
    updateCounts(lvl); 
    const cartIcon = document.getElementById(`cart-icon-${lvl}`);
    if(cartIcon) {
        cartIcon.classList.add('anim-shake');
        setTimeout(() => cartIcon.classList.remove('anim-shake'), 500);
    }
    if(lvl > 1 && db[lvl].currentView === 'cart') renderClientApp(lvl);
}
function quickAddFav(lvl, pid) {
    playSound('click');
    const el = document.getElementById(`w-fav-${lvl}-${pid}`); const w = el ? parseFloat(el.value) : 0.25;
    const p = db[lvl].menu.find(x=>x.id===pid);
    
    // * FIX: Quick Add assumes no addons for simplicity, but calculates finalPrice correctly for core item
    const wLabels = {0.25:'Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ', 0.5:'Ù†ØµÙ ÙƒÙŠÙ„Ùˆ', 1:'ÙƒÙŠÙ„Ùˆ'};
    const basePrice = Math.round(p.price * w);
    
    db[lvl].cart.push({ 
        ...p, 
        weight: w, 
        weightLabel: wLabels[w], 
        basePrice: basePrice, 
        addons: [], // No addons in Quick Add
        addonsTotal: 0, 
        finalPrice: basePrice 
    });
    
    updateCounts(lvl); 
    showBanner('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©'); 
    if(lvl > 1 && db[lvl].currentView === 'cart') renderClientApp(lvl);
}

function addItemToCart(lvl, p, w) {
    if(!db[lvl].storeOpen) { playSound('error'); return showBanner('ğŸ›‘ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹'); }
    const wLabels = {0.25:'Ø±Ø¨Ø¹ ÙƒÙŠÙ„Ùˆ', 0.5:'Ù†ØµÙ ÙƒÙŠÙ„Ùˆ', 1:'ÙƒÙŠÙ„Ùˆ'};
    
    // * REVERTED TO SIMPLE L1 LOGIC for safety when called directly
    db[lvl].cart.push({ ...p, weight: w, weightLabel: wLabels[w], finalPrice: Math.round(p.price * w), addons: [], addonsTotal: 0 });
    
    playSound('success');
    showBanner('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
    updateCounts(lvl); 
    const cartIcon = document.getElementById(`cart-icon-${lvl}`);
    if(cartIcon) {
        cartIcon.classList.add('anim-shake');
        setTimeout(() => cartIcon.classList.remove('anim-shake'), 500);
    }
    if(lvl > 1 && db[lvl].currentView === 'cart') renderClientApp(lvl);
}
function removeFromCart(lvl, idx) { playSound('click'); db[lvl].cart.splice(idx, 1); updateCounts(lvl); if(lvl===1) renderCartL1(); else renderClientApp(lvl); }
function updateCounts(lvl) {
    const c = db[lvl].cart.length; const el = document.getElementById(`badge-cart-${lvl}`); el.textContent=c; el.classList.toggle('hidden', c===0);
    if(lvl>1) { const n=db[lvl].notif.length; const ne=document.getElementById(`badge-notif-${lvl}`); ne.textContent=n; ne.classList.toggle('hidden', n===0); }
}
function submitOrder(lvl) {
    if(!db[lvl].storeOpen) { playSound('error'); return showBanner('ğŸ›‘ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚'); }
    const d = db[lvl]; if(d.cart.length===0) { playSound('error'); return showBanner('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); }
    if(lvl>1 && (!d.user || !d.user.phone)) { playSound('error'); return showBanner('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
    
    // FIX: Validation for Guest Name in Level 1
    if (lvl === 1) {
        const guestName = document.getElementById('guest-name-1').value;
        if(!guestName.trim()) { 
            playSound('error'); 
            // * Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© 1: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ L1
            return showBanner('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…', 'client', 'client-toast-1'); 
        }
    }

    // REMOVED: success-anim-container logic. 
    // We now transition directly to the Success Page.

    let total = d.cart.reduce((s,i)=>s+i.finalPrice, 0);
    let subTotal = total; // Store original subtotal
    let discountVal = 0; 
    let discountType = null;
    let discountRate = 0;

    if (d.activeDiscount) {
        discountType = d.activeDiscount.type;
        discountRate = d.activeDiscount.val;
        discountVal = d.activeDiscount.type === 'percent' ? Math.round(total * (d.activeDiscount.val / 100)) : d.activeDiscount.val;
        total = Math.max(0, total - discountVal);
        d.activeDiscount = null; 
    }
    
    const note = lvl===1 ? document.getElementById('note-1').value : document.getElementById(`note-${lvl}`).value;
    const gift = lvl>1 ? document.getElementById(`gift-input-${lvl}`).value : '';
    const sched = lvl>1 ? document.getElementById(`sched-input-${lvl}`).value : '';
    const addr = lvl>1 ? document.getElementById(`addr-sel-${lvl}`).value : document.getElementById('guest-addr-1').value;
    const phone = lvl>1 ? d.user.phone : document.getElementById('guest-phone-1').value;

    const order = { 
        id: 1000 + d.orders.length + 1, 
        items: [...d.cart], 
        total: total,
        subTotal: subTotal, // Save subtotal
        discountVal: discountVal,
        discountType: discountType, // Save discount type
        discountRate: discountRate, // Save discount value/rate 
        client: (d.user?d.user.name:document.getElementById('guest-name-1').value), 
        phone: phone,
        addr: addr,
        note: note,
        gift: gift,
        sched: sched,
        time: new Date().toLocaleTimeString('ar-EG'), 
        status: 'new',
        // NEW: Rating fields
        rated: false,
        rating: 0,
        feedback: null,
        // NEW: Driver fields
        driverId: null,
        driverName: null,
        driverPhone: null,
        // NEW: Rejection field
        rejectReason: null 
    };
    d.orders.unshift(order); d.cart = [];
    
    if(lvl>1) {
        let cust = d.customers.find(c=>c.name===order.client);
        if(cust) { cust.orders++; cust.total+=total; } else d.customers.push({name:order.client, phone:phone, orders:1, total:total, totalRatings: 0, ratingsCount: 0});
    }
    if(lvl===3) { d.sales+=total; d.points+=Math.floor(total/10); pushNotif(3, 'Ù†Ù‚Ø§Ø· Ù…ÙƒØªØ³Ø¨Ø©', `+${Math.floor(total/10)} Ù†Ù‚Ø·Ø©`, 'points'); }
    
    // UPDATED: Show Success Page for ALL levels immediately
    playSound('success');
    showBanner('âœ… ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØªØ¨Ø¹', 'client'); // Client Success Message
    renderSuccessPage(lvl, order.id);
    
    // FIX: Refresh Admin Dashboard to show the new order immediately
    renderAdminInterface(lvl);

    if(lvl > 1) { 
        pushNotif(lvl, 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', `Ø·Ù„Ø¨Ùƒ #${order.id} Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°`, 'order', {status: 'new'}); 
        // nav(lvl, 'track'); // Removed auto-redirect
    }
}
// MODIFIED: nextStatus now checks if the next state is 'deliv' for assignment or 'done' for rating.
function nextStatus(lvl, oid) {
    playSound('click');
    const o = db[lvl].orders.find(x=>x.id===oid);
    // NEW: Added 'cancelled' to the flow for status text, but not flow progression
    const flow = ['new', 'prep', 'deliv', 'done']; 
    const idx = flow.indexOf(o.status);
    
    // Prevent actions on cancelled/done orders
    if (o.status === 'cancelled' || o.status === 'done') {
        return; 
    }
    
    if(idx < 3) {
        const nextStatus = flow[idx+1];
        
        // FIX 1: Handle Level 1 flow (always proceed without driver logic)
        if (lvl === 1) {
            o.status = nextStatus;
            // Transition from prep to done is through deliv status in the flow array
            if(nextStatus === 'deliv') {
                o.status = 'done'; // Skip deliv step logically for L1
            }
            // No notifications for L1
            renderLevel(lvl); 
            return;
        }

        // Check for Driver Assignment Trigger (Prep -> Deliv)
        if (nextStatus === 'deliv') {
            if (o.driverId) {
                // Driver already assigned, proceed normally
                o.status = nextStatus;
                if(lvl > 1) pushNotif(lvl, 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨', `Ø·Ù„Ø¨Ùƒ #${oid}: ${getStatusText(o.status)}`, 'order', {status: o.status});
                showBanner(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${oid} Ø¥Ù„Ù‰ ØªÙˆØµÙŠÙ„.`, 'admin');
            } else {
                // Must assign driver before moving to deliv
                showDriverAssignmentModal(lvl, oid);
                return; // Stop processing further until modal interaction is complete
            }
        }
        
        // Check for Rating Trigger (Deliv -> Done)
        if (nextStatus === 'done') {
            o.status = nextStatus;
            showBanner(`âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨ #${oid}.`, 'admin');
            // Check if the order belongs to the CURRENTLY logged-in user and needs rating
            if (!o.rated && lvl > 1) {
                const clientD = db[lvl].user;
                if (clientD && clientD.phone === o.phone) {
                    renderRateOrder(lvl, oid);
                    db[lvl].currentView = 'rate';
                    renderLevel(lvl); 
                    return; 
                }
            }
            if(lvl > 1) pushNotif(lvl, 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨', `Ø·Ù„Ø¨Ùƒ #${oid}: ${getStatusText(o.status)}`, 'order', {status: o.status});
        }
        
        // Default Status Update (if no modal was triggered)
        if (nextStatus !== 'deliv' && nextStatus !== 'done') {
            o.status = nextStatus;
            if(lvl > 1) pushNotif(lvl, 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨', `Ø·Ù„Ø¨Ùƒ #${oid}: ${getStatusText(o.status)}`, 'order', {status: o.status});
             showBanner(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${oid} Ø¥Ù„Ù‰ ${getStatusText(o.status)}.`, 'admin');
        }
        
        renderLevel(lvl); // Re-render admin interface to update lists
    }
}
function getStatusText(st) { return st==='new'?'Ø¬Ø¯ÙŠØ¯':st==='prep'?'ØªØ¬Ù‡ÙŠØ²':st==='deliv'?'ØªÙˆØµÙŠÙ„':st==='cancelled'?'Ù…Ù„ØºÙŠ':'ØªÙ…'; } // NEW: Added cancelled

/* --- Order Rejection Logic (NEW) --- */
function openRejectModal(lvl, oid) {
    playSound('pop');
    activeRejectOrderId = oid;
    document.getElementById('reject-order-id').textContent = oid;
    document.getElementById('reject-order-target').value = lvl; // Use hidden input for level or ID if needed
    document.getElementById('modal-reject-order').classList.add('open');
}

function confirmReject() {
    playSound('click');
    const lvl = parseInt(document.getElementById('reject-order-target').value);
    const oid = activeRejectOrderId;
    const reasonEl = document.getElementById('reject-reason');
    const noteEl = document.getElementById('reject-note');
    
    const reason = reasonEl.value;
    let feedback = reason;
    if (noteEl.value.trim()) {
        feedback += ` (${noteEl.value.trim()})`;
    }
    
    // Basic validation
    if (!reason || reason === "Ø£Ø®Ø±Ù‰ (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ¶ÙŠØ­)" && !noteEl.value.trim()) {
        playSound('error');
        return showBanner('âŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¨Ø¨ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø©', 'admin', 'modal-toast-reject');
    }
    
    // Perform rejection logic
    const o = db[lvl].orders.find(x => x.id === oid);
    if (o) {
        o.status = 'cancelled';
        o.rejectReason = feedback;
        
        // Notify the client about the cancellation
        pushNotif(lvl, 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ğŸ›‘', `Ù†Ø¹ØªØ°Ø±ØŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨Ùƒ #${oid}. Ø§Ù„Ø³Ø¨Ø¨: ${feedback.split(' (')[0]}`, 'order', {status: 'cancelled'});
        
        // * FIX: Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        closeModal('reject-order'); 
        
        activeRejectOrderId = null;
        showBanner(`âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ #${oid}.`, 'admin');
        renderLevel(lvl);
    }
}


/* --- Rating Logic --- */
// NEW: Function to open the rate modal
function openRateModal(lvl, oid) {
    // This function is no longer a modal opener, but a redirector to the page renderer
    renderRateOrder(lvl, oid);
}

// NEW: Function to handle rating submission
function submitRating(lvl) {
    const oid = activeRatingOrderId;
    const o = db[lvl].orders.find(x => x.id === oid);
    const ratingElement = document.getElementById(`rating-stars-${lvl}`);
    const ratingValue = parseInt(ratingElement.getAttribute('data-rating'));
    const feedback = document.getElementById(`rate-feedback-${lvl}`).value.trim();

    if (ratingValue === 0) {
        playSound('error');
        return showBanner('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹.');
    }
    
    // 1. Update Order Record
    o.rated = true;
    o.rating = ratingValue;
    o.feedback = feedback;
    
    // 2. Update Customer Record (logged-in user)
    const clientD = db[lvl].user;
    if (clientD && clientD.phone) {
        clientD.totalRatings += ratingValue;
        clientD.ratingsCount += 1;
        
        // 3. Update the permanent dummy customer list (for analytics/admin)
        let cust = db[lvl].customers.find(c => c.phone === clientD.phone);
        if (cust) {
            cust.totalRatings = clientD.totalRatings;
            cust.ratingsCount = clientD.ratingsCount;
        }
    }
    
    // Clear active state and close modal
    activeRatingOrderId = null;
    playSound('success');
    showBanner('â­ Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.');
    
    // Refresh client and admin interfaces to show the updated status/rating
    db[lvl].currentView = 'track'; // Reset view to track page
    renderLevel(lvl); // Re-render everything
}

/* --- Driver Assignment Modal Logic --- */

/**
 * NEW: Displays the modal for assigning a driver.
 * @param {number} lvl - The current level (2 or 3).
 * @param {number} oid - The ID of the order to assign.
 */
function showDriverAssignmentModal(lvl, oid) {
    const drivers = db[lvl].drivers.filter(d => !d.isEditing);
    const selectEl = document.getElementById(`driver-select-${lvl}`);
    
    document.getElementById(`assign-order-id-${lvl}`).textContent = oid;
    document.getElementById(`assign-order-target-${lvl}`).value = oid;

    if (drivers.length === 0) {
        selectEl.innerHTML = '<option value="" disabled selected>-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† --</option>';
        document.querySelector(`#modal-driver-assign-${lvl} .btn.bg-l${lvl}`).disabled = true;
        showBanner('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ†. Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØªÙ‡Ù… Ø£ÙˆÙ„Ø§Ù‹.', 'admin');
    } else {
        selectEl.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø³Ø§Ø¦Ù‚Ø§Ù‹ --</option>' + 
                            drivers.map(d => `<option value="${d.id}">${d.name} (${d.phone})</option>`).join('');
        document.querySelector(`#modal-driver-assign-${lvl} .btn.bg-l${lvl}`).disabled = false;
    }
    
    document.getElementById(`modal-driver-assign-${lvl}`).classList.add('open');
}

/**
 * NEW: Assigns the selected driver to the order and moves the status to 'deliv'.
 * @param {number} lvl - The current level (2 or 3).
 */
function assignDriver(lvl) {
    const oid = parseInt(document.getElementById(`assign-order-target-${lvl}`).value);
    const driverId = document.getElementById(`driver-select-${lvl}`).value;
    const o = db[lvl].orders.find(x => x.id === oid);

    if (!driverId || !o) {
        playSound('error');
        return showBanner('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨.', 'admin', `modal-toast-driver-assign-${lvl}`);
    }
    
    const driver = db[lvl].drivers.find(d => d.id === driverId);
    
    // Update order record
    o.driverId = driver.id;
    o.driverName = driver.name;
    o.driverPhone = driver.phone;
    o.status = 'deliv'; // Force status update

    // Send notification to client
    pushNotif(lvl, 'Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØµÙŠÙ„', `Ø·Ù„Ø¨Ùƒ #${oid} ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚! Ø§Ù„Ø·ÙŠØ§Ø±: ${driver.name}.`, 'order', {status: 'deliv'});
    
    closeModal(lvl, 'driver-assign');
    playSound('success');
    showBanner(`âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driver.name} Ù„Ù„Ø·Ù„Ø¨ #${oid}.`, 'admin');
    renderLevel(lvl);
}


/* --- Helpers --- */
// MODIFIED: Accepts type argument for general modal closure
function closeModal(lvlOrType, type = null) { 
    let modalElement;
    // Check if confirming modal first
    if (lvlOrType === 'confirm') {
        modalElement = document.getElementById(`modal-confirm`);
    } else if (lvlOrType === 'reject-order') {
        modalElement = document.getElementById('modal-reject-order');
    } else if (type) {
        // Standard modal (lvl is passed)
        modalElement = document.getElementById(`modal-${type}-${lvlOrType}`);
    } else {
        return;
    }
    
    if (modalElement) {
        playSound('click'); 
        modalElement.classList.remove('open'); 
    }
}
function toggleElem(id) { playSound('click'); document.getElementById(id).classList.toggle('hidden'); }

function toggleStore(lvl) { 
    db[lvl].storeOpen = !db[lvl].storeOpen; 
    
    if(db[lvl].storeOpen) playSound('success'); else playSound('error');

    showBanner(db[lvl].storeOpen?'âœ… Ø§Ù„Ù…ØªØ¬Ø± Ù…ÙØªÙˆØ­':'ğŸ›‘ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØ¬Ø±', 'admin'); 
    renderLevel(lvl); 
}

function toggleProduct(lvl, pid) { 
    playSound('click');
    const p = db[lvl].menu.find(x=>x.id===pid); 
    p.active = !p.active; 
    renderLevel(lvl); 
}
function toggleFav(lvl, pid) { 
    playSound('click'); 
    const d=db[lvl]; 
    const i=d.fav.indexOf(pid); 
    if(i>-1) d.fav.splice(i,1); else d.fav.push(pid); 
    renderClientApp(lvl); 
    showBanner(i>-1?'ğŸ’” Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©':'â¤ï¸ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©'); 
}
function openLogin(lvl) { playSound('pop'); document.getElementById(`modal-login-${lvl}`).classList.add('open'); }
function sendOtp(lvl) { playSound('click'); toggleElem(`otp-area-${lvl}`); showBanner('ğŸ”‘ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚: 1234', 'client', `modal-toast-login-${lvl}`); }
function verifyOtp(lvl) { 
    // Validation
    const name = document.getElementById(`login-name-${lvl}`).value;
    const phone = document.getElementById(`login-phone-${lvl}`).value;
    const addr = document.getElementById(`login-addr-${lvl}`).value;
    const modalId = `modal-toast-login-${lvl}`;

    if (!name || !phone || !addr) {
        playSound('error');
        // * Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© 1: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        showBanner('âŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)', 'client', modalId);
        return;
    }

    if(document.getElementById(`otp-code-${lvl}`).value==='1234') { 
        // Initializing user with rating stats for level 2 and 3
        // Check if customer already exists in dummyCustomers to load existing stats
        let existingCust = db[lvl].customers.find(c => c.phone === phone);
        
        db[lvl].user={
            name: name, 
            phone: phone,
            totalRatings: existingCust?.totalRatings || 0,
            ratingsCount: existingCust?.ratingsCount || 0
        }; 
        // Add address to list if unique
        if (!db[lvl].addresses.includes(addr)) {
            db[lvl].addresses.push(addr);
        }

        playSound('success');
        closeModal(lvl,'login'); renderClientApp(lvl); showBanner('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } else {
        playSound('error');
        // * Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© 1: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        showBanner('âŒ Ø±Ù…Ø² Ø®Ø§Ø·Ø¦! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'client', modalId);
    }
}
function logout(lvl) { 
    playSound('click'); 
    // Reset user to anonymous state but keep rating stats if they exist
    db[lvl].user={
        name: 'Ø²Ø§Ø¦Ø±', 
        phone: null,
        totalRatings: db[lvl].user?.totalRatings || 0,
        ratingsCount: db[lvl].user?.ratingsCount || 0
    };
    nav(lvl,'home'); 
    showBanner('ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); 
}
function openAddressModal(lvl) { playSound('pop'); document.getElementById(`modal-address-${lvl}`).classList.add('open'); }
function saveAddress(lvl) { const v = document.getElementById(`new-addr-${lvl}`).value; if(v){db[lvl].addresses.push(v); closeModal(lvl, 'address'); renderClientApp(lvl); showBanner('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸'); playSound('success');} else showBanner('Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); }
function sendPromo(lvl) { const t=document.getElementById('promo-title-3').value; const tp=document.getElementById('promo-type-3').value; const v=parseFloat(document.getElementById('promo-val-3').value); if(t&&v){db[lvl].promo=t; pushNotif(lvl,'Ø¹Ø±Ø¶ Ø®Ø§Øµ âœ¨', t, 'promo', {type:tp, val:v}); renderClientApp(lvl); showBanner('âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'admin'); playSound('notify');} }
function redeemPoints(oid) { const o = l3Offers.find(x=>x.id===oid); if(!o)return; if(db[3].points>=o.pts){db[3].points-=o.pts; if(o.type==='discount') db[3].cart.push({name:o.title, weightLabel:'Ù…ÙƒØ§ÙØ£Ø©', finalPrice:-o.val, isReward:true}); else {const p=db[3].menu.find(x=>x.id===o.val);if(p)db[3].cart.push({...p, weight:1, weightLabel:'Ù‡Ø¯ÙŠØ©', finalPrice:0, isReward:true});} renderClientApp(3); showBanner('ğŸ Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©'); playSound('success');} else {showBanner('âŒ Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø§ ØªÙƒÙÙŠ'); playSound('error');} }

// FIX: Added UI refresh for notification screen
function pushNotif(lvl, t, b, type='order', data=null) { 
    db[lvl].notif.unshift({
        title: t, 
        body: b, 
        time: new Date().toLocaleTimeString('ar-EG'), 
        type: type,
        data: data 
    }); 
    updateCounts(lvl); 
    playSound('notify'); 
    if(db[lvl].currentView === 'notif') renderClientApp(lvl);
}
function applyDiscount(lvl, idx) { 
    const n = db[lvl].notif[idx]; 
    if(n && n.type === 'promo' && n.data){
        db[lvl].activeDiscount = n.data; // n.data contains {type, val}
        showBanner('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶'); 
        playSound('success'); 
        nav(lvl, 'home');
    } 
}
function showInvoice(lvl, oid) {
    playSound('pop');
    try {
        const o = db[lvl].orders.find(x => x.id == oid);
        if (!o) return;
        const schedInfo = o.sched ? `<div class="mb-2"><strong>â° ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©:</strong> ${o.sched.replace('T', ' ')}</div>` : '';
        
        let giftInfo = '';
        if (o.gift) {
            giftInfo = `
            <div style="margin: 20px 0; padding: 15px; background: #FFF7ED; border: 2px dashed #F97316; border-radius: 12px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ</div>
                <div style="font-weight: 800; color: #9A3412; margin-bottom: 5px;">Ù‡Ø¯ÙŠØ© Ø®Ø§ØµØ©</div>
                <div style="font-style: italic; color: #555;">"${o.gift}"</div>
            </div>`;
        }

        const noteInfo = o.note ? `<div class="mb-2"><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${o.note}</div>` : '';
        
        // --- NEW: Detailed Totals Section ---
        // * MODIFIED: subTotal now reflects total of basePrice + addonsTotal (before discount)
        const totalBaseAndAddons = o.items.reduce((sum, i) => sum + i.basePrice + (i.addonsTotal || 0), 0);
        const subTotal = totalBaseAndAddons; 

        let discountDetailsHTML = '';
        
        if (o.discountVal > 0) {
            let discountLabel = 'Ø®ØµÙ… Ø®Ø§Øµ';
            if (o.discountType === 'percent') {
                discountLabel = `Ø®ØµÙ… (${o.discountRate}%)`;
            } else if (o.discountType === 'fixed') {
                discountLabel = `Ø®ØµÙ… (Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª)`;
            }
            discountDetailsHTML = `<div class="flex-between mb-1 text-success small"><strong>${discountLabel}:</strong> <span>-${o.discountVal} Ø¬.Ù…</span></div>`;
        }
        
        // Rating and Driver Info
        const adminRatingInfo = o.rated ? `
            <hr style="border:1px dashed #ccc;margin:10px 0">
            <div class="mb-1 small"><strong>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span style="color:var(--accent); font-weight:700;">${o.rating} â­</span></div>
            ${o.feedback ? `<div class="mb-2 small"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${o.feedback}</div>` : ''}
        ` : '';

        const adminDriverInfo = o.driverName ? `
            <div class="mb-1 small"><strong>Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> <span style="color:var(--l${lvl}); font-weight:700;">${o.driverName}</span></div>
            <div class="mb-2 small"><strong>Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> <span>${o.driverPhone}</span></div>
        ` : '';

        // * MODIFIED: Items display to include addons
        const itemsListHTML = o.items.map(i => {
            // Main Product Line (shows BASE price)
            let itemHtml = `<div class="flex-between mb-1" style="font-weight:700;">
                <span>${i.name} (${i.weightLabel})</span>
                <span>${i.basePrice} Ø¬.Ù…</span>
            </div>`;
            
            // Add Addons as sub-items
            if (i.addons && i.addons.length > 0) {
                // Display each addon separately
                i.addons.forEach(a => {
                    itemHtml += `<div class="flex-between small" style="margin-right: 15px; color:var(--muted)">
                        <span>+ ${a.name}</span>
                        <span class="bold">+${a.price} Ø¬.Ù…</span>
                    </div>`;
                });
                // Display subtotal of addons (optional, but good for clarity)
                itemHtml += `<div class="flex-between small" style="margin-right: 15px; color:var(--text); font-style: italic;">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª:</span>
                    <span class="bold">${i.addonsTotal} Ø¬.Ù…</span>
                </div>`;
            }
            return itemHtml;
        }).join('<hr style="border:1px dashed #ccc; margin:5px 0">'); // Separator between main items

        // FIX: The element ID for invoice content in L2/L3 is passed as ${lvl}
        const invoiceContentElement = document.getElementById(`invoice-content-${lvl}`);
        if (!invoiceContentElement) return; // Safety check

        invoiceContentElement.innerHTML = `
            <div style="text-align:center;margin-bottom:15px;border-bottom:2px solid #eee;padding-bottom:10px">
                <h3>ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©</h3>
                <div class="small muted">${new Date().toLocaleDateString('ar-EG')}</div>
            </div>
            <div class="flex-between mb-1"><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> <span>#${o.id}</span></div>
            <div class="flex-between mb-2"><strong>ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨:</strong> <span>${o.time}</span></div>
            <div class="mb-1"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${o.client}</div>
            <div class="mb-1"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${o.phone || '-'}</div>
            <div class="mb-2"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${o.addr}</div>
            ${schedInfo} ${noteInfo}
            
            ${giftInfo}

            <hr style="border:1px dashed #ccc;margin:10px 0">
            <div style="margin-bottom:10px">
                ${itemsListHTML}
            </div>
            <hr style="border:1px dashed #ccc;margin:10px 0">
            
            <!-- TOTALS -->
            <div class="flex-between mb-1"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…)</span><span>${subTotal} Ø¬.Ù…</span></div>
            ${discountDetailsHTML}
            <div class="flex-between bold" style="font-size:1.1rem;background:#f8fafc;padding:10px;border-radius:8px"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span>${o.total} Ø¬.Ù…</span></div>
            
            ${adminRatingInfo}
            ${adminDriverInfo} <!-- NEW: Admin Driver Info -->

            <!-- NEW: Dynamic Print Buttons -->
            <button class="btn btn-block bg-l${lvl===1?'1':lvl===2?'2':'3'} mt-2" onclick="printReceipt(${lvl}, ${o.id})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            <button class="btn btn-block btn-outline mt-2" onclick="closeModal(${lvl}, 'invoice')">Ø¥ØºÙ„Ø§Ù‚</button>
        `;
        document.getElementById(`modal-invoice-${lvl}`).classList.add('open');
    } catch (e) { console.error(e); }
}

function printReceipt(lvl, oid) {
    const o = db[lvl].orders.find(x => x.id === oid);
    if (!o) return;
    
    // Prepare optional sections
    const schedInfo = o.sched ? `<div class="row"><strong>ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©:</strong> ${o.sched.replace('T', ' ')}</div>` : '';
    const noteInfo = o.note ? `<div class="row"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${o.note}</div>` : '';
    
    // Calculate Totals for Print
    // * MODIFIED: subTotal now reflects total of basePrice + addonsTotal (before discount)
    const totalBaseAndAddons = o.items.reduce((sum, i) => sum + i.basePrice + (i.addonsTotal || 0), 0);
    const subTotal = totalBaseAndAddons;
    
    let discountInfo = '';
    
    if (o.discountVal > 0) {
        let discountLabel = 'Ø®ØµÙ… Ø®Ø§Øµ';
        if (o.discountType === 'percent') {
            discountLabel = `Ø®ØµÙ… (${o.discountRate}%)`;
        } else if (o.discountType === 'fixed') {
            discountLabel = `Ø®ØµÙ… (Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª)`;
        }
        discountInfo = `<div class="item"><strong>${discountLabel}:</strong> <span>-${o.discountVal} Ø¬.Ù…</span></div>`;
    }
    
    let giftInfo = '';
    if (o.gift) {
        giftInfo = `
        <div style="border: 1px dashed #000; padding: 10px; margin: 10px 0; text-align: center;">
            <strong>ğŸ Ù‡Ø¯ÙŠØ©:</strong> "${o.gift}"
        </div>`;
    }
    
    // NEW: Rating Info for Print Receipt
    const printRatingInfo = o.rated ? `
        <div class="line"></div>
        <div class="row bold">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${o.rating} â­</div>
        ${o.feedback ? `<div class="row small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.feedback}</div>` : ''}
    ` : '';
    
    // NEW: Driver Info for Print Receipt
    const printDriverInfo = o.driverName ? `
        <div class="line"></div>
        <div class="row bold">Ø§Ù„Ø³Ø§Ø¦Ù‚: ${o.driverName}</div>
        <div class="row small">Ù‡Ø§ØªÙ: ${o.driverPhone}</div>
    ` : '';

    // * MODIFIED: Print Items list to include addons and BASE price
    const printItemsList = o.items.map(i => {
        // Main Product Line (shows BASE price)
        let itemHtml = `<div class="item"><span>${i.name} <small>(${i.weightLabel})</small></span> <span>${i.basePrice} Ø¬.Ù…</span></div>`;
        
        // Add Addons as sub-items
        if (i.addons && i.addons.length > 0) {
            i.addons.forEach(a => {
                itemHtml += `<div class="item small" style="margin-right: 10px; color:#555"><span>+ ${a.name}</span> <span class="bold">+${a.price} Ø¬.Ù…</span></div>`;
            });
             // Display subtotal of addons
            itemHtml += `<div class="item small" style="margin-right: 10px; color:#000; font-weight: bold;"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª:</span> <span>${i.addonsTotal} Ø¬.Ù…</span></div>`;
        }
        itemHtml += `<div class="line"></div>`; // Separator after each item group
        return itemHtml;
    }).join(''); 

    const w = window.open('', '_blank');
    w.document.write(`
        <html>
        <head>
            <title>Receipt #${o.id}</title>
            <style>
                body { font-family: 'Courier New', monospace; padding: 20px; direction: rtl; max-width: 300px; margin: 0 auto; }
                .center { text-align: center; }
                .bold { font-weight: bold; }
                .line { border-bottom: 1px dashed #000; margin: 10px 0; }
                .item { display: flex; justify-content: space-between; margin-bottom: 5px; }
                .row { margin-bottom: 5px; }
                .small { font-size: 0.9rem; }
                @media print {
                    body { margin: 0; padding: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="center bold" style="font-size: 1.2rem;">Ø­Ù„ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©</div>
            <div class="center small">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©</div>
            <div class="center small">${new Date().toLocaleDateString('ar-EG')}</div>
            <div class="line"></div>
            
            <div class="item"><span>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span> <span>#${o.id}</span></div>
            <div class="item"><span>ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨:</span> <span>${o.time}</span></div>
            <div class="line"></div>
            
            <div class="row"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${o.client}</div>
            <div class="row"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${o.phone || '-'}</div>
            <div class="row"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${o.addr || '-'}</div>
            ${schedInfo}
            ${noteInfo}
            
            ${giftInfo}

            <div class="line"></div>
            <div class="bold" style="margin-bottom: 5px;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</div>
            ${printItemsList}
            
            <!-- NEW TOTALS STRUCTURE -->
            <div class="item bold"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ:</span> <span>${subTotal} Ø¬.Ù…</span></div>
            ${discountInfo}
            
            <div class="item bold" style="font-size: 1.1rem; margin-top: 5px; border-top: 1px solid #000; padding-top: 5px;">
                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                <span>${o.total} Ø¬.Ù…</span>
            </div>
            
            ${printRatingInfo} <!-- NEW: Print Rating Info -->
            ${printDriverInfo} <!-- NEW: Print Driver Info -->

            <div class="line"></div>
            <div class="center">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…!</div>
            
            <script>window.print();<\/script>
        </body>
        </html>
    `);
    w.document.close();
}

/**
 * ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ (Re-order)
 * ØªÙ‚ÙˆÙ… Ø¨Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ù† Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
 * @param {number} lvl - Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (1, 2, 3).
 * @param {number} oid - Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„Ø·Ù„Ø¨ (Order ID).
 */
function reOrder(lvl, oid) {
    playSound('click');
    const o = db[lvl].orders.find(x => x.id === oid);
    if(!o) {
        showBanner('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨');
        return;
    }
    
    if(!db[lvl].storeOpen) { 
        playSound('error'); 
        return showBanner('ğŸ›‘ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨'); 
    }

    // Clone items to avoid reference issues and add them to the cart
    o.items.forEach(item => {
        // We clone the item as is, including weight, addons, and finalPrice.
        db[lvl].cart.push({...item});
    });

    updateCounts(lvl);
    playSound('success');
    showBanner('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„Ù„Ø³Ù„Ø© ğŸ›’');
    // Navigate to the cart view immediately
    nav(lvl, 'cart');
}

init();
</script>
</body>
</html>
